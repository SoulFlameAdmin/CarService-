<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SoulFlame CarService ‚Äî Map (User)</title>

  <!-- (–ø–æ–º–∞–≥–∞, –Ω–æ –≥–ª–∞–≤–Ω–æ—Ç–æ –µ vercel.json) -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
    #map { height:100%; width:100%; }

    #menu-button{
      position:absolute; top:15px; left:15px; z-index:1000;
      background:#111827; color:#fff; border:none;
      padding:10px 15px; font-size:20px; cursor:pointer; border-radius:10px;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
    }

    #panel-container{
      position:absolute; top:60px; left:15px; width:min(380px, 92vw);
      max-height: 72vh; overflow:hidden;
      z-index:999; border-radius:14px;
      background: rgba(255,255,255,.94);
      backdrop-filter: blur(10px);
      border:1px solid rgba(17,24,39,.10);
      box-shadow:0 0 10px rgba(0,0,0,.2);
    }
    #panel-inner{ padding:12px; display:flex; flex-direction:column; gap:10px; }

    .panel-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .panel-title{ font-weight:900; letter-spacing:.4px; color:#111827; font-size:14px; }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(17,24,39,.12);
      background:#fff; color:#111827;
      font-weight:900;
      display:flex; gap:8px; align-items:center;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background:#10b981;
      box-shadow:0 0 0 4px rgba(16,185,129,.18);
    }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      border:none; cursor:pointer; border-radius:12px;
      padding:10px 12px; font-weight:900; font-size:12px; letter-spacing:.6px;
      background:#111827; color:#fff;
    }
    .btn.secondary{
      background:#fff; color:#111827;
      border:1px solid rgba(17,24,39,.14);
    }

    .results{
      overflow:auto;
      max-height: calc(72vh - 230px);
      padding-right:4px;
    }

    .item{
      border:1px solid rgba(17,24,39,.10);
      background:#fff; border-radius:14px; padding:10px; margin-bottom:10px;
      display:flex; gap:10px; align-items:flex-start;
      cursor:pointer;
    }

    .badge{
      min-width:54px;
      width:54px;
      height:54px;
      border-radius:16px;
      background: rgba(17,24,39,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 54px;
      border:1px solid rgba(17,24,39,.10);
      font-weight:900;
      color:#111827;
    }

    .meta{ flex:1; min-width:0; }
    .name{
      font-weight:900; font-size:13px; color:#111827;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      display:flex; align-items:center; gap:8px;
    }
    .tagOnline{
      font-size:10px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(16,185,129,.25);
      background: rgba(16,185,129,.10);
      color:#065f46;
      font-weight:900;
      letter-spacing:.5px;
    }
    .addr{ font-size:12px; color:rgba(17,24,39,.72); margin-top:3px; }
    .row2{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;
      font-size:12px; color:rgba(17,24,39,.75);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    #status{
      position:absolute; right:12px; top:12px; z-index:1000;
      background:rgba(17,24,39,.88); color:#fff;
      padding:8px 10px; border-radius:10px; font-size:12px;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
      max-width:min(520px, 92vw);
    }

    .marker-label {
      background: rgba(255,255,255,0.92);
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.12);
      white-space: nowrap;
    }

    /* ===== Right Slide Panel (User View) ===== */
    #rightPanel{
      position:fixed;
      top:0;
      right:0;
      height:100%;
      width:min(420px, 92vw);
      background: rgba(255,255,255,.96);
      border-left:1px solid rgba(17,24,39,.12);
      box-shadow: -18px 0 40px rgba(0,0,0,.12);
      z-index:1200;
      transform: translateX(105%);
      transition: transform .25s ease;
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
    }
    #rightPanel.show{ transform: translateX(0); }

    #rpHead{
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(17,24,39,.10);
    }
    #rpTitle{
      font-weight:900;
      font-size:14px;
      color:#111827;
      line-height:1.2;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
    }
    #rpSub{
      display:block;
      font-size:12px;
      opacity:.78;
      font-weight:800;
      margin-top:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }
    #rpClose{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      background:#111827;
      color:#fff;
      flex:0 0 auto;
    }
    #rpBody{
      padding:12px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      border:1px solid rgba(17,24,39,.10);
      background:#fff;
      border-radius:14px;
      padding:12px;
    }
    .card h4{
      margin:0 0 10px 0;
      font-size:12px;
      letter-spacing:.6px;
      text-transform:uppercase;
      color:rgba(17,24,39,.82);
    }
    .rpBtns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .rpBtn{
      border:none; cursor:pointer; border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      font-size:12px;
      background:#111827;
      color:#fff;
    }
    .rpBtn.secondary{
      background:#fff; color:#111827;
      border:1px solid rgba(17,24,39,.14);
    }

    /* Chat */
    #chatList{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .msg{
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(17,24,39,.10);
      background: rgba(17,24,39,.03);
      font-size:12px;
      line-height:1.45;
    }
    .msg b{ display:block; font-size:11px; opacity:.75; margin-bottom:4px; }
    textarea{
      width:100%;
      border:1px solid rgba(17,24,39,.14);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-weight:700;
      font-size:13px;
      background:#fff;
      color:#111827;
      min-height:80px;
      resize:vertical;
    }
  </style>
</head>

<body>
  <button id="menu-button">‚ò∞</button>

  <div id="panel-container">
    <div id="panel-inner">
      <div class="panel-head">
        <div class="panel-title">–°–µ—Ä–≤–∏–∑–∏ –æ–∫–æ–ª–æ —Ç–µ–±</div>
        <div class="pill" id="countPill"><span class="dot"></span><span id="countText">0</span></div>
      </div>

      <div class="controls">
        <button class="btn" id="btnReload">–û–±–Ω–æ–≤–∏</button>
        <button class="btn secondary" id="btnMyLoc">–ú–æ–µ—Ç–æ –º—è—Å—Ç–æ</button>
        <button class="btn secondary" id="btnToggleActive">–ü–æ–∫–∞–∂–∏ –∞–∫—Ç–∏–≤–Ω–∏</button>
      </div>

      <div class="results" id="results"></div>
    </div>
  </div>

  <div id="map"></div>
  <div id="status">–ó–∞—Ä–µ–∂–¥–∞–º‚Ä¶</div>

  <!-- Right panel -->
  <aside id="rightPanel">
    <div id="rpHead">
      <div style="min-width:0;flex:1">
        <div id="rpTitle">‚Äî</div>
        <small id="rpSub">‚Äî</small>
      </div>
      <button id="rpClose">–ó–∞—Ç–≤–æ—Ä–∏</button>
    </div>

    <div id="rpBody">
      <div class="card">
        <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
        <div id="baseInfo" style="font-size:12px;line-height:1.55;color:rgba(17,24,39,.82)"></div>
        <div class="rpBtns">
          <button class="rpBtn secondary" id="btnOpenGoogle">–û—Ç–≤–æ—Ä–∏ –≤ Google</button>
          <button class="rpBtn" id="btnCenter">–¶–µ–Ω—Ç—Ä–∏—Ä–∞–π</button>
        </div>
      </div>

      <div class="card">
        <h4>–ü—Ä–æ—Ñ–∏–ª (–ª–æ–∫–∞–ª–Ω–æ)</h4>
        <div id="profileInfo" style="font-size:12px;line-height:1.6;color:rgba(17,24,39,.82);opacity:.95"></div>
        <div style="margin-top:10px;font-size:11px;opacity:.75">
          *–¢–æ–≤–∞ –∏–¥–≤–∞ –æ—Ç localStorage (–æ—Ç Business map). –ü–æ—Å–ª–µ –≥–æ –≤—Ä—ä–∑–≤–∞–º–µ –∫—ä–º Firestore.
        </div>
      </div>

      <div class="card">
        <h4>–ß–∞—Ç (–ª–æ–∫–∞–ª–Ω–æ)</h4>
        <textarea id="chatText" placeholder="–ù–∞–ø–∏—à–∏ —Å—ä–æ–±—â–µ–Ω–∏–µ –∫—ä–º —Å–µ—Ä–≤–∏–∑–∞..."></textarea>
        <div class="rpBtns">
          <button class="rpBtn" id="btnSendChat">–ò–∑–ø—Ä–∞—Ç–∏</button>
          <button class="rpBtn secondary" id="btnClearChat">–ò–∑—á–∏—Å—Ç–∏ —á–∞—Ç</button>
        </div>
        <div id="chatList"></div>
      </div>
    </div>
  </aside>

  <script>
    "use strict";

    // ====== CONFIG ======
    const DATA_URL = "/QR_serveses/sliven_avtoservizi.txt";
    const AUTO_REFRESH_MS = 30 * 60 * 1000;

    // Active services (–æ—Ç Business Access)
    const ACTIVE_KEY = "sf_cs_activated_services";
    let onlyActive = false;

    function safeJson(s){ try{ return JSON.parse(s); }catch(_){ return null; } }
    function normalizeCode(s){
      return (s || "")
        .trim()
        .toUpperCase()
        .replace(/\\s+/g,"-")
        .replace(/[^A-Z0-9\\-]/g,"");
    }

    let activeMetaByCode = new Map();
    function loadActiveMeta(){
      activeMetaByCode.clear();
      const arr = safeJson(localStorage.getItem(ACTIVE_KEY)) || [];
      arr.forEach((a, idx) => {
        const code = normalizeCode(a?.code || "");
        if(!code) return;
        activeMetaByCode.set(code, { ...a, _order: idx + 1 });
      });
    }

    // ====== UI ======
    const panel = document.getElementById("panel-container");
    const resultsEl = document.getElementById("results");
    const statusEl = document.getElementById("status");
    const countPill = document.getElementById("countPill");
    const countText = document.getElementById("countText");

    const btnReload = document.getElementById("btnReload");
    const btnMyLoc = document.getElementById("btnMyLoc");
    const btnToggleActive = document.getElementById("btnToggleActive");

    document.getElementById("menu-button").addEventListener("click", () => {
      panel.style.display = (panel.style.display === "none") ? "block" : "none";
    });

    function setStatus(t){ statusEl.textContent = t; }

    // ====== MAP ======
    let map, info;
    let markersByCode = new Map();
    let markers = [];
    let lastData = [];

    const SLIVEN_CENTER = { lat: 42.6852, lng: 26.3293 };

    // user location
    const USER_LOC_KEY = "sf_cs_user_loc";
    let userLoc = null;
    let userMarker = null;

    function initMap(){
      loadActiveMeta();

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: SLIVEN_CENTER,
        mapTypeControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
          position: google.maps.ControlPosition.TOP_RIGHT
        }
      });

      info = new google.maps.InfoWindow();

      wireRightPanel();

      // 1) —Ü–µ–Ω—Ç—Ä–∏—Ä–∞–π –ø–æ user (–≥—Ä–∞–¥/–æ–±–ª–∞—Å—Ç = —Ä–µ–∞–ª–Ω–∏—è GPS —Ä–∞–π–æ–Ω)
      centerToUserArea(true).finally(() => {
        // 2) –ø–æ—Å–ª–µ –∑–∞—Ä–µ–∂–¥–∞–º–µ –¥–∞–Ω–Ω–∏—Ç–µ
        loadAndRender(true);
        setInterval(() => loadAndRender(false), AUTO_REFRESH_MS);
      });

      btnReload.addEventListener("click", () => loadAndRender(false));
      btnMyLoc.addEventListener("click", () => centerToUserArea(false));

      btnToggleActive.addEventListener("click", () => {
        onlyActive = !onlyActive;
        btnToggleActive.textContent = onlyActive ? "–ü–æ–∫–∞–∂–∏ –≤—Å–∏—á–∫–∏" : "–ü–æ–∫–∞–∂–∏ –∞–∫—Ç–∏–≤–Ω–∏";
        applyView(lastData);
      });

      // –∞–∫–æ –≤ –¥—Ä—É–≥ —Ç–∞–± —Å—Ç–∞–Ω–µ new activation -> refresh
      window.addEventListener("storage", (e) => {
        if(e.key === ACTIVE_KEY){
          loadActiveMeta();
          applyView(lastData);
        }
      });
    }
    window.initMap = initMap;

    async function centerToUserArea(firstTime){
      // –∞–∫–æ –∏–º–∞–º–µ –ø–æ—Å–ª–µ–¥–Ω–æ –∑–∞–ø–∞–∑–µ–Ω–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ - —Ü–µ–Ω—Ç—Ä–∏—Ä–∞–º–µ –±—ä—Ä–∑–æ
      const cached = safeJson(localStorage.getItem(USER_LOC_KEY));
      if(cached?.lat && cached?.lng && firstTime){
        userLoc = { lat: Number(cached.lat), lng: Number(cached.lng) };
        placeUserMarker(userLoc);
        map.setCenter(userLoc);
        map.setZoom(12);
        setStatus("OK: –ø–æ—Å–ª–µ–¥–Ω–æ –º—è—Å—Ç–æ (–∑–∞–ø–∞–∑–µ–Ω–æ).");
      }

      if(!navigator.geolocation){
        setStatus("GPS –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞. –¶–µ–Ω—Ç—ä—Ä: –°–ª–∏–≤–µ–Ω.");
        return;
      }

      setStatus("–ò—Å–∫–∞–º GPS‚Ä¶ (—Ä–∞–∑—Ä–µ—à–∏ Location)");
      return new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            try{ localStorage.setItem(USER_LOC_KEY, JSON.stringify(userLoc)); }catch(_){}
            placeUserMarker(userLoc);
            map.setCenter(userLoc);
            map.setZoom(12);
            setStatus("OK: —Ü–µ–Ω—Ç—Ä–∏—Ä–∞—Ö –ø–æ —Ç–≤–æ—è —Ä–∞–π–æ–Ω.");
            resolve();
          },
          (err) => {
            // fallback
            setStatus("–ë–µ–∑ GPS ‚Üí —Ü–µ–Ω—Ç—ä—Ä: –°–ª–∏–≤–µ–Ω. (" + (err?.message || "deny") + ")");
            map.setCenter(SLIVEN_CENTER);
            map.setZoom(12);
            resolve();
          },
          { enableHighAccuracy: false, timeout: 8000, maximumAge: 60_000 }
        );
      });
    }

    function placeUserMarker(loc){
      if(!loc) return;
      if(userMarker) userMarker.setMap(null);
      userMarker = new google.maps.Marker({
        position: loc,
        map,
        title: "–¢–∏ —Å–∏ —Ç—É–∫",
        label: { text: "ME", fontSize:"11px", fontWeight:"900", color:"#111", className:"marker-label" }
      });
    }

    // ====== TXT LOADING ======
    async function fetchTxt(url){
      // cache-bust: –Ω–∏–∫–æ–≥–∞ —Å—Ç–∞—Ä TXT –Ω–∞ Vercel
      const res = await fetch(url + "?v=" + Date.now(), { cache: "no-store" });
      if(!res.ok) throw new Error("–ù–µ –º–æ–≥–∞ –¥–∞ –∑–∞—Ä–µ–¥—è TXT ("+res.status+"). –ü—Ä–æ–≤–µ—Ä–∏ –¥–∞–ª–∏ –µ –≤ /public/QR_serveses/.");
      return await res.text();
    }

    function parseTxt(txt){
      const lines = String(txt || "")
        .split(/\\r?\\n/)
        .map(l => l.trim())
        .filter(l => l && !l.startsWith("#"));

      const out = [];
      for(const line of lines){
        const parts = line.split("|").map(p => p.trim());
        if(parts.length < 5) continue;

        const code = normalizeCode(parts[0]);
        const name = parts[1] || "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑";
        const addr = parts[2] || "";
        const lat = Number(String(parts[3]).replace(",", "."));
        const lng = Number(String(parts[4]).replace(",", "."));
        const source = parts.slice(5).join(" | ").trim();

        if(!code || !Number.isFinite(lat) || !Number.isFinite(lng)) continue;
        out.push({ code, name, addr, lat, lng, source, raw: line });
      }
      return out;
    }

    // ====== RENDER ======
    function clearMarkers(){
      for(const m of markers) m.setMap(null);
      markers = [];
      markersByCode.clear();
    }

    function fitAll(){
      const pins = markers.slice();
      if(userMarker) pins.push(userMarker);

      if(!pins.length){
        map.setCenter(SLIVEN_CENTER);
        map.setZoom(12);
        return;
      }
      const bounds = new google.maps.LatLngBounds();
      pins.forEach(m => bounds.extend(m.getPosition()));
      map.fitBounds(bounds, 70);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>\"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\\\"":"&quot;","'":"&#039;"
      }[m] || m));
    }

    function markerHtml(row){
      const mapsLink = `https://www.google.com/maps/search/?api=1&query=${row.lat},${row.lng}`;
      const meta = activeMetaByCode.get(normalizeCode(row.code||""));
      const online = meta ? "ONLINE ‚úÖ" : "OFFLINE";

      return `
        <div style="font-family:Arial;max-width:290px">
          <div style="font-weight:900;font-size:14px;margin-bottom:6px">${escapeHtml(row.name)}</div>
          <div style="font-size:12px;color:rgba(17,24,39,.75);margin-bottom:8px">
            ${row.addr ? `<b>–ê–¥—Ä–µ—Å:</b> ${escapeHtml(row.addr)}<br/>` : ""}
            <b>GPS:</b> ${row.lat.toFixed(6)}, ${row.lng.toFixed(6)}<br/>
            <b>–°—Ç–∞—Ç—É—Å:</b> ${online}
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
            <a href="${mapsLink}" target="_blank" rel="noopener"
              style="font-weight:900;text-decoration:none;color:#0b62ff">–û—Ç–≤–æ—Ä–∏ –≤ Google</a>
          </div>
        </div>
      `;
    }

    function renderList(rows){
      resultsEl.innerHTML = "";
      countText.textContent = String(rows.length);

      if(!rows.length){
        resultsEl.innerHTML = `<div style="padding:10px;font-size:12px;opacity:.75">
          –ù—è–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –∑–∞ —Ç–µ–∫—É—â–∏—è –∏–∑–≥–ª–µ–¥.
        </div>`;
        return;
      }

      rows.forEach((r) => {
        const codeKey = normalizeCode(r.code||"");
        const meta = activeMetaByCode.get(codeKey);
        const onlineTag = meta ? `<span class="tagOnline">ONLINE</span>` : "";

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="badge">${meta ? "‚úÖ" : "‚Ä¢"}</div>
          <div class="meta">
            <div class="name" title="${escapeHtml(r.name)}">${escapeHtml(r.name)} ${onlineTag}</div>
            <div class="addr">
              ${r.addr ? escapeHtml(r.addr) + " ‚Ä¢ " : ""}
              ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}
            </div>
            <div class="row2">–ö–æ–¥: ${escapeHtml(r.code)}</div>
          </div>
        `;
        el.addEventListener("click", () => focusRow(r.code, true));
        resultsEl.appendChild(el);
      });
    }

    function renderPins(rows){
      clearMarkers();

      rows.forEach((r, idx) => {
        const meta = activeMetaByCode.get(normalizeCode(r.code||""));
        const labelText = meta ? String(idx + 1) : "‚Ä¢";

        const mk = new google.maps.Marker({
          position: { lat: r.lat, lng: r.lng },
          map,
          title: r.name,
          label: {
            text: String(labelText),
            fontSize: "11px",
            fontWeight: "800",
            color: "#111",
            className: "marker-label"
          }
        });

        mk.addListener("click", () => {
          info.setContent(markerHtml(r));
          info.open({ map, anchor: mk });
          openRightPanel(r);
        });

        markers.push(mk);
        markersByCode.set(normalizeCode(r.code||""), { row: r, marker: mk });
      });
    }

    function focusRow(code, openPanel){
      const key = normalizeCode(code||"");
      const hit = markersByCode.get(key);
      if(!hit){
        setStatus("–ù—è–º–∞ —Ç–∞–∫—ä–≤ –∑–∞–ø–∏—Å –≤ —Ç–µ–∫—É—â–∏—è –∏–∑–≥–ª–µ–¥.");
        return;
      }
      const { row, marker } = hit;
      map.panTo({ lat: row.lat, lng: row.lng });
      map.setZoom(16);
      google.maps.event.trigger(marker, "click");
      setStatus("OK: " + row.name);
      if(openPanel) openRightPanel(row);
    }

    function applyView(allRows){
      lastData = allRows;

      // filter: onlyActive
      const rows = onlyActive
        ? allRows.filter(r => activeMetaByCode.has(normalizeCode(r.code||"")))
        : allRows;

      renderPins(rows);
      renderList(rows);

      setStatus(`OK: ${rows.length} —Å–µ—Ä–≤–∏–∑–∞.`);

      // –ø—Ä–∏ –ø—ä—Ä–≤–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ ‚Äì –∞–∫–æ –∏–º–∞–º–µ userLoc, –Ω–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–∞–π –∫—ä–º –°–ª–∏–≤–µ–Ω, –∞ –∫—ä–º —Ä–∞–π–æ–Ω–∞
      fitAll();
    }

    async function loadAndRender(first){
      try{
        setStatus(first ? "–ó–∞—Ä–µ–∂–¥–∞–º TXT‚Ä¶" : "–û–±–Ω–æ–≤—è–≤–∞–º‚Ä¶");
        const txt = await fetchTxt(DATA_URL);
        const rows = parseTxt(txt);

        loadActiveMeta();
        applyView(rows);

      }catch(err){
        console.error(err);
        setStatus("–ì—Ä–µ—à–∫–∞: " + (err?.message || err));
      }
    }

    // ===== Right Panel (USER) =====
    const rp = document.getElementById("rightPanel");
    const rpClose = document.getElementById("rpClose");
    const rpTitle = document.getElementById("rpTitle");
    const rpSub = document.getElementById("rpSub");
    const baseInfo = document.getElementById("baseInfo");
    const profileInfo = document.getElementById("profileInfo");
    const btnOpenGoogle = document.getElementById("btnOpenGoogle");
    const btnCenter = document.getElementById("btnCenter");

    const chatText = document.getElementById("chatText");
    const btnSendChat = document.getElementById("btnSendChat");
    const btnClearChat = document.getElementById("btnClearChat");
    const chatList = document.getElementById("chatList");

    let currentRow = null;

    function wireRightPanel(){
      rpClose.addEventListener("click", () => rp.classList.remove("show"));
      btnCenter.addEventListener("click", () => {
        if(!currentRow) return;
        map.panTo({lat: currentRow.lat, lng: currentRow.lng});
        map.setZoom(16);
      });
      btnOpenGoogle.addEventListener("click", () => {
        if(!currentRow) return;
        const url = `https://www.google.com/maps/search/?api=1&query=${currentRow.lat},${currentRow.lng}`;
        window.open(url, "_blank", "noopener");
      });

      btnSendChat.addEventListener("click", () => {
        if(!currentRow) return;
        const t = chatText.value.trim();
        if(!t) return;
        pushChat(currentRow.code, { from:"USER", text:t, ts:new Date().toISOString() });
        chatText.value = "";
        renderChat(currentRow.code);
      });

      btnClearChat.addEventListener("click", () => {
        if(!currentRow) return;
        clearChat(currentRow.code);
        renderChat(currentRow.code);
      });

      window.addEventListener("storage", (e) => {
        if(!currentRow) return;
        if(e.key && (e.key === "sf_cs_biz_profiles" || e.key.startsWith("sf_cs_chat_"))){
          loadProfileIntoUI(currentRow.code);
          renderChat(currentRow.code);
        }
      });
    }

    function openRightPanel(row){
      currentRow = row;

      const meta = activeMetaByCode.get(normalizeCode(row.code||""));
      const status = meta ? "ONLINE ‚úÖ" : "OFFLINE";

      rpTitle.textContent = row.name || "‚Äî";
      rpSub.textContent = status;

      baseInfo.innerHTML =
        `<b>–ò–º–µ:</b> ${escapeHtml(row.name)}<br>` +
        (row.addr ? `<b>–ê–¥—Ä–µ—Å:</b> ${escapeHtml(row.addr)}<br>` : "") +
        `<b>GPS:</b> ${row.lat.toFixed(6)}, ${row.lng.toFixed(6)}<br>` +
        `<b>–°—Ç–∞—Ç—É—Å:</b> ${escapeHtml(status)}<br>`;

      loadProfileIntoUI(row.code);
      renderChat(row.code);
      rp.classList.add("show");
    }

    function getProfiles(){ return safeJson(localStorage.getItem("sf_cs_biz_profiles")) || {}; }

    function loadProfileIntoUI(code){
      const key = normalizeCode(code);
      const all = getProfiles();
      const p = all[key] || {};

      const phone = p.phone ? escapeHtml(p.phone) : "‚Äî";
      const hours = p.hours ? escapeHtml(p.hours) : "‚Äî";
      const services = p.services ? escapeHtml(p.services) : "‚Äî";
      const desc = p.desc ? escapeHtml(p.desc) : "‚Äî";

      profileInfo.innerHTML =
        `<b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> ${phone}<br>` +
        `<b>–†–∞–±–æ—Ç–Ω–æ –≤—Ä–µ–º–µ:</b> ${hours}<br>` +
        `<b>–£—Å–ª—É–≥–∏:</b> ${services}<br>` +
        `<b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> ${desc}<br>`;
    }

    function chatKey(code){ return "sf_cs_chat_" + normalizeCode(code); }
    function getChat(code){ return safeJson(localStorage.getItem(chatKey(code))) || []; }
    function pushChat(code, msg){
      const arr = getChat(code);
      arr.push(msg);
      localStorage.setItem(chatKey(code), JSON.stringify(arr.slice(-80)));
    }
    function clearChat(code){ localStorage.removeItem(chatKey(code)); }
    function renderChat(code){
      const arr = getChat(code);
      chatList.innerHTML = "";
      if(!arr.length){
        chatList.innerHTML = `<div style="font-size:12px;opacity:.7">–ù—è–º–∞ —Å—ä–æ–±—â–µ–Ω–∏—è (–ª–æ–∫–∞–ª–Ω–æ).</div>`;
        return;
      }
      arr.forEach(m => {
        const div = document.createElement("div");
        div.className = "msg";
        const ts = m.ts ? new Date(m.ts) : new Date();
        div.innerHTML = `<b>${escapeHtml(m.from || "‚Äî")} ‚Ä¢ ${escapeHtml(ts.toLocaleString())}</b>${escapeHtml(m.text || "")}`;
        chatList.appendChild(div);
      });
      chatList.scrollTop = chatList.scrollHeight;
    }
  </script>

  <!-- ‚úÖ Google Maps Loader (–±–µ–∑ places) + cache-bust -->
  <script>
    (function(){
      const s = document.createElement("script");
      s.defer = true;
      s.src = "https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_KEY&callback=initMap&loading=async&v=" + Date.now();
      document.head.appendChild(s);
    })();
  </script>


<script>
  (function loadGoogleMapsSafely(){
    // –°–õ–û–ñ–ò –¢–£–ö –¢–í–û–Ø KEY
    const KEY = "AIzaSyBnqcxQTJgW-BLqrX2OqUZYV_QuJ4AHzGQ";

    // —É–Ω–∏–∫–∞–ª–µ–Ω callback, –∑–∞ –¥–∞ –Ω—è–º–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏ –¥–∞ –Ω—è–º–∞ ‚Äú—Å—Ç–∞—Ä‚Äù initMap
    const cb = "__sfMapsCb_" + Math.random().toString(36).slice(2);

    window[cb] = function(){
      try { delete window[cb]; } catch(e){}
      if (typeof window.initMap === "function") window.initMap();
    };

    const s = document.createElement("script");
    s.src = `https://maps.googleapis.com/maps/api/js?key=${KEY}&callback=${cb}&v=${Date.now()}`;
    s.async = false;            // üî• –≤–∞–∂–Ω–æ: –ù–ï async
    s.onerror = () => {
      const st = document.getElementById("status");
      if(st) st.textContent = "–ì—Ä–µ—à–∫–∞: Google Maps –Ω–µ —Å–µ –∑–∞—Ä–µ–¥–∏.";
      console.error("Google Maps load failed");
    };
    document.head.appendChild(s);
  })();
</script>

</body>
</html>
