<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SoulFlame CarService ‚Äî Map (User / TXT Only)</title>

  <style>
    html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
    #map { height:100%; width:100%; }

    :root{
      --ink:#111827;
      --muted:rgba(17,24,39,.72);
      --stroke:rgba(17,24,39,.12);
      --shadow:0 12px 30px rgba(0,0,0,.18);
      --glass:rgba(255,255,255,.94);
      --blue:#0b62ff;
      --green:#16a34a;
      --red:#b91c1c;
      --amber:#f59e0b;
    }

    #menu-button{
      position:absolute; top:15px; left:15px; z-index:1000;
      background:var(--ink); color:#fff; border:none;
      padding:10px 15px; font-size:20px; cursor:pointer; border-radius:12px;
      box-shadow:var(--shadow);
    }

    #panel{
      position:absolute; top:60px; left:15px; z-index:999;
      width:min(440px, 92vw);
      max-height:78vh;
      overflow:hidden;
      border-radius:16px;
      background:var(--glass);
      backdrop-filter: blur(10px);
      border:1px solid var(--stroke);
      box-shadow:0 0 10px rgba(0,0,0,.2);
    }
    #panelInner{ padding:12px; display:flex; flex-direction:column; gap:10px; }

    .head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .title{ font-weight:900; color:var(--ink); font-size:14px; letter-spacing:.3px; }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--stroke);
      background:#fff; color:var(--ink); font-weight:900;
    }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn{
      border:none; cursor:pointer; border-radius:12px;
      padding:10px 12px; font-weight:900; font-size:12px;
      background:var(--ink); color:#fff;
    }
    .btn.secondary{
      background:#fff; color:var(--ink);
      border:1px solid var(--stroke);
    }
    .search{
      flex:1; min-width:180px;
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-weight:900;
    }

    #results{
      overflow:auto;
      max-height: calc(78vh - 168px);
      padding-right:4px;
    }

    .item{
      border:1px solid rgba(17,24,39,.10);
      background:#fff;
      border-radius:14px;
      padding:10px;
      margin-bottom:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      cursor:pointer;
      transition:transform .08s ease, box-shadow .08s ease;
    }
    .item:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(0,0,0,.08); }

    .badge{
      min-width:44px; height:34px; border-radius:12px;
      background: rgba(17,24,39,.08);
      display:grid; place-items:center;
      font-weight:900;
      padding:0 10px;
      font-size:11px;
      color:var(--ink);
      user-select:none;
    }

    .meta{ flex:1; min-width:0; }
    .nameRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .name{
      font-weight:900; font-size:13px; color:var(--ink);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .addr{ font-size:12px; color:var(--muted); margin-top:3px; line-height:1.35; }
    .row2{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; font-size:12px; color:rgba(17,24,39,.78); }
    .link{ color:var(--blue); text-decoration:none; font-weight:900; }

    .stars{ display:flex; gap:2px; flex-shrink:0; }
    .star{
      width:18px; height:18px; line-height:18px;
      text-align:center;
      border-radius:6px;
      border:1px solid rgba(17,24,39,.14);
      cursor:pointer; user-select:none;
      font-size:12px;
      background:#fff;
    }
    .star.on{ background:rgba(245,158,11,.18); border-color:rgba(245,158,11,.55); }

    #status{
      position:absolute; right:12px; top:12px; z-index:1000;
      background:rgba(17,24,39,.88); color:#fff;
      padding:8px 10px; border-radius:12px; font-size:12px;
      box-shadow:var(--shadow);
      max-width:min(560px, 92vw);
      pointer-events:none;
    }

    /* Drawer */
    #drawer{
      position:absolute; right:15px; bottom:15px; z-index:1000;
      width:min(480px, 92vw);
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:16px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    #drawerHead{
      padding:12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:#fff;
      border-bottom:1px solid var(--stroke);
    }
    #drawerTitle{
      font-weight:900; color:var(--ink); font-size:14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    #drawerBody{ padding:12px; display:flex; flex-direction:column; gap:10px; }
    .kv{ font-size:12px; color:var(--muted); line-height:1.5; }
    .kv b{ color:var(--ink); }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
      font-size:12px;
    }
    .chip.green{ border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.10); }
    .chip.blue{ border-color:rgba(11,98,255,.35); background:rgba(11,98,255,.10); }
    .chip.amber{ border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.12); }

    /* Modal */
    #modalWrap{
      position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    #modal{
      width:min(520px, 96vw);
      background:#fff;
      border-radius:18px;
      box-shadow:0 30px 90px rgba(0,0,0,.28);
      border:1px solid rgba(17,24,39,.12);
      overflow:hidden;
    }
    #modalHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(17,24,39,.12);
      background:#fff;
    }
    #modalTitle{ font-weight:900; color:var(--ink); }
    #modalClose{
      border:none; background:rgba(17,24,39,.08);
      border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:900;
    }
    #modalBody{ padding:14px; }
    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .field label{ font-size:12px; font-weight:900; color:var(--ink); }
    .field input, .field textarea{
      border:1px solid rgba(17,24,39,.14);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-weight:700;
      font-family: Arial, sans-serif;
    }
    .field textarea{ min-height:96px; resize:vertical; }
    .modalActions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    @media (max-width:520px){
      #drawer{ right:12px; left:12px; width:auto; }
      #panel{ width:min(440px, 92vw); }
    }
  </style>
</head>

<body>
  <button id="menu-button">‚ò∞</button>

  <div id="panel">
    <div id="panelInner">
      <div class="head">
        <div class="title">–°–ª–∏–≤–µ–Ω ‚Äî —Å–µ—Ä–≤–∏–∑–∏ (—Å–∞–º–æ TXT)</div>
        <div class="pill" id="count">0</div>
      </div>

      <div class="controls">
        <button class="btn" id="reload">–û–±–Ω–æ–≤–∏ TXT</button>
        <button class="btn secondary" id="fitAll">–ü–æ–∫–∞–∂–∏ –≤—Å–∏—á–∫–∏</button>
        <input class="search" id="q" placeholder="–¢—ä—Ä—Å–∏ –ø–æ –∏–º–µ/–∞–¥—Ä–µ—Å/–∫–æ–¥..." />
      </div>

      <div id="results"></div>
    </div>
  </div>

  <div id="map"></div>
  <div id="status">–ó–∞—Ä–µ–∂–¥–∞–º‚Ä¶</div>

  <div id="drawer">
    <div id="drawerHead">
      <div id="drawerTitle">–ò–∑–±–µ—Ä–∏ —Å–µ—Ä–≤–∏–∑‚Ä¶</div>
      <div class="pill" id="drawerCode">‚Äî</div>
    </div>
    <div id="drawerBody">
      <div class="kv" id="drawerInfo">–ö–ª–∏–∫–Ω–∏ —Å–µ—Ä–≤–∏–∑ –æ—Ç –ø–∞–Ω–µ–ª–∞ –∏–ª–∏ –ø–∏–Ω –Ω–∞ –∫–∞—Ä—Ç–∞—Ç–∞.</div>

      <div class="chips">
        <button class="chip blue" id="btnDirections">–ù–∞–≤–∏–≥–∞—Ü–∏—è</button>
        <button class="chip green" id="btnCall">–û–±–∞–¥–∏ —Å–µ</button>
        <button class="chip amber" id="btnReview">–û—Å—Ç–∞–≤–∏ –æ—Ç–∑–∏–≤</button>
        <button class="chip" id="btnDiag">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ / –ò—Å—Ç–æ—Ä–∏—è</button>
        <button class="chip" id="btnPay">–û—Ç–∫–ª—é—á–∏ Premium</button>
      </div>

      <div class="kv" id="drawerMeta"></div>
      <div class="kv" id="drawerReviews"></div>
    </div>
  </div>

  <div id="modalWrap">
    <div id="modal">
      <div id="modalHead">
        <div id="modalTitle">Modal</div>
        <button id="modalClose">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const DATA_URL = "QR_serveses/sliven_avtoservizi.txt";
    const AUTO_REFRESH_MS = 30 * 60 * 1000;
    const SLIVEN_CENTER = { lat: 42.6852, lng: 26.3293 };

    // =========================
    // UI refs
    // =========================
    const resultsEl = document.getElementById("results");
    const statusEl  = document.getElementById("status");
    const countEl   = document.getElementById("count");
    const qEl       = document.getElementById("q");

    const reloadBtn = document.getElementById("reload");
    const fitAllBtn = document.getElementById("fitAll");

    const drawerTitle  = document.getElementById("drawerTitle");
    const drawerCode   = document.getElementById("drawerCode");
    const drawerInfo   = document.getElementById("drawerInfo");
    const drawerMeta   = document.getElementById("drawerMeta");
    const drawerReviews= document.getElementById("drawerReviews");

    const btnDirections = document.getElementById("btnDirections");
    const btnCall = document.getElementById("btnCall");
    const btnReview = document.getElementById("btnReview");
    const btnDiag = document.getElementById("btnDiag");
    const btnPay = document.getElementById("btnPay");

    const modalWrap = document.getElementById("modalWrap");
    const modalTitle= document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalClose= document.getElementById("modalClose");

    document.getElementById("menu-button").addEventListener("click", () => {
      const panel = document.getElementById("panel");
      panel.style.display = (panel.style.display === "none") ? "block" : "none";
    });

    modalClose.addEventListener("click", closeModal);
    modalWrap.addEventListener("click", (e) => { if(e.target === modalWrap) closeModal(); });

    function setStatus(t){ statusEl.textContent = t; }

    // =========================
    // Storage keys (local MVP)
    // =========================
    const K_RATE = (code) => `sf_user_rate_${code}`;
    const K_PREM = (code) => `sf_user_premium_${code}`;
    const K_REV  = (code) => `sf_user_reviews_${code}`;
    const K_DIAG = (code) => `sf_user_diag_${code}`;

    // =========================
    // Map
    // =========================
    let map, info;
    let markers = [];
    let byCode = new Map();
    let lastRows = [];
    let selectedCode = null;

    function initMap(){
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: SLIVEN_CENTER,
        mapTypeControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
          position: google.maps.ControlPosition.TOP_RIGHT
        }
      });

      info = new google.maps.InfoWindow();

      reloadBtn.addEventListener("click", () => loadAndRender(false));
      fitAllBtn.addEventListener("click", () => fitAll());
      qEl.addEventListener("input", () => renderList(getFiltered()));

      btnDirections.addEventListener("click", () => {
        const r = getSelectedRow();
        if(!r) return;
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}`, "_blank", "noopener");
      });

      btnCall.addEventListener("click", () => {
        const r = getSelectedRow();
        if(!r) return;
        if(!r.phone){ alert("–ù—è–º–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ TXT –∑–∞ —Ç–æ–∑–∏ —Å–µ—Ä–≤–∏–∑."); return; }
        window.location.href = `tel:${String(r.phone).replace(/\s+/g,"")}`;
      });

      btnReview.addEventListener("click", openReviewModal);
      btnDiag.addEventListener("click", openDiagnostics);
      btnPay.addEventListener("click", () => openPayModal(false));

      loadAndRender(true);
      setInterval(() => loadAndRender(false), AUTO_REFRESH_MS);
    }

    // =========================
    // TXT
    // =========================
    async function fetchTxt(url){
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("TXT –Ω–µ —Å–µ –∑–∞—Ä–µ–∂–¥–∞ ("+res.status+"). –ü—Ä–æ–≤–µ—Ä–∏ –ø—ä—Ç—è –∏ localhost.");
      return await res.text();
    }

    // Supported:
    // CODE | NAME | ADDRESS | LAT | LNG | PHONE? | MAPS?
    // CODE | NAME | LAT | LNG
    function parseTxt(txt){
      const lines = String(txt||"")
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(l => l && !l.startsWith("#"));

      const out = [];

      for(const line of lines){
        const parts = line.split("|").map(p => p.trim()).filter(p => p !== "");
        if(parts.length < 4) continue;

        // find first LAT+LNG numeric pair
        const nums = parts.map(p => Number(String(p).replace(",", ".")));
        let latIdx=-1, lngIdx=-1;

        for(let i=0;i<parts.length;i++){
          const n = nums[i];
          if(Number.isFinite(n) && Math.abs(n) <= 90){
            if(i+1 < parts.length){
              const n2 = nums[i+1];
              if(Number.isFinite(n2) && Math.abs(n2) <= 180){
                latIdx=i; lngIdx=i+1; break;
              }
            }
          }
        }
        if(latIdx === -1) continue;

        const code = (parts[0]||"").trim();
        const name = (parts[1]||"–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑").trim();

        const addr = (latIdx >= 3) ? (parts[2] || "") : "";
        const lat = Number(String(parts[latIdx]).replace(",", "."));
        const lng = Number(String(parts[lngIdx]).replace(",", "."));

        const tail = parts.slice(lngIdx+1);
        const phone = tail.find(x => /^[+0-9][0-9\s-]{6,}$/.test(x||"")) || "";
        const maps  = tail.find(x => /^https?:\/\//i.test(x||"")) || "";

        if(!code || !Number.isFinite(lat) || !Number.isFinite(lng)) continue;

        out.push({ code, name, addr, lat, lng, phone, maps, raw: line });
      }
      return out;
    }

    // =========================
    // Render
    // =========================
    function clearMarkers(){
      markers.forEach(m => m.setMap(null));
      markers = [];
      byCode.clear();
    }

    function fitAll(){
      if(!markers.length){
        map.setCenter(SLIVEN_CENTER);
        map.setZoom(12);
        return;
      }
      const b = new google.maps.LatLngBounds();
      markers.forEach(m => b.extend(m.getPosition()));
      map.fitBounds(b, 70);
    }

    function getFiltered(){
      const q = (qEl.value||"").trim().toLowerCase();
      if(!q) return lastRows.slice();
      return lastRows.filter(r => (`${r.code} ${r.name} ${r.addr}`.toLowerCase()).includes(q));
    }

    function renderPins(rows){
      clearMarkers();

      rows.forEach((r) => {
        const mk = new google.maps.Marker({
          position: { lat: r.lat, lng: r.lng },
          map,
          title: r.name
          // –ù–Ø–ú–ê label -> –Ω–∏—â–æ –Ω–µ —Å–µ –∑–∞—Å—Ç—ä–ø–≤–∞ –≤—ä—Ä—Ö—É –∫–∞—Ä—Ç–∞—Ç–∞.
        });

        mk.addListener("click", () => selectService(r.code, true));

        markers.push(mk);
        byCode.set(r.code.toUpperCase(), { row:r, marker:mk });
      });
    }

    function renderList(rows){
      resultsEl.innerHTML = "";
      countEl.textContent = String(rows.length);

      rows.forEach((r) => {
        const rate = getUserRate(r.code);
        const prem = isPremium(r.code);

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="badge">${escapeHtml(r.code)}</div>
          <div class="meta">
            <div class="nameRow">
              <div class="name" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
              <div class="stars" data-code="${escapeHtml(r.code)}">${starsHTML(rate)}</div>
            </div>
            <div class="addr">
              ${r.addr ? escapeHtml(r.addr) + "<br/>" : ""}
              <span style="opacity:.9">GPS:</span> ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}
            </div>
            <div class="row2">
              <span>${prem ? "üîì Premium" : "üîí Premium"}</span>
              <a class="link" target="_blank" rel="noopener"
                href="https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lng}">Google</a>
              ${r.phone ? `<span style="font-weight:900">üìû ${escapeHtml(r.phone)}</span>` : `<span style="opacity:.7">üìû (–ª–∏–ø—Å–≤–∞)</span>`}
            </div>
          </div>
        `;

        el.addEventListener("click", (e) => {
          if(e.target && e.target.classList && e.target.classList.contains("star")) return;
          selectService(r.code, true);
        });

        resultsEl.appendChild(el);
      });

      // bind stars
      document.querySelectorAll(".stars").forEach(box => {
        const code = box.getAttribute("data-code");
        box.querySelectorAll(".star").forEach(st => {
          st.addEventListener("click", (e) => {
            e.stopPropagation();
            const v = Number(st.getAttribute("data-v")||"0");
            setUserRate(code, v);
            renderList(getFiltered());
            if(selectedCode && selectedCode.toUpperCase() === code.toUpperCase()){
              renderDrawer(code);
            }
          });
        });
      });
    }

    function starsHTML(rate){
      let h="";
      for(let i=1;i<=5;i++){
        h += `<span class="star ${i<=rate ? "on":""}" data-v="${i}">‚òÖ</span>`;
      }
      return h;
    }

    function infoHTML(r){
      const prem = isPremium(r.code);
      const rate = getUserRate(r.code);
      const mapsLink = r.maps ? r.maps : `https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lng}`;
      const call = r.phone ? `<a class="link" href="tel:${escapeAttr(String(r.phone).replace(/\s+/g,""))}">üìû –û–±–∞–¥–∏ —Å–µ</a>`
                           : `<span style="opacity:.7">üìû (–ª–∏–ø—Å–≤–∞ —Ç–µ–ª–µ—Ñ–æ–Ω)</span>`;

      return `
        <div style="font-family:Arial;max-width:280px">
          <div style="font-weight:900;font-size:14px;margin-bottom:6px">${escapeHtml(r.name)}</div>
          <div style="font-size:12px;color:rgba(17,24,39,.75);margin-bottom:8px">
            <b>–ö–æ–¥:</b> ${escapeHtml(r.code)}<br/>
            ${r.addr ? `<b>–ê–¥—Ä–µ—Å:</b> ${escapeHtml(r.addr)}<br/>` : ""}
            <b>GPS:</b> ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}<br/>
            <b>–¢–≤–æ–∏—Ç–µ ‚≠ê:</b> ${rate}/5<br/>
            <b>Premium:</b> ${prem ? "–î–∞" : "–ù–µ"}
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <a class="link" target="_blank" rel="noopener" href="${escapeAttr(mapsLink)}">–û—Ç–≤–æ—Ä–∏ –≤ Google</a>
            ${call}
          </div>
        </div>
      `;
    }

    function selectService(code, pan){
      const key = String(code||"").trim().toUpperCase();
      const hit = byCode.get(key);
      if(!hit){ setStatus("–ù—è–º–∞ —Ç–∞–∫—ä–≤ –∫–æ–¥: " + key); return; }

      selectedCode = key;
      const { row, marker } = hit;

      if(pan){
        map.panTo({ lat: row.lat, lng: row.lng });
        map.setZoom(15);
      }

      info.setContent(infoHTML(row));
      info.open({ map, anchor: marker });

      renderDrawer(row.code);
      setStatus("OK: " + row.code + " ‚Äî " + row.name);
    }

    function renderDrawer(code){
      const r = byCode.get(String(code||"").toUpperCase())?.row;
      if(!r){
        drawerTitle.textContent = "–ò–∑–±–µ—Ä–∏ —Å–µ—Ä–≤–∏–∑‚Ä¶";
        drawerCode.textContent = "‚Äî";
        drawerInfo.textContent = "–ö–ª–∏–∫–Ω–∏ —Å–µ—Ä–≤–∏–∑ –æ—Ç –ø–∞–Ω–µ–ª–∞ –∏–ª–∏ –ø–∏–Ω –Ω–∞ –∫–∞—Ä—Ç–∞—Ç–∞.";
        drawerMeta.textContent = "";
        drawerReviews.innerHTML = "";
        return;
      }

      const prem = isPremium(r.code);
      const rate = getUserRate(r.code);
      const reviews = getReviews(r.code);

      drawerTitle.textContent = r.name;
      drawerCode.textContent = r.code;

      drawerInfo.innerHTML = `
        <div class="kv">
          ${r.addr ? `<b>–ê–¥—Ä–µ—Å:</b> ${escapeHtml(r.addr)}<br/>` : ""}
          <b>GPS:</b> ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}<br/>
          <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> ${r.phone ? escapeHtml(r.phone) : "–ª–∏–ø—Å–≤–∞ –≤ TXT"}
        </div>
      `;

      drawerMeta.innerHTML = `
        <div class="kv">
          <b>–¢–≤–æ–∏—Ç–µ ‚≠ê:</b> ${rate}/5 &nbsp; ‚Ä¢ &nbsp;
          <b>Premium:</b> ${prem ? `<span style="color:var(--green);font-weight:900">–ê–∫—Ç–∏–≤–µ–Ω</span>`
                                 : `<span style="color:var(--red);font-weight:900">–ó–∞–∫–ª—é—á–µ–Ω</span>`}
        </div>
      `;

      drawerReviews.innerHTML = reviewsHTML(reviews);

      btnCall.style.opacity = r.phone ? "1" : ".55";
    }

    async function loadAndRender(first){
      try{
        setStatus(first ? "–ó–∞—Ä–µ–∂–¥–∞–º TXT‚Ä¶" : "–û–±–Ω–æ–≤—è–≤–∞–º –æ—Ç TXT‚Ä¶");
        const txt = await fetchTxt(DATA_URL);
        const rows = parseTxt(txt);

        lastRows = rows;
        renderPins(rows);
        renderList(getFiltered());

        if(first) fitAll();

        // keep selection after refresh
        if(selectedCode && byCode.has(selectedCode)){
          renderDrawer(selectedCode);
        }

        setStatus(`OK: ${rows.length} —Å–µ—Ä–≤–∏–∑–∞ –æ—Ç TXT. Auto-refresh: ${Math.round(AUTO_REFRESH_MS/60000)} –º–∏–Ω.`);
      }catch(err){
        console.error(err);
        setStatus("–ì—Ä–µ—à–∫–∞: " + (err?.message || err));
      }
    }

    // =========================
    // Reviews + Premium + Diagnostics (local MVP)
    // =========================
    function getUserRate(code){
      const v = Number(localStorage.getItem(K_RATE(code)) || "0");
      return Number.isFinite(v) ? Math.max(0, Math.min(5, v)) : 0;
    }
    function setUserRate(code, v){
      const n = Math.max(0, Math.min(5, Number(v||0)));
      localStorage.setItem(K_RATE(code), String(n));
    }

    function isPremium(code){ return localStorage.getItem(K_PREM(code)) === "true"; }
    function setPremium(code, on){ localStorage.setItem(K_PREM(code), on ? "true" : "false"); }

    function getReviews(code){
      try{ return JSON.parse(localStorage.getItem(K_REV(code)) || "[]"); }
      catch(e){ return []; }
    }
    function addReview(code, review){
      const arr = getReviews(code);
      arr.push(review);
      localStorage.setItem(K_REV(code), JSON.stringify(arr));
    }

    function getDiagnostics(code){
      try{ return JSON.parse(localStorage.getItem(K_DIAG(code)) || "[]"); }
      catch(e){ return []; }
    }
    function addDiagnostic(code, entry){
      const arr = getDiagnostics(code);
      arr.push(entry);
      localStorage.setItem(K_DIAG(code), JSON.stringify(arr));
    }

    function openReviewModal(){
      const r = getSelectedRow();
      if(!r){ alert("–ò–∑–±–µ—Ä–∏ —Å–µ—Ä–≤–∏–∑ –ø—ä—Ä–≤–æ."); return; }

      modalTitle.textContent = `–û—Ç–∑–∏–≤ –∑–∞: ${r.name}`;
      modalBody.innerHTML = `
        <div class="field">
          <label>–ó–∞–≥–ª–∞–≤–∏–µ</label>
          <input id="rvTitle" placeholder="–ù–∞–ø—Ä. –ë—ä—Ä–∑–∏ –∏ —Ç–æ—á–Ω–∏" />
        </div>
        <div class="field">
          <label>–ó–≤–µ–∑–¥–∏ (1-5)</label>
          <input id="rvStars" type="number" min="1" max="5" value="${Math.max(1, getUserRate(r.code) || 5)}" />
        </div>
        <div class="field">
          <label>–¢–µ–∫—Å—Ç</label>
          <textarea id="rvText" placeholder="–û–ø–∏—à–∏ —Ä–µ–∞–ª–Ω–æ –∫–∞–∫ –º–∏–Ω–∞‚Ä¶"></textarea>
        </div>
        <div class="modalActions">
          <button class="btn" id="rvSave">–ó–∞–ø–∞–∑–∏</button>
          <button class="btn secondary" id="rvCancel">–û—Ç–∫–∞–∑</button>
        </div>
      `;
      openModal();

      document.getElementById("rvCancel").onclick = closeModal;
      document.getElementById("rvSave").onclick = () => {
        const title = (document.getElementById("rvTitle").value || "").trim();
        const stars = Math.max(1, Math.min(5, Number(document.getElementById("rvStars").value || "5")));
        const text  = (document.getElementById("rvText").value  || "").trim();
        if(!text){ alert("–ù–∞–ø–∏—à–∏ –ø–æ–Ω–µ 1 –∏–∑—Ä–µ—á–µ–Ω–∏–µ."); return; }

        addReview(r.code, { title: title || "–û—Ç–∑–∏–≤", stars, text, ts: new Date().toLocaleString("bg-BG") });
        setUserRate(r.code, stars);

        closeModal();
        renderList(getFiltered());
        renderDrawer(r.code);
        setStatus("–û—Ç–∑–∏–≤—ä—Ç –µ –∑–∞–ø–∏—Å–∞–Ω (–ª–æ–∫–∞–ª–Ω–æ).");
      };
    }

    function openDiagnostics(){
      const r = getSelectedRow();
      if(!r){ alert("–ò–∑–±–µ—Ä–∏ —Å–µ—Ä–≤–∏–∑ –ø—ä—Ä–≤–æ."); return; }
      if(!isPremium(r.code)){ openPayModal(true); return; }

      const arr = getDiagnostics(r.code).slice().reverse();
      const list = arr.length ? arr.map(x => `
        <div style="border:1px solid rgba(17,24,39,.10);border-radius:12px;padding:10px;background:#fff;margin-top:8px">
          <div style="font-weight:900;font-size:12px;color:var(--ink)">
            ${escapeHtml(x.car||"–ê–≤—Ç–æ–º–æ–±–∏–ª")} ‚Ä¢ ${escapeHtml(x.problem||"–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞")}
          </div>
          <div style="font-size:12px;color:rgba(17,24,39,.78);margin-top:6px;white-space:pre-wrap">${escapeHtml(x.details||"")}</div>
          <div style="font-size:11px;opacity:.65;margin-top:6px">${escapeHtml(x.ts||"")}</div>
        </div>
      `).join("") : `<div class="kv">–ù—è–º–∞ –∏—Å—Ç–æ—Ä–∏—è. –î–æ–±–∞–≤–∏ –ø—ä—Ä–≤–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.</div>`;

      modalTitle.textContent = `–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ / –ò—Å—Ç–æ—Ä–∏—è ‚Äî ${r.name}`;
      modalBody.innerHTML = `
        <div class="kv"><b>Premium:</b> –∞–∫—Ç–∏–≤–µ–Ω ‚úÖ</div>

        <div style="margin-top:12px;border-top:1px solid rgba(17,24,39,.12);padding-top:12px">
          <div class="field">
            <label>–ê–≤—Ç–æ–º–æ–±–∏–ª (–ø—Ä–∏–º–µ—Ä: Mercedes C200 / —Ä–µ–≥.‚Ññ)</label>
            <input id="dgCar" placeholder="–ö–æ–ª–∞—Ç–∞..." />
          </div>
          <div class="field">
            <label>–ü—Ä–æ–±–ª–µ–º / –î–∏–∞–≥–Ω–æ–∑–∞</label>
            <input id="dgProblem" placeholder="–ù–∞–ø—Ä. —Ç—Ä–∞–∫–∞ –æ—Ç–ø—Ä–µ–¥..." />
          </div>
          <div class="field">
            <label>–î–µ—Ç–∞–π–ª–∏</label>
            <textarea id="dgDetails" placeholder="–ö–∞–∫–≤–æ –µ —É—Å—Ç–∞–Ω–æ–≤–µ–Ω–æ, —á–∞—Å—Ç–∏, —Ü–µ–Ω–∞, –¥–∞—Ç–∞, —Å–ª–µ–¥–≤–∞—â–∞ —Å–º—è–Ω–∞..."></textarea>
          </div>
          <div class="modalActions">
            <button class="btn" id="dgSave">–ó–∞–ø–∞–∑–∏</button>
            <button class="btn secondary" id="dgClose">–ó–∞—Ç–≤–æ—Ä–∏</button>
          </div>
        </div>

        <div style="margin-top:12px;border-top:1px solid rgba(17,24,39,.12);padding-top:12px">
          <div style="font-weight:900;color:var(--ink);margin-bottom:6px">–ü–æ—Å–ª–µ–¥–Ω–∏ –∑–∞–ø–∏—Å–∏</div>
          ${list}
        </div>
      `;
      openModal();

      document.getElementById("dgClose").onclick = closeModal;
      document.getElementById("dgSave").onclick = () => {
        const car = (document.getElementById("dgCar").value || "").trim();
        const problem = (document.getElementById("dgProblem").value || "").trim();
        const details = (document.getElementById("dgDetails").value || "").trim();
        if(!car || !problem){ alert("–ü–æ–ø—ä–ª–Ω–∏ –ø–æ–Ω–µ '–ê–≤—Ç–æ–º–æ–±–∏–ª' –∏ '–ü—Ä–æ–±–ª–µ–º'."); return; }

        addDiagnostic(r.code, { car, problem, details, ts: new Date().toLocaleString("bg-BG") });
        closeModal();
        setStatus("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞—Ç–∞ –µ –∑–∞–ø–∏—Å–∞–Ω–∞ (–ª–æ–∫–∞–ª–Ω–æ).");
      };
    }

    function openPayModal(fromDiag){
      const r = getSelectedRow();
      if(!r){ alert("–ò–∑–±–µ—Ä–∏ —Å–µ—Ä–≤–∏–∑ –ø—ä—Ä–≤–æ."); return; }

      modalTitle.textContent = `Premium ‚Äî ${r.name}`;
      modalBody.innerHTML = `
        <div class="kv" style="margin-bottom:10px">
          ${fromDiag ? "<b>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞—Ç–∞ –µ –∑–∞–∫–ª—é—á–µ–Ω–∞.</b> –û—Ç–∫–ª—é—á–≤–∞ —Å–µ —Å Premium." : "–û—Ç–∫–ª—é—á–∏ Premium –∑–∞ –∏—Å—Ç–æ—Ä–∏—è/–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞."}
        </div>
        <div style="border:1px solid rgba(17,24,39,.12);border-radius:14px;padding:12px;background:#fff">
          <div style="font-weight:900;color:var(--ink)">SoulFlame Premium (MVP)</div>
          <div class="kv" style="margin-top:6px">
            ‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∫–æ–ª–∞—Ç–∞ + –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞<br/>
            ‚Ä¢ –†–µ–∞–ª–Ω–æ –ø–ª–∞—â–∞–Ω–µ: Stripe (–ø–æ-–∫—ä—Å–Ω–æ)
          </div>
          <div class="kv" style="margin-top:10px"><b>–¶–µ–Ω–∞ (–ø—Ä–∏–º–µ—Ä):</b> 9.99 –ª–≤/–º–µ—Å–µ—Ü</div>
          <div class="modalActions" style="margin-top:10px">
            <button class="btn" id="paySim">–°–∏–º—É–ª–∏—Ä–∞–π –ø–ª–∞—â–∞–Ω–µ (unlock)</button>
            <button class="btn secondary" id="payCancel">–û—Ç–∫–∞–∑</button>
          </div>
        </div>
      `;
      openModal();

      document.getElementById("payCancel").onclick = closeModal;
      document.getElementById("paySim").onclick = () => {
        setPremium(r.code, true);
        closeModal();
        renderList(getFiltered());
        renderDrawer(r.code);
        setStatus("Premium –æ—Ç–∫–ª—é—á–µ–Ω (–ª–æ–∫–∞–ª–Ω–æ) –∑–∞: " + r.code);
      };
    }

    function reviewsHTML(list){
      if(!list || !list.length) return `<div class="kv"><b>–û—Ç–∑–∏–≤–∏:</b> –æ—â–µ –Ω—è–º–∞.</div>`;
      const top = list.slice().reverse().slice(0, 5);
      const items = top.map(x => `
        <div style="border:1px solid rgba(17,24,39,.10);border-radius:12px;padding:10px;background:#fff;margin-top:8px">
          <div style="font-weight:900;font-size:12px;color:var(--ink)">
            ${escapeHtml(x.title||"–û—Ç–∑–∏–≤")} ‚Ä¢ ‚≠ê ${Number(x.stars||0)}/5
          </div>
          <div style="font-size:12px;color:rgba(17,24,39,.78);margin-top:6px;white-space:pre-wrap">${escapeHtml(x.text||"")}</div>
          <div style="font-size:11px;opacity:.65;margin-top:6px">${escapeHtml(x.ts||"")}</div>
        </div>
      `).join("");
      return `<div class="kv"><b>–û—Ç–∑–∏–≤–∏:</b>${items}</div>`;
    }

    function getSelectedRow(){
      if(!selectedCode) return null;
      return byCode.get(selectedCode)?.row || null;
    }

    function openModal(){ modalWrap.style.display="flex"; }
    function closeModal(){ modalWrap.style.display="none"; modalBody.innerHTML=""; }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function escapeAttr(str){
      return String(str).replace(/"/g, "&quot;");
    }
  </script>

  <!-- –°–∞–º–æ Maps JS. –ù–∏–∫–∞–∫—ä–≤ Places API usage –≤ –∫–æ–¥–∞. -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBnqcxQTJgW-BLqrX2OqUZYV_QuJ4AHzGQ&callback=initMap">
  </script>
</body>
</html>
