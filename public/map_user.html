<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SoulFlame CarService ‚Äî Map (User ‚Ä¢ World)</title>

  <style>
    html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
    #map { height:100%; width:100%; }

    #menu-button{
      position:absolute; top:15px; left:15px; z-index:1000;
      background:#111827; color:#fff; border:none;
      padding:10px 15px; font-size:20px; cursor:pointer; border-radius:10px;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
    }

    #panel-container{
      position:absolute; top:60px; left:15px; width:min(420px, 92vw);
      max-height:72vh; overflow:hidden;
      z-index:999; border-radius:14px;
      background: rgba(255,255,255,.94);
      backdrop-filter: blur(10px);
      border:1px solid rgba(17,24,39,.10);
      box-shadow:0 0 10px rgba(0,0,0,.2);
    }
    #panel-inner{ padding:12px; display:flex; flex-direction:column; gap:10px; }

    .panel-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .panel-title{ font-weight:900; letter-spacing:.4px; color:#111827; font-size:14px; }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(17,24,39,.12);
      background:#fff; color:#111827;
      font-weight:900;
    }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      border:none; cursor:pointer; border-radius:12px;
      padding:10px 12px; font-weight:900; font-size:12px; letter-spacing:.6px;
      background:#111827; color:#fff;
    }
    .btn.secondary{
      background:#fff; color:#111827;
      border:1px solid rgba(17,24,39,.14);
    }

    .controls2{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      border:1px solid rgba(17,24,39,.10);
      background: rgba(17,24,39,.03);
      border-radius:14px;
      padding:10px;
    }
    .select, .input{
      border:1px solid rgba(17,24,39,.14);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      font-size:12px;
      color:#111827;
      outline:none;
      width: 100%;
    }
    .input{ font-weight:800; }
    .controls2 > *{ flex:1; min-width: 140px; }

    .results{
      overflow:auto;
      max-height: calc(72vh - 285px);
      padding-right:4px;
    }

    .item{
      border:1px solid rgba(17,24,39,.10);
      background:#fff; border-radius:14px; padding:10px; margin-bottom:10px;
      display:flex; gap:10px; align-items:flex-start;
      cursor:pointer;
    }

    .badge{
      min-width:44px; height:34px; border-radius:12px;
      background: rgba(17,24,39,.08);
      display:grid; place-items:center;
      font-weight:900;
      padding:0 8px;
      font-size:11px;
      color:#111827;
      overflow:hidden;
    }

    /* SF Active style */
    .sfHeader{
      display:flex; align-items:center; justify-content:space-between;
      margin:6px 0 10px;
      padding:8px 10px;
      border:1px solid rgba(17,24,39,.10);
      border-radius:14px;
      background: rgba(17,24,39,.04);
      font-weight:900;
      color:#111827;
      font-size:12px;
      letter-spacing:.4px;
    }
    .sfTag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(17,24,39,.12);
      background:#fff;
      font-weight:900;
      display:flex;
      gap:6px;
      align-items:center;
    }
    .item.sfActive{
      border-color: rgba(16,185,129,.22);
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
    }
    .badge.sf{
      background: rgba(16,185,129,.12);
      border:1px solid rgba(16,185,129,.18);
    }
    .sfMini{
      font-size:11px;
      font-weight:900;
      color: rgba(17,24,39,.72);
    }

    .meta{ flex:1; min-width:0; }
    .name{
      font-weight:900; font-size:13px; color:#111827;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .addr{ font-size:12px; color:rgba(17,24,39,.72); margin-top:3px; }
    .row2{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; font-size:12px; color:rgba(17,24,39,.75); }
    .link{ color:#0b62ff; text-decoration:none; font-weight:900; }

    #status{
      position:absolute; right:12px; top:12px; z-index:1000;
      background:rgba(17,24,39,.88); color:#fff;
      padding:8px 10px; border-radius:10px; font-size:12px;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
      max-width:min(560px, 92vw);
      white-space: pre-wrap;
    }

    #search-area{
      position:absolute; top:14px; left:50%; transform:translateX(-50%);
      z-index:1000;
      background:#fff;
      border:1px solid rgba(17,24,39,.14);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      display:none;
      box-shadow:0 10px 26px rgba(0,0,0,.14);
    }
    #search-area.show{ display:block; }

    /* User strip */
    .userStrip{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:10px;
      border:1px solid rgba(17,24,39,.10);
      border-radius:14px;
      background: rgba(255,255,255,.90);
    }
    .uImg{ width:32px; height:32px; border-radius:12px; object-fit:cover; border:1px solid rgba(17,24,39,.12); }
    .uMeta{ min-width:0; flex:1; }
    .uName{ font-weight:900; font-size:12.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#111827; }
    .uMail{ font-size:12px; opacity:.72; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#111827; }

    @media (max-width:520px){
      #panel-container{ width:min(420px, 92vw); }
      .controls2 > *{ min-width: 100%; }
    }
  </style>
</head>

<body>
  <button id="menu-button">‚ò∞</button>

  <div id="panel-container">
    <div id="panel-inner">
      <div class="userStrip" id="userStrip" style="display:none">
        <img class="uImg" id="uImg" alt="User"/>
        <div class="uMeta">
          <div class="uName" id="uName">‚Äî</div>
          <div class="uMail" id="uMail">‚Äî</div>
        </div>
        <button class="btn secondary" id="btnLogout" type="button">–ò–∑—Ö–æ–¥</button>
      </div>

      <div class="panel-head">
        <div class="panel-title" id="panelTitle">–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑–∏ –æ–∫–æ–ª–æ —Ç–µ–± (Google)</div>
        <div class="pill" id="countPill">0</div>
      </div>

      <div class="controls">
        <button class="btn" id="btnRefresh">–û–±–Ω–æ–≤–∏</button>
        <button class="btn secondary" id="btnNearMe">–î–æ –º–µ–Ω</button>
        <button class="btn secondary" id="btnSF">SF Active</button>
        <button class="btn secondary" id="btnTxtSliven">TXT (Sliven)</button>
        <button class="btn secondary" id="btnTxtWorld">TXT (World)</button>
      </div>

      <div class="controls2">
        <select class="select" id="typeSelect" title="Type">
          <option value="car_repair" selected>car_repair</option>
          <option value="gas_station">gas_station</option>
          <option value="car_wash">car_wash</option>
        </select>

        <select class="select" id="radiusSelect" title="Radius">
          <option value="1500">1.5 km</option>
          <option value="3000">3 km</option>
          <option value="8000" selected>8 km</option>
          <option value="15000">15 km</option>
          <option value="30000">30 km</option>
        </select>

        <input class="input" id="queryInput" placeholder="–§–∏–ª—Ç—ä—Ä (–Ω–∞–ø—Ä. BMW, Bosch, garage)"/>
      </div>

      <div class="results" id="results">
        <div id="sfActiveWrap" style="display:none"></div>
        <div id="mainResults"></div>
      </div>
    </div>
  </div>

  <button id="search-area">–¢—ä—Ä—Å–∏ –≤ —Ç–æ–∑–∏ —Ä–∞–π–æ–Ω</button>

  <div id="map"></div>
  <div id="status">Loading‚Ä¶</div>

  <script type="module">
    // ==========================================================
    // ‚úÖ MAP USER ‚Ä¢ WORLD (PRO FIX)
    // - Fixes "initMap is not a function" by bridging callbacks.
    // - Google Places Nearby (places.googleapis.com)
    // - TXT fallback (Sliven + World template)
    // - Optional Firestore SF Active (if firebase modules exist)
    // ==========================================================

    // ====== CONFIG ======
    // Must exist in your project:
    // /public/googlelogin/config.js  -> export const SF_GOOGLE_MAPS_KEY = "..."
    import { SF_GOOGLE_MAPS_KEY } from "./googlelogin/config.js";

    const MAX_RESULTS = 30;

    // TXT paths
    const TXT_SLIVEN_URL = "/QR_serveses/sliven_avtoservizi.txt"; // recommended basic fallback
    const TXT_WORLD_TEMPLATE = "/QR_serveses/world/{CC}/{CITY}.txt"; // optional

    const DEFAULT_CENTER = { lat: 42.6852, lng: 26.3293 }; // Sliven

    // ====== UI ======
    const panel = document.getElementById("panel-container");
    const sfActiveWrap = document.getElementById("sfActiveWrap");
    const resultsEl = document.getElementById("mainResults");
    const statusEl = document.getElementById("status");
    const countPill = document.getElementById("countPill");
    const panelTitle = document.getElementById("panelTitle");

    const btnRefresh = document.getElementById("btnRefresh");
    const btnNearMe = document.getElementById("btnNearMe");
    const btnSF = document.getElementById("btnSF");
    const btnTxtSliven = document.getElementById("btnTxtSliven");
    const btnTxtWorld = document.getElementById("btnTxtWorld");
    const searchAreaBtn = document.getElementById("search-area");

    const typeSelect = document.getElementById("typeSelect");
    const radiusSelect = document.getElementById("radiusSelect");
    const queryInput = document.getElementById("queryInput");

    const userStrip = document.getElementById("userStrip");
    const uImg = document.getElementById("uImg");
    const uName = document.getElementById("uName");
    const uMail = document.getElementById("uMail");
    const btnLogout = document.getElementById("btnLogout");

    document.getElementById("menu-button").addEventListener("click", () => {
      panel.style.display = (panel.style.display === "none") ? "block" : "block"; // keep visible by default
      // if you want toggle:
      // panel.style.display = (panel.style.display === "none") ? "block" : "none";
    });

    function setStatus(t){ statusEl.textContent = t; }

    // ====== Utils ======
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function normalizePhoneForTel(phone){
      const p = String(phone || "").trim();
      if(!p) return "";
      return p.replace(/[^0-9+]/g, "");
    }
    function approxKm(lat1,lng1,lat2,lng2){
      const kx = 111.32;
      const ky = 111.32 * Math.cos((lat1*Math.PI)/180);
      const dx = (lat2-lat1) * kx;
      const dy = (lng2-lng1) * ky;
      return Math.sqrt(dx*dx + dy*dy);
    }
    function getLang2(){
      const lang = (navigator.language || "en").toLowerCase();
      return lang.split("-")[0] || "en";
    }
    function getRegion2(){
      const lang = (navigator.language || "").split("-");
      return (lang[1] && lang[1].length === 2) ? lang[1].toUpperCase() : null;
    }

    // ====== localStorage: location ======
    function getSavedLocation(){
      try { return JSON.parse(localStorage.getItem("sf_cs_location") || "null"); }
      catch(e){ return null; }
    }
    function saveLocalLocation(mode, lat, lng, accuracy, source){
      localStorage.setItem("sf_cs_location", JSON.stringify({
        mode, lat, lng,
        accuracy_m: accuracy ?? null,
        ts: new Date().toISOString(),
        source: source || "map"
      }));
    }

    // ====== Firebase (optional) ======
    // We do dynamic import to avoid breaking the whole page if firebase files are missing.
    let firebaseEnabled = false;
    let auth = null, db = null;
    let onAuthStateChanged = null, signOut = null;
    let doc = null, getDoc = null, setDoc = null, serverTimestamp = null;
    let collection = null, query = null, where = null, onSnapshot = null, orderBy = null, limit = null;

    async function tryLoadFirebase(){
      try{
        const fb = await import("./googlelogin/firebase.js");
        firebaseEnabled = !!fb.firebaseEnabled;
        auth = fb.auth || null;
        db = fb.db || null;

        const authLib = await import("https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js");
        onAuthStateChanged = authLib.onAuthStateChanged;
        signOut = authLib.signOut;

        const fsLib = await import("https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js");
        doc = fsLib.doc; getDoc = fsLib.getDoc; setDoc = fsLib.setDoc; serverTimestamp = fsLib.serverTimestamp;
        collection = fsLib.collection; query = fsLib.query; where = fsLib.where; onSnapshot = fsLib.onSnapshot;
        orderBy = fsLib.orderBy; limit = fsLib.limit;

        return true;
      }catch(e){
        firebaseEnabled = false;
        return false;
      }
    }

    async function upsertUserProfile(user){
      if(!firebaseEnabled || !db || !user || !setDoc) return;
      await setDoc(doc(db, "users", user.uid), {
        profile: {
          uid: user.uid,
          email: user.email || null,
          displayName: user.displayName || null,
          photoURL: user.photoURL || null,
          providerId: (user.providerData?.[0]?.providerId) || "google",
          lastLoginAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        },
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    async function readLastLocationFromFirestore(uid){
      if(!firebaseEnabled || !db || !uid || !getDoc) return null;
      try{
        const snap = await getDoc(doc(db, "users", uid));
        if(!snap.exists()) return null;
        const data = snap.data();
        const loc = data?.lastLocation || null;
        if(loc && typeof loc.lat === "number" && typeof loc.lng === "number") return loc;
        return null;
      }catch(e){
        return null;
      }
    }

    function showUser(user){
      userStrip.style.display = "flex";
      uImg.src = user.photoURL || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect width='80' height='80' rx='18' fill='%23ffffff'/%3E%3Cpath d='M40 41c9 0 16-7 16-16S49 9 40 9 24 16 24 25s7 16 16 16zm0 6c-13 0-24 7-24 16v4h48v-4c0-9-11-16-24-16z' fill='%230b0b0d' fill-opacity='.55'/%3E%3C/svg%3E";
      uName.textContent = user.displayName || "User";
      uMail.textContent = user.email || "";
    }

    // ====== GOOGLE MAPS LOADER (PRO FIX) ======
    function loadGoogleMaps(key){
      return new Promise((resolve, reject) => {
        if(window.google?.maps) return resolve();
        if(!key) return reject(new Error("Missing Google Maps key. Set SF_GOOGLE_MAPS_KEY in googlelogin/config.js"));

        // Bridge: if some cached/old script still calls callback=initMap, we handle it.
        // We resolve when ANY of these callbacks fires.
        let done = false;
        const finish = () => {
          if(done) return;
          done = true;
          resolve();
        };

        window.__sfInitMap = finish;
        window.initMap = finish; // IMPORTANT: fixes "initMap is not a function"

        const s = document.createElement("script");
        s.async = true; s.defer = true;

        // We choose callback=initMap for maximum compatibility (since we define window.initMap above).
        s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places&callback=initMap`;
        s.onerror = () => reject(new Error("Failed to load Google Maps JS."));
        document.head.appendChild(s);
      });
    }

    // ====== MAP STATE ======
    let map, info, pinMarker;
    let placeMarkers = [];
    let txtMarkers = [];
    let markersByCode = new Map();

    // SF Active
    let activeMarkers = [];
    let activeById = new Map();
    let activeRows = [];
    let activeUnsub = null;

    let lastSearchedCenter = null;
    let lastMode = "places"; // "places" | "txt-sliven" | "txt-world" | "sf"
    let currentUid = null;

    function clearPlaceMarkers(){ placeMarkers.forEach(m => m.setMap(null)); placeMarkers = []; }
    function clearTxtMarkers(){ txtMarkers.forEach(m => m.setMap(null)); txtMarkers = []; markersByCode.clear(); }
    function clearActiveMarkers(){ activeMarkers.forEach(m => m.setMap(null)); activeMarkers = []; activeById.clear(); }

    function fitMarkers(list){
      if(!list.length){
        map.setCenter(pinMarker ? pinMarker.getPosition() : DEFAULT_CENTER);
        map.setZoom(13);
        return;
      }
      const bounds = new google.maps.LatLngBounds();
      if(pinMarker) bounds.extend(pinMarker.getPosition());
      list.forEach(m => bounds.extend(m.getPosition()));
      map.fitBounds(bounds, 70);
    }

    function getCenterLatLng(){
      const c = pinMarker ? pinMarker.getPosition() : map.getCenter();
      return { lat: c.lat(), lng: c.lng() };
    }

    function currentRadiusMeters(){
      const r = Number(radiusSelect.value || 8000);
      if(Number.isFinite(r) && r > 200) return r;

      const b = map.getBounds();
      if(!b) return 8000;
      const c = b.getCenter();
      const ne = b.getNorthEast();
      const km = approxKm(c.lat(), c.lng(), ne.lat(), ne.lng());
      const meters = Math.min(Math.max(km * 1000, 800), 30000);
      return meters;
    }

    function placeInfoHTML(p){
      const name = p.displayName?.text || "Service";
      const addr = p.formattedAddress || "";
      const phone = p.internationalPhoneNumber || "";
      const tel = normalizePhoneForTel(phone);
      const website = p.websiteUri || "";
      const maps = p.googleMapsUri || "";
      const openNow = (p.currentOpeningHours && typeof p.currentOpeningHours.openNow === "boolean")
        ? (p.currentOpeningHours.openNow ? "Open now" : "Closed")
        : "";

      return `
        <div style="font-family:Arial;max-width:280px">
          <div style="font-weight:900;font-size:14px;margin-bottom:6px">${escapeHtml(name)}</div>
          <div style="font-size:12px;color:rgba(17,24,39,.75);margin-bottom:8px">${escapeHtml(addr)}</div>
          ${openNow ? `<div style="font-size:12px;font-weight:900;margin-bottom:8px">${openNow}</div>` : ""}
          ${phone ? `<div style="font-size:12px;margin-bottom:6px">üìû ${escapeHtml(phone)}</div>` : ""}
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
            ${maps ? `<a href="${maps}" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;color:#0b62ff">Google</a>` : ""}
            ${tel ? `<a href="tel:${tel}" style="font-weight:900;text-decoration:none;color:#0b62ff">Call</a>` : ""}
            ${website ? `<a href="${website}" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;color:#0b62ff">Website</a>` : ""}
          </div>
        </div>
      `;
    }

    // ====== SF Active (Firestore) ======
    function renderActivePanel(rows, modeLabel){
      if(!rows.length){
        sfActiveWrap.style.display = "none";
        sfActiveWrap.innerHTML = "";
        return;
      }
      sfActiveWrap.style.display = "block";
      sfActiveWrap.innerHTML = "";

      const head = document.createElement("div");
      head.className = "sfHeader";
      head.innerHTML = `
        <div>SOULFLAME ‚Ä¢ Active now</div>
        <div class="sfTag">
          ${modeLabel ? `<span class="sfMini">${escapeHtml(modeLabel)}</span>` : ""}
          <span>${rows.length}</span>
        </div>
      `;
      sfActiveWrap.appendChild(head);

      rows.forEach((r) => {
        const el = document.createElement("div");
        el.className = "item sfActive";
        el.innerHTML = `
          <div class="badge sf">SF</div>
          <div class="meta">
            <div class="name" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
            <div class="addr">
              ${r.addr ? escapeHtml(r.addr) + " ‚Ä¢ " : ""}
              ${Number(r.lat).toFixed(6)}, ${Number(r.lng).toFixed(6)}
            </div>
            <div class="row2">
              <span class="sfMini">ONLINE ‚úÖ</span>
              <a class="link" href="https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Directions</a>
            </div>
          </div>
        `;
        el.addEventListener("click", () => {
          const hit = activeById.get(r._id);
          if(!hit) return;
          map.panTo(hit.marker.getPosition());
          map.setZoom(16);
          google.maps.event.trigger(hit.marker, "click");
        });
        sfActiveWrap.appendChild(el);
      });
    }

    function renderActiveMarkers(rows){
      clearActiveMarkers();
      rows.forEach((r) => {
        const mk = new google.maps.Marker({
          position: { lat: Number(r.lat), lng: Number(r.lng) },
          map,
          title: r.name,
          label: { text: "SF" }
        });
        mk.addListener("click", () => {
          info.setContent(`
            <div style="font-family:Arial;max-width:290px">
              <div style="font-weight:900;font-size:14px;margin-bottom:6px">${escapeHtml(r.name)}</div>
              <div style="font-size:12px;color:rgba(17,24,39,.75);margin-bottom:8px">
                ${r.addr ? `<b>Address:</b> ${escapeHtml(r.addr)}<br/>` : ""}
                <b>GPS:</b> ${Number(r.lat).toFixed(6)}, ${Number(r.lng).toFixed(6)}
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
                <a class="link" href="https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lng}" target="_blank" rel="noopener">Google</a>
                <a class="link" href="https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}" target="_blank" rel="noopener">Directions</a>
              </div>
            </div>
          `);
          info.open({ map, anchor: mk });
        });
        activeMarkers.push(mk);
        activeById.set(r._id, { row: r, marker: mk });
      });
    }

    function subscribeActiveServicesRealtime(){
      if(!firebaseEnabled || !db || !onSnapshot){
        renderActivePanel([], "");
        clearActiveMarkers();
        return;
      }
      if(activeUnsub) { try{ activeUnsub(); }catch(e){} activeUnsub = null; }

      const qy = query(
        collection(db, "businesses"),
        where("isActive", "==", true),
        orderBy("updatedAt", "desc"),
        limit(200)
      );

      activeUnsub = onSnapshot(qy, (snap) => {
        const rows = [];
        snap.forEach((ds) => {
          const d = ds.data() || {};
          const lat = Number(d.lat ?? d.location?.lat ?? d.gps?.lat);
          const lng = Number(d.lng ?? d.location?.lng ?? d.gps?.lng);
          if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;

          const ts =
            (d.activatedAt?.toMillis ? d.activatedAt.toMillis() : 0) ||
            (d.updatedAt?.toMillis ? d.updatedAt.toMillis() : 0) || 0;

          rows.push({
            _id: ds.id,
            _ts: ts,
            name: d.name || "Service",
            addr: d.addr || "",
            lat, lng
          });
        });

        const center = getCenterLatLng();
        const rKm = currentRadiusMeters() / 1000;

        activeRows = rows
          .filter(r => approxKm(center.lat, center.lng, r.lat, r.lng) <= rKm)
          .sort((a,b) => (b._ts || 0) - (a._ts || 0))
          .slice(0, 40);

        renderActivePanel(activeRows, "LIVE");
        renderActiveMarkers(activeRows);
      }, () => {
        renderActivePanel([], "");
        clearActiveMarkers();
      });
    }

    // ====== TXT ======
    async function fetchTxt(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error("TXT not found ("+res.status+"): " + url);
      return await res.text();
    }

    // CODE | Name | Address | lat | lng | ...
    function parseTxt(txt){
      const lines = String(txt || "")
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(l => l && !l.startsWith("#"));

      const out = [];
      for(const line of lines){
        const parts = line.split("|").map(p => p.trim()).filter(Boolean);
        if(parts.length < 4) continue;

        const nums = parts.map(p => Number(String(p).replace(",", ".")));
        let latIdx = -1, lngIdx = -1;
        for(let i=0;i<parts.length;i++){
          const n = nums[i];
          if(Number.isFinite(n) && Math.abs(n) <= 90) {
            if(i+1 < parts.length){
              const n2 = nums[i+1];
              if(Number.isFinite(n2) && Math.abs(n2) <= 180){
                latIdx = i; lngIdx = i+1; break;
              }
            }
          }
        }
        if(latIdx === -1) continue;

        const code = parts[0];
        const name = parts[1] || "Service";
        const addr = (latIdx >= 3) ? parts[2] : "";
        const lat = Number(String(parts[latIdx]).replace(",", "."));
        const lng = Number(String(parts[lngIdx]).replace(",", "."));
        const source = parts.slice(lngIdx+1).join(" | ");

        if(!code || !Number.isFinite(lat) || !Number.isFinite(lng)) continue;
        out.push({ code, name, addr, lat, lng, source });
      }
      return out;
    }

    function renderTxt(rows, label){
      panelTitle.textContent = label;
      resultsEl.innerHTML = "";
      countPill.textContent = String(rows.length);

      clearTxtMarkers();
      clearPlaceMarkers();

      rows.forEach((r) => {
        const mk = new google.maps.Marker({
          position: { lat: r.lat, lng: r.lng },
          map,
          title: r.name,
          label: { text: r.code }
        });

        mk.addListener("click", () => {
          info.setContent(`
            <div style="font-family:Arial;max-width:280px">
              <div style="font-weight:900;font-size:14px;margin-bottom:6px">${escapeHtml(r.name)}</div>
              <div style="font-size:12px;color:rgba(17,24,39,.75);margin-bottom:8px">
                ${r.addr ? `<b>Address:</b> ${escapeHtml(r.addr)}<br/>` : ""}
                <b>GPS:</b> ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
                <a href="https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lng}" target="_blank" rel="noopener"
                  style="font-weight:900;text-decoration:none;color:#0b62ff">Google</a>
              </div>
              ${r.source ? `<div style="margin-top:8px;font-size:11px;opacity:.7">${escapeHtml(r.source)}</div>` : ""}
            </div>
          `);
          info.open({ map, anchor: mk });
        });

        txtMarkers.push(mk);
        markersByCode.set(r.code.toUpperCase(), { row: r, marker: mk });

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="badge">${escapeHtml(r.code)}</div>
          <div class="meta">
            <div class="name" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
            <div class="addr">
              ${r.addr ? escapeHtml(r.addr) + " ‚Ä¢ " : ""}
              ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}
            </div>
            <div class="row2">
              <a class="link" target="_blank" rel="noopener"
                href="https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lng}">Google</a>
            </div>
          </div>
        `;
        el.addEventListener("click", () => {
          map.panTo({ lat: r.lat, lng: r.lng });
          map.setZoom(15);
          google.maps.event.trigger(mk, "click");
        });
        resultsEl.appendChild(el);
      });

      fitMarkers(txtMarkers);
      setStatus(`TXT OK: ${rows.length}`);
    }

    function computeTxtWorldUrl(){
      const u = new URL(window.location.href);
      const cc = (u.searchParams.get("cc") || getRegion2() || "BG").toUpperCase();
      const city = (u.searchParams.get("city") || localStorage.getItem("SF_CITY") || "Sliven").trim();
      return TXT_WORLD_TEMPLATE
        .replace("{CC}", encodeURIComponent(cc))
        .replace("{CITY}", encodeURIComponent(city));
    }

    async function loadTxtSliven(){
      try{
        setStatus("TXT (Sliven) loading‚Ä¶");
        const txt = await fetchTxt(TXT_SLIVEN_URL);
        const rows = parseTxt(txt);
        renderTxt(rows, "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑–∏ (TXT ‚Ä¢ Sliven)");
        lastMode = "txt-sliven";
      }catch(e){
        setStatus("TXT Sliven error: " + (e?.message || e));
        resultsEl.innerHTML = `<div style="padding:10px;color:#b91c1c;font-weight:900">
          –õ–∏–ø—Å–≤–∞ —Ñ–∞–π–ª: ${TXT_SLIVEN_URL}<br/>–°–ª–æ–∂–∏ –≥–æ –≤: public/QR_serveses/sliven_avtoservizi.txt
        </div>`;
        countPill.textContent = "0";
      }
    }

    async function loadTxtWorld(){
      try{
        const url = computeTxtWorldUrl();
        setStatus("TXT (World) loading‚Ä¶\n" + url);
        const txt = await fetchTxt(url);
        const rows = parseTxt(txt);
        renderTxt(rows, "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑–∏ (TXT ‚Ä¢ World)");
        lastMode = "txt-world";
      }catch(e){
        setStatus("TXT World error: " + (e?.message || e));
        resultsEl.innerHTML = `<div style="padding:10px;color:#b91c1c;font-weight:900">
          World TXT –Ω–µ –µ –Ω–∞–ª–∏—á–µ–Ω –∑–∞ —Ç–∞–∑–∏ –¥—ä—Ä–∂–∞–≤–∞/–≥—Ä–∞–¥.<br/>
          –°–ª–æ–∂–∏ —Ñ–∞–π–ª –≤: public/QR_serveses/world/BG/Sliven.txt (–ø—Ä–∏–º–µ—Ä)
        </div>`;
        countPill.textContent = "0";
      }
    }

    // ====== GOOGLE PLACES (Nearby) ======
    async function searchNearby(lat, lng){
      panelTitle.textContent = "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑–∏ –æ–∫–æ–ª–æ —Ç–µ–± (Google)";
      setStatus("Google search‚Ä¶");
      resultsEl.innerHTML = "";
      countPill.textContent = "‚Ä¶";

      clearPlaceMarkers();
      clearTxtMarkers();

      lastSearchedCenter = new google.maps.LatLng(lat, lng);

      const apiKey = SF_GOOGLE_MAPS_KEY;
      const radius = currentRadiusMeters();
      const type = typeSelect.value || "car_repair";
      const qtext = (queryInput.value || "").trim();
      const lang = getLang2();

      // If no key -> directly TXT
      if(!apiKey){
        setStatus("No key ‚Üí TXT fallback.");
        await loadTxtSliven();
        return;
      }

      try{
        const url = "https://places.googleapis.com/v1/places:searchNearby";

        const body = {
          includedTypes: [type],
          maxResultCount: MAX_RESULTS,
          rankPreference: "DISTANCE",
          languageCode: lang,
          locationRestriction: {
            circle: {
              center: { latitude: lat, longitude: lng },
              radius
            }
          }
        };

        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Goog-Api-Key": apiKey,
            "X-Goog-FieldMask": [
              "places.id",
              "places.displayName",
              "places.formattedAddress",
              "places.location",
              "places.rating",
              "places.userRatingCount",
              "places.googleMapsUri",
              "places.websiteUri",
              "places.internationalPhoneNumber",
              "places.currentOpeningHours"
            ].join(",")
          },
          body: JSON.stringify(body)
        });

        if(!res.ok){
          const txt = await res.text();
          throw new Error("HTTP "+res.status+" ‚Äî "+txt.slice(0,800));
        }

        const data = await res.json();
        let places = data.places || [];

        if(qtext){
          const q = qtext.toLowerCase();
          places = places.filter(p => {
            const n = (p.displayName?.text || "").toLowerCase();
            const a = (p.formattedAddress || "").toLowerCase();
            return n.includes(q) || a.includes(q);
          });
        }

        countPill.textContent = String(places.length);
        setStatus(places.length ? `OK: ${places.length} ‚Ä¢ radius ${Math.round(radius/1000)}km` : "–ù—è–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –≤ —Ç–æ–∑–∏ —Ä–∞–¥–∏—É—Å.");
        drawPlaces(places);
        lastMode = "places";

      }catch(err){
        const msg = String(err?.message || err);
        console.error(err);

        // Automatic fallback
        if(msg.includes("403") || msg.includes("PERMISSION_DENIED")){
          setStatus("403 (Places/Billing/Key restrictions) ‚Üí TXT fallback (Sliven).");
        }else{
          setStatus("Places error ‚Üí TXT fallback (Sliven).");
        }
        await loadTxtSliven();
      }
    }

    function drawPlaces(places){
      resultsEl.innerHTML = "";
      clearPlaceMarkers();

      const bounds = new google.maps.LatLngBounds();
      if(pinMarker) bounds.extend(pinMarker.getPosition());

      places.forEach((p, i) => {
        const name = p.displayName?.text || "Service";
        const addr = p.formattedAddress || "";
        const rating = (p.rating != null) ? p.rating.toFixed(1) : null;
        const count = p.userRatingCount || 0;

        const lat = p.location?.latitude;
        const lng = p.location?.longitude;
        if(lat == null || lng == null) return;

        const phone = p.internationalPhoneNumber || "";
        const tel = normalizePhoneForTel(phone);

        const mk = new google.maps.Marker({
          position: { lat, lng },
          map,
          title: name,
          label: { text: String(i+1) }
        });

        mk.addListener("click", () => {
          info.setContent(placeInfoHTML(p));
          info.open({ map, anchor: mk });
        });

        placeMarkers.push(mk);
        bounds.extend({ lat, lng });

        const mapsLink = p.googleMapsUri || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`;
        const dirLink  = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="badge">${i+1}</div>
          <div class="meta">
            <div class="name" title="${escapeHtml(name)}">${escapeHtml(name)}</div>
            <div class="addr">${escapeHtml(addr)}</div>
            <div class="row2">
              ${rating ? `<span>‚≠ê ${rating} (${count})</span>` : `<span>–ë–µ–∑ —Ä–µ–π—Ç–∏–Ω–≥</span>`}
              <a class="link" href="${mapsLink}" target="_blank" rel="noopener">Google</a>
              <a class="link" href="${dirLink}" target="_blank" rel="noopener">Directions</a>
              ${tel ? `<a class="link" href="tel:${tel}" onclick="event.stopPropagation()">Call</a>` : ""}
            </div>
          </div>
        `;
        el.addEventListener("click", () => {
          map.panTo({ lat, lng });
          map.setZoom(15);
          google.maps.event.trigger(mk, "click");
        });

        resultsEl.appendChild(el);
      });

      if(!bounds.isEmpty()) map.fitBounds(bounds, 70);
    }

    // ====== MAP INIT ======
    function initMap(center){
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center,
        mapTypeControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
          position: google.maps.ControlPosition.TOP_RIGHT
        }
      });

      info = new google.maps.InfoWindow();

      map.addListener("click", (e) => {
        setPinAndSearch(e.latLng.lat(), e.latLng.lng(), true);
      });

      map.addListener("idle", () => {
        if(!lastSearchedCenter) return;
        const c = map.getCenter();
        const distKm = approxKm(lastSearchedCenter.lat(), lastSearchedCenter.lng(), c.lat(), c.lng());
        if(distKm > 0.25) searchAreaBtn.classList.add("show");
      });

      searchAreaBtn.addEventListener("click", () => {
        const c = map.getCenter();
        setPinAndSearch(c.lat(), c.lng(), true);
        searchAreaBtn.classList.remove("show");
      });

      btnRefresh.addEventListener("click", () => {
        const p = pinMarker ? pinMarker.getPosition() : map.getCenter();
        setPinAndSearch(p.lat(), p.lng(), true);
      });

      btnNearMe.addEventListener("click", () => locateAndSearch(true));

      btnTxtSliven.addEventListener("click", () => loadTxtSliven());
      btnTxtWorld.addEventListener("click", () => loadTxtWorld());

      btnSF.addEventListener("click", () => {
        lastMode = "sf";
        setStatus("SF Active‚Ä¶");
        subscribeActiveServicesRealtime();
      });
    }

    // ====== START ======
    async function bootstrapStart(){
      // choose center
      const saved = getSavedLocation();
      const center = (saved?.lat && saved?.lng) ? { lat: saved.lat, lng: saved.lng } : DEFAULT_CENTER;

      initMap(center);

      // Try firebase, but DO NOT block map if it fails
      const fbOk = await tryLoadFirebase();

      if(fbOk && firebaseEnabled && auth && onAuthStateChanged){
        onAuthStateChanged(auth, async (user) => {
          if(!user){
            // If your flow requires login, redirect:
            // window.location.href = "./access_location_user.html";
            // For now: allow map without forcing redirect
            setStatus("Not logged in (map still works).");
            locateAndSearch(true);
            return;
          }
          currentUid = user.uid;
          showUser(user);
          try{ await upsertUserProfile(user); }catch(e){}

          subscribeActiveServicesRealtime();

          const localLoc = getSavedLocation();
          if(localLoc && typeof localLoc.lat === "number" && typeof localLoc.lng === "number"){
            setPinAndSearch(localLoc.lat, localLoc.lng, true);
            return;
          }

          const fsLoc = await readLastLocationFromFirestore(user.uid);
          if(fsLoc && typeof fsLoc.lat === "number" && typeof fsLoc.lng === "number"){
            saveLocalLocation("user", fsLoc.lat, fsLoc.lng, fsLoc.accuracy_m ?? null, fsLoc.source || "firestore");
            setPinAndSearch(fsLoc.lat, fsLoc.lng, true);
            return;
          }

          locateAndSearch(true);
        });

        btnLogout.addEventListener("click", async () => {
          try{
            if(activeUnsub){ try{ activeUnsub(); }catch(e){} activeUnsub = null; }
            clearActiveMarkers();
            renderActivePanel([], "");
            await signOut(auth);
            setStatus("Logout‚Ä¶");
            window.location.href = "./access_location_user.html";
          }catch(e){
            setStatus("Logout error.");
          }
        });
      }else{
        // no firebase
        userStrip.style.display = "none";
        locateAndSearch(true);
      }
    }

    function locateAndSearch(doSearch){
      if(!navigator.geolocation){
        setStatus("No geolocation support ‚Üí fallback center.");
        setPinAndSearch(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng, doSearch);
        return;
      }
      setStatus("–ò—Å–∫–∞–º GPS‚Ä¶");
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          saveLocalLocation("user", lat, lng, pos.coords.accuracy, "geolocation");
          setPinAndSearch(lat, lng, doSearch);
        },
        () => {
          setStatus("GPS –æ—Ç–∫–∞–∑–∞–Ω ‚Üí fallback (Sliven).");
          saveLocalLocation("user", DEFAULT_CENTER.lat, DEFAULT_CENTER.lng, null, "fallback");
          setPinAndSearch(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng, doSearch);
        },
        { enableHighAccuracy:true, timeout:12000, maximumAge:5000 }
      );
    }

    function setPinAndSearch(lat, lng, doSearch){
      const pos = { lat, lng };

      if(!pinMarker){
        pinMarker = new google.maps.Marker({
          position: pos,
          map,
          draggable: true,
          title: "Search from here"
        });
        pinMarker.addListener("dragend", () => {
          const p = pinMarker.getPosition();
          setPinAndSearch(p.lat(), p.lng(), true);
        });
      } else {
        pinMarker.setPosition(pos);
      }

      map.setCenter(pos);
      map.setZoom(14);

      saveLocalLocation("user", lat, lng, null, "pin");

      // refresh SF active near this center
      subscribeActiveServicesRealtime();

      if(doSearch){
        lastMode = "places";
        searchNearby(lat, lng);
      }
    }

    // ====== BOOT ======
    (async function boot(){
      try{
        setStatus("Loading Google Maps‚Ä¶");
        await loadGoogleMaps(SF_GOOGLE_MAPS_KEY);
        setStatus("Maps loaded ‚úÖ");
        await bootstrapStart();
      }catch(e){
        console.error(e);
        setStatus("‚ùå " + (e?.message || e));
        // If maps failed, at least tell what to do
      }
    })();
  </script>
</body>
</html>
