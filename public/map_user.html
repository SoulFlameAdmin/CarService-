<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SoulFlame CarService — Map (User / All Services)</title>

  <style>
    html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
    #map { height:100%; width:100%; }

    #menu-button{
      position:absolute; top:15px; left:15px; z-index:1000;
      background:#111827; color:#fff; border:none;
      padding:10px 15px; font-size:20px; cursor:pointer; border-radius:10px;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
    }

    #panel-container{
      position:absolute; top:60px; left:15px; width:min(380px, 92vw);
      max-height: 72vh; overflow:hidden;
      z-index:999; border-radius:14px;
      background: rgba(255,255,255,.94);
      backdrop-filter: blur(10px);
      border:1px solid rgba(17,24,39,.10);
      box-shadow:0 0 10px rgba(0,0,0,.2);
    }
    #panel-inner{ padding:12px; display:flex; flex-direction:column; gap:10px; }

    .panel-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .panel-title{ font-weight:900; letter-spacing:.4px; color:#111827; font-size:14px; }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(17,24,39,.12);
      background:#fff; color:#111827;
      font-weight:900;
    }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      border:none; cursor:pointer; border-radius:12px;
      padding:10px 12px; font-weight:900; font-size:12px; letter-spacing:.6px;
      background:#111827; color:#fff;
    }
    .btn.secondary{
      background:#fff; color:#111827;
      border:1px solid rgba(17,24,39,.14);
    }

    .search{
      display:flex; gap:8px;
    }
    .search input{
      flex:1;
      border:1px solid rgba(17,24,39,.14);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-weight:800;
      font-size:13px;
      background:#fff;
      color:#111827;
    }

    .results{
      overflow:auto;
      max-height: calc(72vh - 250px);
      padding-right:4px;
    }

    .item{
      border:1px solid rgba(17,24,39,.10);
      background:#fff; border-radius:14px; padding:10px; margin-bottom:10px;
      display:flex; gap:10px; align-items:flex-start;
      cursor:pointer;
    }

    .badge{
      min-width:54px;
      width:54px;
      height:54px;
      border-radius:16px;
      background: rgba(17,24,39,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 54px;
      border:1px solid rgba(17,24,39,.10);
      font-weight:900;
      color:#111827;
    }

    .meta{ flex:1; min-width:0; }
    .name{
      font-weight:900; font-size:13px; color:#111827;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .addr{ font-size:12px; color:rgba(17,24,39,.72); margin-top:3px; line-height:1.35; }
    .row2{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;
      font-size:12px; color:rgba(17,24,39,.75);
    }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(17,24,39,.12);
      background: rgba(17,24,39,.03);
      font-weight:900;
    }

    #status{
      position:absolute; right:12px; top:12px; z-index:1000;
      background:rgba(17,24,39,.88); color:#fff;
      padding:8px 10px; border-radius:10px; font-size:12px;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
      max-width:min(520px, 92vw);
    }

    .marker-label {
      background: rgba(255,255,255,0.92);
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.12);
      white-space: nowrap;
    }

    /* ===== Right Slide Panel (User view) ===== */
    #rightPanel{
      position:fixed;
      top:0;
      right:0;
      height:100%;
      width:min(420px, 92vw);
      background: rgba(255,255,255,.96);
      border-left:1px solid rgba(17,24,39,.12);
      box-shadow: -18px 0 40px rgba(0,0,0,.12);
      z-index:1200;
      transform: translateX(105%);
      transition: transform .25s ease;
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
    }
    #rightPanel.show{ transform: translateX(0); }

    #rpHead{
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(17,24,39,.10);
    }
    #rpTitle{
      font-weight:900;
      font-size:14px;
      color:#111827;
      line-height:1.2;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
    }
    #rpSub{
      display:block;
      font-size:12px;
      opacity:.78;
      font-weight:800;
      margin-top:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }
    #rpClose{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      background:#111827;
      color:#fff;
      flex:0 0 auto;
    }
    #rpBody{
      padding:12px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      border:1px solid rgba(17,24,39,.10);
      background:#fff;
      border-radius:14px;
      padding:12px;
    }
    .card h4{
      margin:0 0 10px 0;
      font-size:12px;
      letter-spacing:.6px;
      text-transform:uppercase;
      color:rgba(17,24,39,.82);
    }
    .rpBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .rpBtn{
      border:none; cursor:pointer; border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      font-size:12px;
      background:#111827;
      color:#fff;
    }
    .rpBtn.secondary{
      background:#fff; color:#111827;
      border:1px solid rgba(17,24,39,.14);
    }
  </style>
</head>

<body>
  <button id="menu-button">☰</button>

  <div id="panel-container">
    <div id="panel-inner">
      <div class="panel-head">
        <div class="panel-title">Сливен — всички сервизи</div>
        <div class="pill" id="countPill">0</div>
      </div>

      <div class="controls">
        <button class="btn" id="btnReload">Обнови</button>
        <button class="btn secondary" id="btnNear">Подреди по близост</button>
      </div>

      <div class="search">
        <input id="q" placeholder="Търси по име/адрес..." />
      </div>

      <div class="results" id="results"></div>
    </div>
  </div>

  <div id="map"></div>
  <div id="status">Зареждам…</div>

  <!-- Right panel -->
  <aside id="rightPanel">
    <div id="rpHead">
      <div style="min-width:0;flex:1">
        <div id="rpTitle">—</div>
        <small id="rpSub">—</small>
      </div>
      <button id="rpClose">Затвори</button>
    </div>

    <div id="rpBody">
      <div class="card">
        <h4>Инфо</h4>
        <div id="baseInfo" style="font-size:12px;line-height:1.55;color:rgba(17,24,39,.82)"></div>

        <div class="rpBtns">
          <button class="rpBtn" id="btnCenter">Центрирай</button>
          <button class="rpBtn secondary" id="btnOpenGoogle">Отвори в Google</button>
          <button class="rpBtn secondary" id="btnDirections">Навигация</button>
        </div>
      </div>

      <div class="card">
        <h4>Оценка / Отзив</h4>
        <div style="font-size:12px;opacity:.8;line-height:1.5">
          MVP: засега отзивите са през Google (официално). После го връзваме към Firestore (звезди + коментари в app).
        </div>
        <div class="rpBtns">
          <button class="rpBtn secondary" id="btnReview">Остави отзив (Google)</button>
        </div>
      </div>
    </div>
  </aside>

  <script>
    "use strict";

    // ====== CONFIG ======
    // Важно: файлът трябва да е в /public/QR_serveses/sliven_avtoservizi.txt
    const DATA_URL = "/QR_serveses/sliven_avtoservizi.txt";
    const AUTO_REFRESH_MS = 30 * 60 * 1000;

    // ====== UI ======
    const panel = document.getElementById("panel-container");
    const resultsEl = document.getElementById("results");
    const statusEl = document.getElementById("status");
    const countPill = document.getElementById("countPill");

    const btnReload = document.getElementById("btnReload");
    const btnNear = document.getElementById("btnNear");
    const qEl = document.getElementById("q");

    document.getElementById("menu-button").addEventListener("click", () => {
      panel.style.display = (panel.style.display === "none") ? "block" : "none";
    });

    function setStatus(t){ statusEl.textContent = t; }

    // ====== MAP ======
    let map, info;
    let markersByCode = new Map();
    let markers = [];
    let lastData = [];
    let userLoc = null; // {lat,lng}

    const SLIVEN_CENTER = { lat: 42.6852, lng: 26.3293 };

    function initMap(){
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: SLIVEN_CENTER,
        mapTypeControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
          position: google.maps.ControlPosition.TOP_RIGHT
        }
      });

      info = new google.maps.InfoWindow();

      wireRightPanel();

      loadAndRender(true);
      setInterval(() => loadAndRender(false), AUTO_REFRESH_MS);

      btnReload.addEventListener("click", () => loadAndRender(false));

      btnNear.addEventListener("click", async () => {
        await ensureGeo();
        if(!userLoc){
          alert("Не даде GPS достъп. Ако разрешиш локация, ще подредя по близост.");
          return;
        }
        applyView(lastData, true);
      });

      qEl.addEventListener("input", () => applyView(lastData, false));
    }
    window.initMap = initMap;

    // ====== TXT LOADING ======
    async function fetchTxt(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error("Не мога да заредя TXT ("+res.status+"). Провери дали е в /public/QR_serveses/.");
      return await res.text();
    }

    function normalizeCode(s){
      return (s || "")
        .trim()
        .toUpperCase()
        .replace(/\s+/g,"-")
        .replace(/[^A-Z0-9\-]/g,"");
    }

    function parseTxt(txt){
      const lines = String(txt || "")
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(l => l && !l.startsWith("#"));

      const out = [];
      for(const line of lines){
        const parts = line.split("|").map(p => p.trim());
        // Формат: CODE|NAME|ADDR|LAT|LNG|...
        if(parts.length < 5) continue;

        const code = normalizeCode(parts[0]);
        const name = parts[1] || "Автосервиз";
        const addr = parts[2] || "";
        const lat = Number(String(parts[3]).replace(",", "."));
        const lng = Number(String(parts[4]).replace(",", "."));
        const source = parts.slice(5).join(" | ").trim();

        if(!code || !Number.isFinite(lat) || !Number.isFinite(lng)) continue;
        out.push({ code, name, addr, lat, lng, source, raw: line });
      }
      return out;
    }

    // ====== GEO + DISTANCE ======
    function toRad(x){ return x * Math.PI / 180; }
    function haversineKm(a, b){
      const R = 6371;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
      const q = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2 * R * Math.asin(Math.sqrt(q));
    }

    async function ensureGeo(){
      if(userLoc) return userLoc;
      return new Promise((resolve) => {
        if(!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            resolve(userLoc);
          },
          () => resolve(null),
          { enableHighAccuracy:true, timeout:8000, maximumAge: 60_000 }
        );
      });
    }

    // ====== RENDER ======
    function clearMarkers(){
      for(const m of markers) m.setMap(null);
      markers = [];
      markersByCode.clear();
    }

    function fitAll(){
      if(!markers.length){
        map.setCenter(SLIVEN_CENTER);
        map.setZoom(12);
        return;
      }
      const bounds = new google.maps.LatLngBounds();
      markers.forEach(m => bounds.extend(m.getPosition()));
      map.fitBounds(bounds, 70);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function markerHtml(row){
      const mapsLink = `https://www.google.com/maps/search/?api=1&query=${row.lat},${row.lng}`;
      const dist = (userLoc ? haversineKm(userLoc, {lat:row.lat, lng:row.lng}) : null);

      return `
        <div style="font-family:Arial;max-width:290px">
          <div style="font-weight:900;font-size:14px;margin-bottom:6px">${escapeHtml(row.name)}</div>
          <div style="font-size:12px;color:rgba(17,24,39,.75);margin-bottom:8px">
            ${row.addr ? `<b>Адрес:</b> ${escapeHtml(row.addr)}<br/>` : ""}
            <b>GPS:</b> ${row.lat.toFixed(6)}, ${row.lng.toFixed(6)}<br/>
            ${dist != null ? `<b>Разстояние:</b> ${dist.toFixed(2)} km<br/>` : ""}
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
            <a href="${mapsLink}" target="_blank" rel="noopener"
              style="font-weight:900;text-decoration:none;color:#0b62ff">Отвори в Google</a>
          </div>
        </div>
      `;
    }

    function renderList(rows){
      resultsEl.innerHTML = "";
      countPill.textContent = String(rows.length);

      if(!rows.length){
        resultsEl.innerHTML = `<div style="padding:10px;font-size:12px;opacity:.75">Няма резултати.</div>`;
        return;
      }

      rows.forEach((r, idx) => {
        const dist = (userLoc ? haversineKm(userLoc, {lat:r.lat, lng:r.lng}) : null);

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="badge">${idx + 1}</div>
          <div class="meta">
            <div class="name" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
            <div class="addr">
              ${r.addr ? escapeHtml(r.addr) + "<br/>" : ""}
              ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}
            </div>
            <div class="row2">
              ${dist != null ? `<span class="tag">${dist.toFixed(2)} km</span>` : `<span class="tag">GPS: off</span>`}
              <span class="tag">Код: ${escapeHtml(r.code)}</span>
            </div>
          </div>
        `;
        el.addEventListener("click", () => focusRow(r.code, true));
        resultsEl.appendChild(el);
      });
    }

    function renderPins(rows){
      clearMarkers();

      rows.forEach((r, idx) => {
        const mk = new google.maps.Marker({
          position: { lat: r.lat, lng: r.lng },
          map,
          title: r.name,
          label: {
            text: String(idx + 1),
            fontSize: "11px",
            fontWeight: "800",
            color: "#111",
            className: "marker-label"
          }
        });

        mk.addListener("click", () => {
          info.setContent(markerHtml(r));
          info.open({ map, anchor: mk });
          openRightPanel(r);
        });

        markers.push(mk);
        markersByCode.set(normalizeCode(r.code||""), { row: r, marker: mk });
      });
    }

    function focusRow(code, openPanel){
      const key = normalizeCode(code||"");
      const hit = markersByCode.get(key);
      if(!hit){
        setStatus("Няма такъв запис.");
        return;
      }
      const { row, marker } = hit;
      map.panTo({ lat: row.lat, lng: row.lng });
      map.setZoom(16);
      google.maps.event.trigger(marker, "click");
      setStatus("OK: " + row.name);
      if(openPanel) openRightPanel(row);
    }

    function applyView(allRows, sortByNear){
      lastData = allRows;

      // filter by search
      const q = (qEl.value || "").trim().toLowerCase();
      let rows = allRows.filter(r => {
        if(!q) return true;
        return (r.name || "").toLowerCase().includes(q) || (r.addr || "").toLowerCase().includes(q) || (r.code || "").toLowerCase().includes(q);
      });

      if(sortByNear && userLoc){
        rows = rows
          .map(r => ({...r, _d: haversineKm(userLoc, {lat:r.lat, lng:r.lng})}))
          .sort((a,b) => (a._d||999999) - (b._d||999999))
          .map(r => { delete r._d; return r; });
        setStatus(`OK: Подредих по близост (${rows.length}).`);
      } else {
        setStatus(`OK: ${rows.length} сервиза (филтър).`);
      }

      renderPins(rows);
      renderList(rows);
      fitAll();
    }

    async function loadAndRender(first){
      try{
        setStatus(first ? "Зареждам TXT…" : "Обновявам…");
        const txt = await fetchTxt(DATA_URL);
        const rows = parseTxt(txt);

        // опит за geo без да спами: само първо зареждане
        if(first) await ensureGeo();

        applyView(rows, false);
      }catch(err){
        console.error(err);
        setStatus("Грешка: " + (err?.message || err));
      }
    }

    // ===== Right Panel Logic (USER) =====
    const rp = document.getElementById("rightPanel");
    const rpClose = document.getElementById("rpClose");
    const rpTitle = document.getElementById("rpTitle");
    const rpSub = document.getElementById("rpSub");
    const baseInfo = document.getElementById("baseInfo");

    const btnOpenGoogle = document.getElementById("btnOpenGoogle");
    const btnDirections = document.getElementById("btnDirections");
    const btnCenter = document.getElementById("btnCenter");
    const btnReview = document.getElementById("btnReview");

    let currentRow = null;

    function wireRightPanel(){
      rpClose.addEventListener("click", () => rp.classList.remove("show"));

      btnCenter.addEventListener("click", () => {
        if(!currentRow) return;
        map.panTo({lat: currentRow.lat, lng: currentRow.lng});
        map.setZoom(16);
      });

      btnOpenGoogle.addEventListener("click", () => {
        if(!currentRow) return;
        const url = `https://www.google.com/maps/search/?api=1&query=${currentRow.lat},${currentRow.lng}`;
        window.open(url, "_blank", "noopener");
      });

      btnDirections.addEventListener("click", () => {
        if(!currentRow) return;
        const url = `https://www.google.com/maps/dir/?api=1&destination=${currentRow.lat},${currentRow.lng}`;
        window.open(url, "_blank", "noopener");
      });

      btnReview.addEventListener("click", () => {
        if(!currentRow) return;
        // Най-лесно MVP: отваряме търсене по име (Google ще ти даде мястото и review)
        const q = encodeURIComponent(`${currentRow.name} ${currentRow.addr || ""}`);
        const url = `https://www.google.com/maps/search/?api=1&query=${q}`;
        window.open(url, "_blank", "noopener");
      });
    }

    function openRightPanel(row){
      currentRow = row;

      const dist = (userLoc ? haversineKm(userLoc, {lat:row.lat, lng:row.lng}) : null);

      rpTitle.textContent = row.name || "—";
      rpSub.textContent = row.addr ? row.addr : "—";

      baseInfo.innerHTML =
        `<b>Име:</b> ${escapeHtml(row.name)}<br>` +
        (row.addr ? `<b>Адрес:</b> ${escapeHtml(row.addr)}<br>` : "") +
        `<b>GPS:</b> ${row.lat.toFixed(6)}, ${row.lng.toFixed(6)}<br>` +
        (dist != null ? `<b>Разстояние:</b> ${dist.toFixed(2)} km<br>` : "") +
        `<b>Код:</b> ${escapeHtml(row.code)}<br>`;

      rp.classList.add("show");
    }
  </script>

  <!-- ✅ Google Maps JS -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBnqcxQTJgW-BLqrX2OqUZYV_QuJ4AHzGQ&libraries=places&callback=initMap">
  </script>
</body>
</html>
