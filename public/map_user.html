<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SoulFlame CarService ‚Äî Map (User ‚Ä¢ World)</title>

  <style>
    html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
    #map { height:100%; width:100%; }

    #menu-button{
      position:absolute; top:15px; left:15px; z-index:1000;
      background:#111827; color:#fff; border:none;
      padding:10px 15px; font-size:20px; cursor:pointer; border-radius:10px;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
    }

    #panel-container{
      position:absolute; top:60px; left:15px; width:min(420px, 92vw);
      max-height:72vh; overflow:hidden;
      z-index:999; border-radius:14px;
      background: rgba(255,255,255,.94);
      backdrop-filter: blur(10px);
      border:1px solid rgba(17,24,39,.10);
      box-shadow:0 0 10px rgba(0,0,0,.2);
    }
    #panel-inner{ padding:12px; display:flex; flex-direction:column; gap:10px; }

    .panel-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .panel-title{ font-weight:900; letter-spacing:.4px; color:#111827; font-size:14px; }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(17,24,39,.12);
      background:#fff; color:#111827;
      font-weight:900;
    }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      border:none; cursor:pointer; border-radius:12px;
      padding:10px 12px; font-weight:900; font-size:12px; letter-spacing:.6px;
      background:#111827; color:#fff;
    }
    .btn.secondary{
      background:#fff; color:#111827;
      border:1px solid rgba(17,24,39,.14);
    }

    .controls2{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      border:1px solid rgba(17,24,39,.10);
      background: rgba(17,24,39,.03);
      border-radius:14px;
      padding:10px;
    }
    .select, .input{
      border:1px solid rgba(17,24,39,.14);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      font-size:12px;
      color:#111827;
      outline:none;
      width: 100%;
    }
    .input{ font-weight:800; }
    .controls2 > *{ flex:1; min-width: 140px; }

    .results{
      overflow:auto;
      max-height: calc(72vh - 285px);
      padding-right:4px;
    }

    .item{
      border:1px solid rgba(17,24,39,.10);
      background:#fff; border-radius:14px; padding:10px; margin-bottom:10px;
      display:flex; gap:10px; align-items:flex-start;
      cursor:pointer;
    }

    .badge{
      min-width:44px; height:34px; border-radius:12px;
      background: rgba(17,24,39,.08);
      display:grid; place-items:center;
      font-weight:900;
      padding:0 8px;
      font-size:11px;
      color:#111827;
      overflow:hidden;
    }

    /* SoulFlame Active style */
    .sfHeader{
      display:flex; align-items:center; justify-content:space-between;
      margin:6px 0 10px;
      padding:8px 10px;
      border:1px solid rgba(17,24,39,.10);
      border-radius:14px;
      background: rgba(17,24,39,.04);
      font-weight:900;
      color:#111827;
      font-size:12px;
      letter-spacing:.4px;
    }
    .sfTag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(17,24,39,.12);
      background:#fff;
      font-weight:900;
      display:flex;
      gap:6px;
      align-items:center;
    }
    .item.sfActive{
      border-color: rgba(16,185,129,.22);
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
    }
    .badge.sf{
      background: rgba(16,185,129,.12);
      border:1px solid rgba(16,185,129,.18);
    }
    .sfMini{
      font-size:11px;
      font-weight:900;
      color: rgba(17,24,39,.72);
    }

    .meta{ flex:1; min-width:0; }
    .name{
      font-weight:900; font-size:13px; color:#111827;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .addr{ font-size:12px; color:rgba(17,24,39,.72); margin-top:3px; }
    .row2{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; font-size:12px; color:rgba(17,24,39,.75); }
    .link{ color:#0b62ff; text-decoration:none; font-weight:900; }

    #status{
      position:absolute; right:12px; top:12px; z-index:1000;
      background:rgba(17,24,39,.88); color:#fff;
      padding:8px 10px; border-radius:10px; font-size:12px;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
      max-width:min(560px, 92vw);
      white-space: pre-wrap;
    }

    /* ‚Äú–¢—ä—Ä—Å–∏ –≤ —Ç–æ–∑–∏ —Ä–∞–π–æ–Ω‚Äù */
    #search-area{
      position:absolute; top:14px; left:50%; transform:translateX(-50%);
      z-index:1000;
      background:#fff;
      border:1px solid rgba(17,24,39,.14);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      display:none;
      box-shadow:0 10px 26px rgba(0,0,0,.14);
    }
    #search-area.show{ display:block; }

    .marker-label{
      background: rgba(255,255,255,0.9);
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.15);
      white-space: nowrap;
    }

    /* User strip */
    .userStrip{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:10px;
      border:1px solid rgba(17,24,39,.10);
      border-radius:14px;
      background: rgba(255,255,255,.90);
    }
    .uImg{ width:32px; height:32px; border-radius:12px; object-fit:cover; border:1px solid rgba(17,24,39,.12); }
    .uMeta{ min-width:0; flex:1; }
    .uName{ font-weight:900; font-size:12.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#111827; }
    .uMail{ font-size:12px; opacity:.72; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#111827; }

    @media (max-width:520px){
      #panel-container{ width:min(420px, 92vw); }
      .controls2 > *{ min-width: 100%; }
    }
  </style>
</head>

<body>
  <button id="menu-button">‚ò∞</button>

  <div id="panel-container">
    <div id="panel-inner">
      <!-- USER INFO -->
      <div class="userStrip" id="userStrip" style="display:none">
        <img class="uImg" id="uImg" alt="User"/>
        <div class="uMeta">
          <div class="uName" id="uName">‚Äî</div>
          <div class="uMail" id="uMail">‚Äî</div>
        </div>
        <button class="btn secondary" id="btnLogout" type="button">–ò–∑—Ö–æ–¥</button>
      </div>

      <div class="panel-head">
        <div class="panel-title" id="panelTitle">Auto services near you</div>
        <div class="pill" id="countPill">0</div>
      </div>

      <div class="controls">
        <button class="btn" id="btnRefresh">Search</button>
        <button class="btn secondary" id="btnNearMe">Near me</button>
        <button class="btn secondary" id="btnSF">SF Active</button>
        <button class="btn secondary" id="btnUseTxt">TXT</button>
      </div>

      <!-- World filters -->
      <div class="controls2">
        <select class="select" id="typeSelect" title="Type">
          <option value="car_repair" selected>car_repair (default)</option>
          <option value="gas_station">gas_station</option>
          <option value="car_wash">car_wash</option>
          <option value="tire_shop">tire_shop (if supported)</option>
        </select>

        <select class="select" id="radiusSelect" title="Radius">
          <option value="1500">1.5 km</option>
          <option value="3000">3 km</option>
          <option value="8000" selected>8 km</option>
          <option value="15000">15 km</option>
          <option value="30000">30 km</option>
        </select>

        <input class="input" id="queryInput" placeholder="Optional text (e.g. BMW, Bosch, garage)"/>
      </div>

      <!-- Active(SF) + Main(Google/TXT) -->
      <div class="results" id="results">
        <div id="sfActiveWrap" style="display:none"></div>
        <div id="mainResults"></div>
      </div>
    </div>
  </div>

  <button id="search-area">Search this area</button>

  <div id="map"></div>
  <div id="status">Loading‚Ä¶</div>

  <script type="module">
    // ==========================================================
    // ‚úÖ MAP USER ‚Ä¢ WORLD
    // - Works with:
    //   - Google Places API (new) (searchNearby)
    //   - Firestore "businesses" isActive==true (SF Active)
    //   - TXT fallback (optional)
    // - Preview mode:
    //   - localStorage SF_PREVIEW=1 OR URL ?preview=1 => no auth required
    // ==========================================================

    // ====== CONFIG (no hardcode key) ======
    import { SF_GOOGLE_MAPS_KEY } from "./googlelogin/config.js";

    // Places Nearby defaults (can be overridden by UI)
    const MAX_RESULTS = 30;
    const AUTO_REFRESH_MS = 30 * 60 * 1000;

    // TXT fallback:
    // Option A: one file
    // const DATA_URL = "/QR_serveses/sliven_avtoservizi.txt";
    // Option B (world-ready): by city/country param:
    // /QR_serveses/world/<COUNTRY>/<CITY>.txt
    const TXT_WORLD_TEMPLATE = "/QR_serveses/world/{CC}/{CITY}.txt";

    // Fallback center (only if geo denied AND no saved location)
    const DEFAULT_CENTER = { lat: 42.6852, lng: 26.3293 }; // Sliven as safe default

    // ====== UI ======
    const panel = document.getElementById("panel-container");
    const sfActiveWrap = document.getElementById("sfActiveWrap");
    const resultsEl = document.getElementById("mainResults");
    const statusEl = document.getElementById("status");
    const countPill = document.getElementById("countPill");
    const panelTitle = document.getElementById("panelTitle");

    const btnRefresh = document.getElementById("btnRefresh");
    const btnNearMe = document.getElementById("btnNearMe");
    const btnUseTxt = document.getElementById("btnUseTxt");
    const btnSF = document.getElementById("btnSF");
    const searchAreaBtn = document.getElementById("search-area");

    const typeSelect = document.getElementById("typeSelect");
    const radiusSelect = document.getElementById("radiusSelect");
    const queryInput = document.getElementById("queryInput");

    const userStrip = document.getElementById("userStrip");
    const uImg = document.getElementById("uImg");
    const uName = document.getElementById("uName");
    const uMail = document.getElementById("uMail");
    const btnLogout = document.getElementById("btnLogout");

    document.getElementById("menu-button").addEventListener("click", () => {
      panel.style.display = (panel.style.display === "none") ? "block" : "none";
    });

    function setStatus(t){ statusEl.textContent = t; }

    // ====== utils ======
    function safeJson(s){ try{ return JSON.parse(s); }catch(_){ return null; } }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function normalizePhoneForTel(phone){
      const p = String(phone || "").trim();
      if(!p) return "";
      return p.replace(/[^0-9+]/g, "");
    }
    function approxKm(lat1,lng1,lat2,lng2){
      const kx = 111.32;
      const ky = 111.32 * Math.cos((lat1*Math.PI)/180);
      const dx = (lat2-lat1) * kx;
      const dy = (lng2-lng1) * ky;
      return Math.sqrt(dx*dx + dy*dy);
    }
    function isPreview(){
      const url = new URL(window.location.href);
      return url.searchParams.get("preview") === "1" || localStorage.getItem("SF_PREVIEW") === "1";
    }
    function getLang2(){
      const lang = (navigator.language || "en").toLowerCase();
      // Places expects languageCode like "en" "bg" "de" etc.
      return lang.split("-")[0] || "en";
    }
    function getRegion2(){
      // optional: use browser locale region if present (bg-BG => BG)
      // NOTE: For world mode we DO NOT force BG.
      const lang = (navigator.language || "").split("-");
      return (lang[1] && lang[1].length === 2) ? lang[1].toUpperCase() : null;
    }

    // ====== localStorage: location ======
    function getSavedLocation(){
      try { return JSON.parse(localStorage.getItem("sf_cs_location") || "null"); }
      catch(e){ return null; }
    }
    function saveLocalLocation(mode, lat, lng, accuracy, source){
      localStorage.setItem("sf_cs_location", JSON.stringify({
        mode, lat, lng,
        accuracy_m: accuracy ?? null,
        ts: new Date().toISOString(),
        source: source || "map"
      }));
    }

    // ====== Firebase (optional, auto) ======
    import { auth, db, firebaseEnabled } from "./googlelogin/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import {
      doc, getDoc, setDoc, serverTimestamp,
      collection, query, where, onSnapshot,
      orderBy, limit
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    async function upsertUserProfile(user){
      if(!firebaseEnabled || !db || !user) return;
      await setDoc(doc(db, "users", user.uid), {
        profile: {
          uid: user.uid,
          email: user.email || null,
          displayName: user.displayName || null,
          photoURL: user.photoURL || null,
          providerId: (user.providerData?.[0]?.providerId) || "google",
          lastLoginAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        },
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    function throttle(fn, waitMs){
      let last = 0;
      let timer = null;
      let lastArgs = null;
      return (...args) => {
        const now = Date.now();
        lastArgs = args;
        if(now - last >= waitMs){
          last = now;
          fn(...args);
        }else{
          clearTimeout(timer);
          timer = setTimeout(() => {
            last = Date.now();
            fn(...lastArgs);
          }, waitMs - (now - last));
        }
      };
    }

    const writeLastLocationThrottled = throttle(async (uid, loc) => {
      if(!firebaseEnabled || !db || !uid || !loc) return;
      try{
        await setDoc(doc(db, "users", uid), {
          lastLocation: loc,
          lastLocationAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });
      }catch(e){ console.warn(e); }
    }, 5000);

    async function readLastLocationFromFirestore(uid){
      if(!firebaseEnabled || !db || !uid) return null;
      try{
        const snap = await getDoc(doc(db, "users", uid));
        if(!snap.exists()) return null;
        const data = snap.data();
        const loc = data?.lastLocation || null;
        if(loc && typeof loc.lat === "number" && typeof loc.lng === "number") return loc;
        return null;
      }catch(e){
        console.warn(e);
        return null;
      }
    }

    function showUser(user){
      userStrip.style.display = "flex";
      uImg.src = user.photoURL || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect width='80' height='80' rx='18' fill='%23ffffff'/%3E%3Cpath d='M40 41c9 0 16-7 16-16S49 9 40 9 24 16 24 25s7 16 16 16zm0 6c-13 0-24 7-24 16v4h48v-4c0-9-11-16-24-16z' fill='%230b0b0d' fill-opacity='.55'/%3E%3C/svg%3E";
      uName.textContent = user.displayName || "User";
      uMail.textContent = user.email || "";
    }

    // ====== Map (Google JS) dynamic loader ======
    function loadGoogleMaps(key){
      return new Promise((resolve, reject) => {
        if(window.google?.maps) return resolve();
        if(!key || key.includes("PASTE_")) return reject(new Error("Missing Google Maps key. Set it in googlelogin/config.js"));

        window.__sfInitMap = () => resolve();

        const s = document.createElement("script");
        s.async = true; s.defer = true;
        s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places&callback=__sfInitMap`;
        s.onerror = () => reject(new Error("Failed to load Google Maps JS."));
        document.head.appendChild(s);
      });
    }

    // ====== MAP STATE ======
    let map, info, pinMarker;

    let placeMarkers = [];
    let txtMarkers = [];
    let markersByCode = new Map();

    // SF Active
    let activeMarkers = [];
    let activeById = new Map();
    let activeRows = [];
    let activeUnsub = null;

    let lastSearchedCenter = null;
    let lastMode = "places"; // "places" | "txt" | "sf"
    let currentUid = null;

    function clearPlaceMarkers(){ placeMarkers.forEach(m => m.setMap(null)); placeMarkers = []; }
    function clearTxtMarkers(){ txtMarkers.forEach(m => m.setMap(null)); txtMarkers = []; markersByCode.clear(); }
    function clearActiveMarkers(){ activeMarkers.forEach(m => m.setMap(null)); activeMarkers = []; activeById.clear(); }

    function fitMarkers(list){
      if(!list.length){
        map.setCenter(pinMarker ? pinMarker.getPosition() : DEFAULT_CENTER);
        map.setZoom(13);
        return;
      }
      const bounds = new google.maps.LatLngBounds();
      if(pinMarker) bounds.extend(pinMarker.getPosition());
      list.forEach(m => bounds.extend(m.getPosition()));
      map.fitBounds(bounds, 70);
    }

    function getCenterLatLng(){
      const c = pinMarker ? pinMarker.getPosition() : map.getCenter();
      return { lat: c.lat(), lng: c.lng() };
    }

    function currentRadiusMeters(){
      // Priority 1: UI select
      const r = Number(radiusSelect.value || 8000);
      if(Number.isFinite(r) && r > 200) return r;

      // Fallback: based on bounds
      const b = map.getBounds();
      if(!b) return 8000;
      const c = b.getCenter();
      const ne = b.getNorthEast();
      const km = approxKm(c.lat(), c.lng(), ne.lat(), ne.lng());
      const meters = Math.min(Math.max(km * 1000, 800), 30000);
      return meters;
    }

    function placeInfoHTML(p){
      const name = p.displayName?.text || "Service";
      const addr = p.formattedAddress || "";
      const phone = p.internationalPhoneNumber || "";
      const tel = normalizePhoneForTel(phone);
      const website = p.websiteUri || "";
      const maps = p.googleMapsUri || "";
      const openNow = (p.currentOpeningHours && typeof p.currentOpeningHours.openNow === "boolean")
        ? (p.currentOpeningHours.openNow ? "Open now" : "Closed")
        : "";

      return `
        <div style="font-family:Arial;max-width:280px">
          <div style="font-weight:900;font-size:14px;margin-bottom:6px">${escapeHtml(name)}</div>
          <div style="font-size:12px;color:rgba(17,24,39,.75);margin-bottom:8px">${escapeHtml(addr)}</div>
          ${openNow ? `<div style="font-size:12px;font-weight:900;margin-bottom:8px">${openNow}</div>` : ""}
          ${phone ? `<div style="font-size:12px;margin-bottom:6px">üìû ${escapeHtml(phone)}</div>` : ""}
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
            ${maps ? `<a href="${maps}" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;color:#0b62ff">Google</a>` : ""}
            ${tel ? `<a href="tel:${tel}" style="font-weight:900;text-decoration:none;color:#0b62ff">Call</a>` : ""}
            ${website ? `<a href="${website}" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;color:#0b62ff">Website</a>` : ""}
          </div>
        </div>
      `;
    }

    // ====== SF Active (Firestore) ‚Äî WORLD SAFE ======
    function activeInfoHTML(r){
      const mapsLink = r.googleMapsUri
        ? r.googleMapsUri
        : `https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lng}`;
      const dirLink  = `https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}`;
      const tel = normalizePhoneForTel(r.phone);

      return `
        <div style="font-family:Arial;max-width:290px">
          <div style="font-weight:900;font-size:14px;margin-bottom:6px">${escapeHtml(r.name)}</div>
          <div style="font-size:12px;color:rgba(17,24,39,.75);margin-bottom:8px">
            ${r.addr ? `<b>Address:</b> ${escapeHtml(r.addr)}<br/>` : ""}
            <b>GPS:</b> ${Number(r.lat).toFixed(6)}, ${Number(r.lng).toFixed(6)}<br/>
            ${r.phone ? `<b>Phone:</b> ${escapeHtml(r.phone)}<br/>` : ""}
            ${r.ownerEmail ? `<b>Activated by:</b> ${escapeHtml(r.ownerEmail)}<br/>` : ""}
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
            <a class="link" href="${mapsLink}" target="_blank" rel="noopener">Google</a>
            <a class="link" href="${dirLink}" target="_blank" rel="noopener">Directions</a>
            ${tel ? `<a class="link" href="tel:${tel}">Call</a>` : ""}
          </div>
        </div>
      `;
    }

    function renderActivePanel(rows, modeLabel){
      if(!rows.length){
        sfActiveWrap.style.display = "none";
        sfActiveWrap.innerHTML = "";
        return;
      }
      sfActiveWrap.style.display = "block";
      sfActiveWrap.innerHTML = "";

      const head = document.createElement("div");
      head.className = "sfHeader";
      head.innerHTML = `
        <div>SOULFLAME ‚Ä¢ Active now</div>
        <div class="sfTag">
          ${modeLabel ? `<span class="sfMini">${escapeHtml(modeLabel)}</span>` : ""}
          <span>${rows.length}</span>
        </div>
      `;
      sfActiveWrap.appendChild(head);

      rows.forEach((r) => {
        const tel = normalizePhoneForTel(r.phone);

        const el = document.createElement("div");
        el.className = "item sfActive";
        el.innerHTML = `
          <div class="badge sf">SF</div>
          <div class="meta">
            <div class="name" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
            <div class="addr">
              ${r.addr ? escapeHtml(r.addr) + " ‚Ä¢ " : ""}
              ${Number(r.lat).toFixed(6)}, ${Number(r.lng).toFixed(6)}
            </div>
            <div class="row2">
              <span class="sfMini">ONLINE ‚úÖ</span>
              ${r.ownerEmail ? `<span class="sfMini">${escapeHtml(r.ownerEmail)}</span>` : ""}
              ${tel ? `<a class="link" href="tel:${tel}" onclick="event.stopPropagation()">Call</a>` : ""}
              <a class="link" href="https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Directions</a>
            </div>
          </div>
        `;
        el.addEventListener("click", () => {
          const hit = activeById.get(r._id);
          if(!hit) return;
          map.panTo(hit.marker.getPosition());
          map.setZoom(16);
          google.maps.event.trigger(hit.marker, "click");
        });
        sfActiveWrap.appendChild(el);
      });
    }

    function renderActiveMarkers(rows){
      clearActiveMarkers();
      rows.forEach((r) => {
        const mk = new google.maps.Marker({
          position: { lat: Number(r.lat), lng: Number(r.lng) },
          map,
          title: r.name,
          label: { text: "SF" }
        });
        mk.addListener("click", () => {
          info.setContent(activeInfoHTML(r));
          info.open({ map, anchor: mk });
        });
        activeMarkers.push(mk);
        activeById.set(r._id, { row: r, marker: mk });
      });
    }

    function subscribeActiveServicesRealtime(){
      // Preview –∏–ª–∏ Firebase OFF ‚Üí –±–µ–∑ live subscribe
      if(isPreview() || !firebaseEnabled || !db){
        renderActivePanel([], "");
        clearActiveMarkers();
        return;
      }

      if(activeUnsub) { try{ activeUnsub(); }catch(e){} activeUnsub = null; }

      // ‚úÖ SAFE WORLD MODE:
      // 1) –≤–∑–∏–º–∞–º–µ isActive==true
      // 2) limit (–ø—Ä–∏–º–µ—Ä 200) –∑–∞ –¥–∞ –Ω–µ –¥—ä—Ä–ø–∞–º–µ ‚Äú—Ü–µ–ª–∏—è —Å–≤—è—Ç‚Äù
      // 3) —Ñ–∏–ª—Ç—Ä–∏—Ä–∞–º–µ –ø–æ –±–ª–∏–∑–æ—Å—Ç –¥–æ —Ü–µ–Ω—Ç—ä—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–∞—Ç–∞ (client-side)
      const qy = query(
        collection(db, "businesses"),
        where("isActive", "==", true),
        orderBy("updatedAt", "desc"),
        limit(200)
      );

      activeUnsub = onSnapshot(qy, (snap) => {
        const rows = [];
        snap.forEach((ds) => {
          const d = ds.data() || {};
          const lat = Number(d.lat ?? d.location?.lat ?? d.gps?.lat);
          const lng = Number(d.lng ?? d.location?.lng ?? d.gps?.lng);
          if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;

          const ts =
            (d.activatedAt?.toMillis ? d.activatedAt.toMillis() : 0) ||
            (d.updatedAt?.toMillis ? d.updatedAt.toMillis() : 0) || 0;

          rows.push({
            _id: ds.id,
            _ts: ts,
            code: d.code || "",
            name: d.name || "Service",
            addr: d.addr || "",
            lat, lng,
            phone: d.phone || "",
            googleMapsUri: d.googleMapsUri || "",
            ownerEmail: d.ownerEmail || d.activatedByEmail || ""
          });
        });

        // Filter by distance to center
        const center = getCenterLatLng();
        const rMeters = currentRadiusMeters();
        const rKm = rMeters / 1000;

        const nearby = rows
          .filter(r => approxKm(center.lat, center.lng, r.lat, r.lng) <= rKm)
          .sort((a,b) => (b._ts || 0) - (a._ts || 0))
          .slice(0, 40);

        activeRows = nearby;
        renderActivePanel(activeRows, "LIVE");
        renderActiveMarkers(activeRows);
      }, (err) => {
        console.warn(err);
        renderActivePanel([], "");
        clearActiveMarkers();
      });
    }

    // ====== TXT fallback (world-ready) ======
    async function fetchTxt(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error("TXT not found ("+res.status+").");
      return await res.text();
    }

    // format tolerant: CODE | Name | Address | lat | lng | optional...
    function parseTxt(txt){
      const lines = String(txt || "")
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(l => l && !l.startsWith("#"));

      const out = [];
      for(const line of lines){
        const parts = line.split("|").map(p => p.trim()).filter(Boolean);
        if(parts.length < 4) continue;

        const nums = parts.map(p => Number(String(p).replace(",", ".")));
        let latIdx = -1, lngIdx = -1;

        for(let i=0;i<parts.length;i++){
          const n = nums[i];
          if(Number.isFinite(n) && Math.abs(n) <= 90) {
            if(i+1 < parts.length){
              const n2 = nums[i+1];
              if(Number.isFinite(n2) && Math.abs(n2) <= 180){
                latIdx = i; lngIdx = i+1; break;
              }
            }
          }
        }
        if(latIdx === -1) continue;

        const code = parts[0];
        const name = parts[1] || "Service";
        const addr = (latIdx >= 3) ? parts[2] : "";
        const lat = Number(String(parts[latIdx]).replace(",", "."));
        const lng = Number(String(parts[lngIdx]).replace(",", "."));
        const source = parts.slice(lngIdx+1).join(" | ");

        if(!code || !Number.isFinite(lat) || !Number.isFinite(lng)) continue;
        out.push({ code, name, addr, lat, lng, source });
      }
      return out;
    }

    function markerHtmlTxt(row){
      const mapsLink = `https://www.google.com/maps/search/?api=1&query=${row.lat},${row.lng}`;
      return `
        <div style="font-family:Arial;max-width:280px">
          <div style="font-weight:900;font-size:14px;margin-bottom:6px">${escapeHtml(row.name)}</div>
          <div style="font-size:12px;color:rgba(17,24,39,.75);margin-bottom:8px">
            ${row.addr ? `<b>Address:</b> ${escapeHtml(row.addr)}<br/>` : ""}
            <b>GPS:</b> ${row.lat.toFixed(6)}, ${row.lng.toFixed(6)}
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
            <a href="${mapsLink}" target="_blank" rel="noopener"
              style="font-weight:900;text-decoration:none;color:#0b62ff">Google</a>
          </div>
          ${row.source ? `<div style="margin-top:8px;font-size:11px;opacity:.7">${escapeHtml(row.source)}</div>` : ""}
        </div>
      `;
    }

    function renderTxt(rows){
      panelTitle.textContent = "TXT fallback";
      resultsEl.innerHTML = "";
      countPill.textContent = String(rows.length);

      clearTxtMarkers();
      clearPlaceMarkers();

      rows.forEach((r) => {
        const mk = new google.maps.Marker({
          position: { lat: r.lat, lng: r.lng },
          map,
          title: r.name,
          label: {
            text: r.name,
            fontSize: "11px",
            fontWeight: "700",
            color: "#111",
            className: "marker-label"
          }
        });

        mk.addListener("click", () => {
          info.setContent(markerHtmlTxt(r));
          info.open({ map, anchor: mk });
        });

        txtMarkers.push(mk);
        markersByCode.set(r.code.toUpperCase(), { row: r, marker: mk });

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="badge">${escapeHtml(r.code)}</div>
          <div class="meta">
            <div class="name" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
            <div class="addr">
              ${r.addr ? escapeHtml(r.addr) + " ‚Ä¢ " : ""}
              ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}
            </div>
            <div class="row2">
              <span style="font-weight:900;opacity:.8">GPS</span>
              <a class="link" target="_blank" rel="noopener"
                href="https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lng}">Google</a>
            </div>
          </div>
        `;
        el.addEventListener("click", () => {
          map.panTo({ lat: r.lat, lng: r.lng });
          map.setZoom(15);
          google.maps.event.trigger(mk, "click");
        });

        resultsEl.appendChild(el);
      });

      fitMarkers(txtMarkers);
      setStatus(`TXT OK: ${rows.length}`);
      lastMode = "txt";
    }

    function computeTxtUrl(){
      // optional: /map_user.html?cc=BG&city=Sliven
      const u = new URL(window.location.href);
      const cc = (u.searchParams.get("cc") || getRegion2() || "BG").toUpperCase();
      const city = (u.searchParams.get("city") || localStorage.getItem("SF_CITY") || "Sliven").trim();
      const url = TXT_WORLD_TEMPLATE
        .replace("{CC}", encodeURIComponent(cc))
        .replace("{CITY}", encodeURIComponent(city));
      return url;
    }

    async function loadTxtAndRender(first){
      try{
        setStatus(first ? "Loading TXT‚Ä¶" : "Refreshing TXT‚Ä¶");
        const url = computeTxtUrl();
        const txt = await fetchTxt(url);
        const rows = parseTxt(txt);
        renderTxt(rows);
      }catch(err){
        console.error(err);
        setStatus("TXT error: " + (err?.message || err));
        countPill.textContent = "0";
        resultsEl.innerHTML = `<div style="padding:10px;color:#b91c1c;font-weight:900">
          TXT fallback not available for this city/country.
        </div>`;
      }
    }

    // ====== Google Places (Nearby Search) ======
    async function searchNearby(lat, lng){
      panelTitle.textContent = "Nearby services (Google)";
      setStatus("Searching nearby‚Ä¶");
      resultsEl.innerHTML = "";
      countPill.textContent = "‚Ä¶";

      clearPlaceMarkers();
      clearTxtMarkers();

      lastSearchedCenter = new google.maps.LatLng(lat, lng);

      const apiKey = SF_GOOGLE_MAPS_KEY;
      const radius = currentRadiusMeters();
      const type = typeSelect.value || "car_repair";
      const qtext = (queryInput.value || "").trim();

      const lang = getLang2();
      const region = getRegion2(); // optional

      try{
        const url = "https://places.googleapis.com/v1/places:searchNearby";

        const body = {
          includedTypes: [type],
          maxResultCount: MAX_RESULTS,
          rankPreference: "DISTANCE",
          languageCode: lang,
          // regionCode: region, // ‚úÖ for strict regional results you can enable it
          locationRestriction: {
            circle: {
              center: { latitude: lat, longitude: lng },
              radius
            }
          }
        };

        // Optional text filter (simple)
        // NOTE: searchNearby doesn't accept a "textQuery" param.
        // We'll do client-side filter by name/address if user typed something.
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Goog-Api-Key": apiKey,
            "X-Goog-FieldMask": [
              "places.id",
              "places.displayName",
              "places.formattedAddress",
              "places.location",
              "places.rating",
              "places.userRatingCount",
              "places.googleMapsUri",
              "places.websiteUri",
              "places.internationalPhoneNumber",
              "places.currentOpeningHours"
            ].join(",")
          },
          body: JSON.stringify(body)
        });

        if(!res.ok){
          const txt = await res.text();
          throw new Error("HTTP "+res.status+" ‚Äî "+txt.slice(0,600));
        }

        const data = await res.json();
        let places = data.places || [];

        if(qtext){
          const q = qtext.toLowerCase();
          places = places.filter(p => {
            const n = (p.displayName?.text || "").toLowerCase();
            const a = (p.formattedAddress || "").toLowerCase();
            return n.includes(q) || a.includes(q);
          });
        }

        countPill.textContent = String(places.length);
        setStatus(places.length ? `Found: ${places.length} ‚Ä¢ radius ${Math.round(radius/1000)}km` : "No results in this radius.");
        drawPlaces(places);
        lastMode = "places";

      }catch(err){
        console.error(err);
        const msg = String(err?.message || err);
        if(msg.includes("403") || msg.includes("PERMISSION_DENIED")){
          setStatus("403: Places API OFF / Billing OFF / Key restrictions.\nSwitching to TXT fallback‚Ä¶");
        }else{
          setStatus("Places error.\nSwitching to TXT fallback‚Ä¶");
        }
        lastMode = "txt";
        loadTxtAndRender(true);
      }
    }

    function drawPlaces(places){
      resultsEl.innerHTML = "";
      clearPlaceMarkers();

      const bounds = new google.maps.LatLngBounds();
      if(pinMarker) bounds.extend(pinMarker.getPosition());

      places.forEach((p, i) => {
        const name = p.displayName?.text || "Service";
        const addr = p.formattedAddress || "";
        const rating = (p.rating != null) ? p.rating.toFixed(1) : null;
        const count = p.userRatingCount || 0;

        const lat = p.location?.latitude;
        const lng = p.location?.longitude;
        if(lat == null || lng == null) return;

        const phone = p.internationalPhoneNumber || "";
        const tel = normalizePhoneForTel(phone);

        const mk = new google.maps.Marker({
          position: { lat, lng },
          map,
          title: name,
          label: { text: String(i+1) }
        });

        mk.addListener("click", () => {
          info.setContent(placeInfoHTML(p));
          info.open({ map, anchor: mk });
        });

        placeMarkers.push(mk);
        bounds.extend({ lat, lng });

        const mapsLink = p.googleMapsUri || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${encodeURIComponent(p.id||"")}`;
        const dirLink  = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}${p.id ? `&destination_place_id=${encodeURIComponent(p.id)}` : ""}`;

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="badge">${i+1}</div>
          <div class="meta">
            <div class="name" title="${escapeHtml(name)}">${escapeHtml(name)}</div>
            <div class="addr">${escapeHtml(addr)}</div>
            <div class="row2">
              ${rating ? `<span>‚≠ê ${rating} (${count})</span>` : `<span>No rating</span>`}
              <a class="link" href="${mapsLink}" target="_blank" rel="noopener">Google</a>
              <a class="link" href="${dirLink}" target="_blank" rel="noopener">Directions</a>
              ${tel ? `<a class="link" href="tel:${tel}" onclick="event.stopPropagation()">Call</a>` : ""}
            </div>
          </div>
        `;
        el.addEventListener("click", () => {
          map.panTo({ lat, lng });
          map.setZoom(15);
          google.maps.event.trigger(mk, "click");
        });

        resultsEl.appendChild(el);
      });

      if(!bounds.isEmpty()) map.fitBounds(bounds, 70);
    }

    // ====== MAP INIT ======
    function initMap(center){
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center,
        mapTypeControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
          position: google.maps.ControlPosition.TOP_RIGHT
        }
      });

      info = new google.maps.InfoWindow();

      map.addListener("click", (e) => {
        setPinAndSearch(e.latLng.lat(), e.latLng.lng(), true);
      });

      map.addListener("idle", () => {
        if(!lastSearchedCenter) return;
        const c = map.getCenter();
        const distKm = approxKm(lastSearchedCenter.lat(), lastSearchedCenter.lng(), c.lat(), c.lng());
        if(distKm > 0.25) searchAreaBtn.classList.add("show");
      });

      searchAreaBtn.addEventListener("click", () => {
        const c = map.getCenter();
        setPinAndSearch(c.lat(), c.lng(), true);
        searchAreaBtn.classList.remove("show");
      });

      btnRefresh.addEventListener("click", () => {
        const p = pinMarker ? pinMarker.getPosition() : map.getCenter();
        setPinAndSearch(p.lat(), p.lng(), true);
      });

      btnNearMe.addEventListener("click", () => locateAndSearch(true));

      btnUseTxt.addEventListener("click", () => {
        lastMode = "txt";
        loadTxtAndRender(true);
      });

      btnSF.addEventListener("click", () => {
        lastMode = "sf";
        setStatus("SF Active‚Ä¶");
        // refresh the active filter around current center
        subscribeActiveServicesRealtime();
        // keep google markers on map (optional) or clear them:
        // clearPlaceMarkers(); clearTxtMarkers();
      });

      // auto refresh TXT if in TXT mode
      setInterval(() => {
        if(lastMode === "txt") loadTxtAndRender(false);
      }, AUTO_REFRESH_MS);
    }

    // ====== START / BOOT ======
    async function bootstrapStart(){
      setStatus("Boot‚Ä¶");

      // 1) decide center
      const saved = getSavedLocation();
      const fallbackCenter = (saved?.lat && saved?.lng) ? { lat: saved.lat, lng: saved.lng } : DEFAULT_CENTER;

      // 2) Preview mode: no auth required
      if(isPreview()){
        userStrip.style.display = "none";
        setStatus("Preview mode ‚úÖ (no login required)");
        initMap(fallbackCenter);

        // show SF active disabled in preview
        renderActivePanel([], "");
        clearActiveMarkers();

        // try geo now
        locateAndSearch(true);
        return;
      }

      // 3) Live mode: auth required (your original flow)
      if(!firebaseEnabled || !auth){
        setStatus("‚ö†Ô∏è Firebase OFF. Map works, but no login/SF Active.");
        initMap(fallbackCenter);
        locateAndSearch(true);
        return;
      }

      onAuthStateChanged(auth, async (user) => {
        if(!user){
          setStatus("‚ùå Not logged in. Back to access screen‚Ä¶");
          window.location.href = "./access_location_user.html";
          return;
        }

        currentUid = user.uid;
        showUser(user);
        try{ await upsertUserProfile(user); }catch(e){ console.warn(e); }

        initMap(fallbackCenter);

        // SF Active subscribe (filtered near center)
        subscribeActiveServicesRealtime();

        // Location priority: localStorage -> firestore -> geolocation -> fallback
        const localLoc = getSavedLocation();
        if(localLoc && typeof localLoc.lat === "number" && typeof localLoc.lng === "number"){
          setStatus("Using saved location‚Ä¶");
          setPinAndSearch(localLoc.lat, localLoc.lng, true);
          return;
        }

        const fsLoc = await readLastLocationFromFirestore(user.uid);
        if(fsLoc && typeof fsLoc.lat === "number" && typeof fsLoc.lng === "number"){
          setStatus("Using Firestore location‚Ä¶");
          saveLocalLocation("user", fsLoc.lat, fsLoc.lng, fsLoc.accuracy_m ?? null, fsLoc.source || "firestore");
          setPinAndSearch(fsLoc.lat, fsLoc.lng, true);
          return;
        }

        locateAndSearch(true);
      });

      btnLogout.addEventListener("click", async () => {
        try{
          if(activeUnsub){ try{ activeUnsub(); }catch(e){} activeUnsub = null; }
          clearActiveMarkers();
          renderActivePanel([]);

          await signOut(auth);
          setStatus("Logout‚Ä¶");
          window.location.href = "./access_location_user.html";
        }catch(e){
          setStatus("‚ùå Logout error.");
        }
      });
    }

    function locateAndSearch(doSearch){
      if(!navigator.geolocation){
        setStatus("Geolocation not supported. Using fallback center.");
        setPinAndSearch(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng, doSearch);
        return;
      }
      setStatus("Requesting location‚Ä¶");
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          saveLocalLocation("user", lat, lng, pos.coords.accuracy, "geolocation");
          if(currentUid){
            writeLastLocationThrottled(currentUid, {
              mode: "user",
              lat, lng,
              accuracy_m: pos.coords.accuracy ?? null,
              ts: new Date().toISOString(),
              source: "geolocation"
            });
          }

          setPinAndSearch(lat, lng, doSearch);
        },
        () => {
          setStatus("Location denied. Using fallback center.");
          saveLocalLocation("user", DEFAULT_CENTER.lat, DEFAULT_CENTER.lng, null, "fallback");
          if(currentUid){
            writeLastLocationThrottled(currentUid, {
              mode: "user",
              lat: DEFAULT_CENTER.lat,
              lng: DEFAULT_CENTER.lng,
              accuracy_m: null,
              ts: new Date().toISOString(),
              source: "fallback"
            });
          }
          setPinAndSearch(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng, doSearch);
        },
        { enableHighAccuracy:true, timeout:12000, maximumAge:5000 }
      );
    }

    function setPinAndSearch(lat, lng, doSearch){
      const pos = { lat, lng };

      if(!pinMarker){
        pinMarker = new google.maps.Marker({
          position: pos,
          map,
          draggable: true,
          title: "Search from here"
        });
        pinMarker.addListener("dragend", () => {
          const p = pinMarker.getPosition();
          setPinAndSearch(p.lat(), p.lng(), true);
        });
      } else {
        pinMarker.setPosition(pos);
      }

      map.setCenter(pos);
      map.setZoom(14);

      saveLocalLocation("user", lat, lng, null, "pin");
      if(currentUid){
        writeLastLocationThrottled(currentUid, {
          mode: "user",
          lat, lng,
          accuracy_m: null,
          ts: new Date().toISOString(),
          source: "pin"
        });
      }

      // refresh SF active near this center too
      subscribeActiveServicesRealtime();

      if(doSearch){
        lastMode = "places";
        searchNearby(lat, lng);
      }
    }

    // ====== Boot ======
    (async function boot(){
      try{
        setStatus("Loading Google Maps‚Ä¶");
        await loadGoogleMaps(SF_GOOGLE_MAPS_KEY);
        setStatus("Maps loaded ‚úÖ");
        await bootstrapStart();
      }catch(e){
        console.error(e);
        setStatus("‚ùå " + (e?.message || e));
      }
    })();
  </script>
</body>
</html>
