<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta http-equiv="Permissions-Policy" content="geolocation=(self)">
  <title>SoulFlame CarService ‚Äî Map (User)</title>

  <style>
    html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
    #map { height:100%; width:100%; }

    #menu-button{
      position:absolute; top:15px; left:15px; z-index:1000;
      background:#111827; color:#fff; border:none;
      padding:10px 15px; font-size:20px; cursor:pointer; border-radius:10px;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
    }

    #panel-container{
      position:absolute; top:60px; left:15px; width:min(380px, 92vw);
      max-height:72vh; overflow:hidden;
      z-index:999; border-radius:14px;
      background: rgba(255,255,255,.94);
      backdrop-filter: blur(10px);
      border:1px solid rgba(17,24,39,.10);
      box-shadow:0 0 10px rgba(0,0,0,.2);
    }
    #panel-inner{ padding:12px; display:flex; flex-direction:column; gap:10px; }

    .panel-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .panel-title{ font-weight:900; letter-spacing:.4px; color:#111827; font-size:14px; }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(17,24,39,.12);
      background:#fff; color:#111827;
      font-weight:900;
    }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      border:none; cursor:pointer; border-radius:12px;
      padding:10px 12px; font-weight:900; font-size:12px; letter-spacing:.6px;
      background:#111827; color:#fff;
    }
    .btn.secondary{
      background:#fff; color:#111827;
      border:1px solid rgba(17,24,39,.14);
    }

    .results{
      overflow:auto;
      max-height: calc(72vh - 210px);
      padding-right:4px;
    }

    .item{
      border:1px solid rgba(17,24,39,.10);
      background:#fff; border-radius:14px; padding:10px; margin-bottom:10px;
      display:flex; gap:10px; align-items:flex-start;
      cursor:pointer;
    }

    .badge{
      min-width:44px; height:34px; border-radius:12px;
      background: rgba(17,24,39,.08);
      display:grid; place-items:center;
      font-weight:900;
      padding:0 8px;
      font-size:11px;
      color:#111827;
      overflow:hidden;
    }

    /* SoulFlame Active style */
    .sfHeader{
      display:flex; align-items:center; justify-content:space-between;
      margin:6px 0 10px;
      padding:8px 10px;
      border:1px solid rgba(17,24,39,.10);
      border-radius:14px;
      background: rgba(17,24,39,.04);
      font-weight:900;
      color:#111827;
      font-size:12px;
      letter-spacing:.4px;
    }
    .sfTag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(17,24,39,.12);
      background:#fff;
      font-weight:900;
      display:flex;
      gap:6px;
      align-items:center;
    }
    .item.sfActive{
      border-color: rgba(16,185,129,.22);
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
    }
    .badge.sf{
      background: rgba(16,185,129,.12);
      border:1px solid rgba(16,185,129,.18);
    }
    .sfMini{
      font-size:11px;
      font-weight:900;
      color: rgba(17,24,39,.72);
    }

    .meta{ flex:1; min-width:0; }
    .name{
      font-weight:900; font-size:13px; color:#111827;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .addr{ font-size:12px; color:rgba(17,24,39,.72); margin-top:3px; }
    .row2{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; font-size:12px; color:rgba(17,24,39,.75); }
    .link{ color:#0b62ff; text-decoration:none; font-weight:900; }

    #status{
      position:absolute; right:12px; top:12px; z-index:1000;
      background:rgba(17,24,39,.88); color:#fff;
      padding:8px 10px; border-radius:10px; font-size:12px;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
      max-width:min(520px, 92vw);
    }

    /* ‚Äú–¢—ä—Ä—Å–∏ –≤ —Ç–æ–∑–∏ —Ä–∞–π–æ–Ω‚Äù */
    #search-area{
      position:absolute; top:14px; left:50%; transform:translateX(-50%);
      z-index:1000;
      background:#fff;
      border:1px solid rgba(17,24,39,.14);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      display:none;
      box-shadow:0 10px 26px rgba(0,0,0,.14);
    }
    #search-area.show{ display:block; }

    /* User strip */
    .userStrip{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:10px;
      border:1px solid rgba(17,24,39,.10);
      border-radius:14px;
      background: rgba(255,255,255,.90);
    }
    .uImg{ width:32px; height:32px; border-radius:12px; object-fit:cover; border:1px solid rgba(17,24,39,.12); }
    .uMeta{ min-width:0; flex:1; }
    .uName{ font-weight:900; font-size:12.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#111827; }
    .uMail{ font-size:12px; opacity:.72; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#111827; }

    /* Location modal (gesture-safe) */
    #locModal{
      position:absolute; inset:0; z-index:2000;
      display:none;
      background: radial-gradient(1200px 700px at 20% 20%, rgba(255,255,255,.22), rgba(0,0,0,.62));
      backdrop-filter: blur(10px);
      align-items:center; justify-content:center;
      padding:18px;
    }
    #locModal.show{ display:flex; }
    .locCard{
      width:min(520px, 92vw);
      background: rgba(255,255,255,.96);
      border:1px solid rgba(17,24,39,.12);
      border-radius:18px;
      box-shadow:0 26px 80px rgba(0,0,0,.20);
      padding:16px;
    }
    .locTitle{ font-weight:900; font-size:15px; color:#111827; margin-bottom:6px; }
    .locText{ font-size:12.5px; color:rgba(17,24,39,.78); line-height:1.4; }
    .locActions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .hint{ margin-top:10px; font-size:12px; color:rgba(17,24,39,.70); }

    @media (max-width:520px){
      #panel-container{ width:min(380px, 92vw); }
    }
  </style>

  <!-- ‚úÖ initMap placeholder -->
  <script>
    window.__sf_map_callback_called = false;
    window.initMap = function () {
      window.__sf_map_callback_called = true;
      if (typeof window.__sf_startMap === "function") window.__sf_startMap();
    };
  </script>
</head>

<body>
  <button id="menu-button">‚ò∞</button>

  <div id="panel-container">
    <div id="panel-inner">
      <!-- USER INFO -->
      <div class="userStrip" id="userStrip" style="display:none">
        <img class="uImg" id="uImg" alt="User"/>
        <div class="uMeta">
          <div class="uName" id="uName">‚Äî</div>
          <div class="uMail" id="uMail">‚Äî</div>
        </div>
        <button class="btn secondary" id="btnLogout" type="button">–ò–∑—Ö–æ–¥</button>
      </div>

      <div class="panel-head">
        <div class="panel-title" id="panelTitle">–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑–∏ –æ–∫–æ–ª–æ —Ç–µ–± (Google)</div>
        <div class="pill" id="countPill">0</div>
      </div>

      <div class="controls">
        <button class="btn" id="btnRefresh">–û–±–Ω–æ–≤–∏</button>
        <button class="btn secondary" id="btnNearMe">–î–æ –º–µ–Ω</button>
        <button class="btn secondary" id="btnUseTxt">TXT (fallback)</button>
      </div>

      <div class="results" id="results">
        <div id="sfActiveWrap" style="display:none"></div>
        <div id="mainResults"></div>
      </div>
    </div>
  </div>

  <button id="search-area">–¢—ä—Ä—Å–µ–Ω–µ –≤ —Ç–æ–∑–∏ —Ä–∞–π–æ–Ω</button>

  <div id="map"></div>
  <div id="status">–ó–∞—Ä–µ–∂–¥–∞–º‚Ä¶</div>

  <!-- Location permission modal -->
  <div id="locModal">
    <div class="locCard">
      <div class="locTitle">–†–∞–∑—Ä–µ—à–∏ –ª–æ–∫–∞—Ü–∏—è</div>
      <div class="locText">
        –ó–∞ –¥–∞ —Ç–µ –æ—Ç–±–µ–ª–µ–∂–∞ <b>—Ç–æ—á–Ω–æ</b> –∏ –¥–∞ zoom-–Ω–∞ –∫—ä–º —Ç–≤–æ—è –≥—Ä–∞–¥, —Ç—Ä—è–±–≤–∞ –¥–æ—Å—Ç—ä–ø –¥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.
        –ù–∞—Ç–∏—Å–Ω–∏ –±—É—Ç–æ–Ω–∞ –¥–æ–ª—É.
      </div>
      <div class="locActions">
        <button class="btn" id="btnGrantLoc" type="button">–†–∞–∑—Ä–µ—à–∏ –ª–æ–∫–∞—Ü–∏—è</button>
        <button class="btn secondary" id="btnLocSkip" type="button">–ü—Ä–æ–ø—É—Å–Ω–∏ (–°–ª–∏–≤–µ–Ω)</button>
      </div>
      <div class="hint" id="locHint"></div>
    </div>
  </div>

  <script type="module">
    // ==========================================================
    // ‚úÖ PROFESSIONAL Map User ‚Äî Precise Geolocation + City Zoom
    // ‚úÖ Google Places Nearby (car_repair) + TXT fallback
    // ‚úÖ Firebase optional (no crash if missing)
    // ==========================================================

    // ====== CONFIG ======
    const API_KEY = "YOUR_GOOGLE_MAPS_API_KEY"; // ‚úÖ 1/2 —Å–º–µ–Ω—è—à —Ç—É–∫
    const RADIUS_METERS = 8000;
    const MAX_RESULTS = 30;

    // TXT fallback (Vercel case-sensitive)
    const DATA_URL = "/QR_serveses/sliven_avtoservizi.txt";
    const AUTO_REFRESH_MS = 30 * 60 * 1000;

    // Default center (fallback)
    const SLIVEN_CENTER = { lat: 42.6852, lng: 26.3293 };

    // ====== UI ======
    const panel = document.getElementById("panel-container");
    const sfActiveWrap = document.getElementById("sfActiveWrap");
    const resultsEl = document.getElementById("mainResults");
    const statusEl = document.getElementById("status");
    const countPill = document.getElementById("countPill");
    const panelTitle = document.getElementById("panelTitle");

    const btnRefresh = document.getElementById("btnRefresh");
    const btnNearMe = document.getElementById("btnNearMe");
    const btnUseTxt = document.getElementById("btnUseTxt");
    const searchAreaBtn = document.getElementById("search-area");

    const userStrip = document.getElementById("userStrip");
    const uImg = document.getElementById("uImg");
    const uName = document.getElementById("uName");
    const uMail = document.getElementById("uMail");
    const btnLogout = document.getElementById("btnLogout");

    const locModal = document.getElementById("locModal");
    const btnGrantLoc = document.getElementById("btnGrantLoc");
    const btnLocSkip = document.getElementById("btnLocSkip");
    const locHint = document.getElementById("locHint");

    document.getElementById("menu-button").addEventListener("click", () => {
      panel.style.display = (panel.style.display === "none") ? "block" : "none";
    });

    function setStatus(t){ statusEl.textContent = t; }
    function showLocModal(text=""){ locHint.textContent = text || ""; locModal.classList.add("show"); }
    function hideLocModal(){ locModal.classList.remove("show"); }

    // ====== storage ======
    function safeJson(s){ try{ return JSON.parse(s); }catch(_){ return null; } }
    function getSavedLocation(){
      return safeJson(localStorage.getItem("sf_cs_location") || "null");
    }
    function saveLocalLocation(mode, lat, lng, accuracy, source){
      localStorage.setItem("sf_cs_location", JSON.stringify({
        mode, lat, lng,
        accuracy_m: accuracy ?? null,
        ts: new Date().toISOString(),
        source: source || "map"
      }));
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function normalizePhoneForTel(phone){
      const p = String(phone || "").trim();
      if(!p) return "";
      return p.replace(/[^0-9+]/g, "");
    }

    // ====== Firebase optional (safe) ======
    let firebaseEnabled = false;
    let auth = null;
    let db = null;
    let onAuthStateChanged = null, signOut = null;
    let doc = null, getDoc = null, setDoc = null, serverTimestamp = null;
    let collection = null, query = null, where = null, onSnapshot = null;

    async function tryLoadFirebase(){
      try{
        // –ª–æ–∫–∞–ª–µ–Ω —Ñ–∞–π–ª (–∞–∫–æ –≥–æ –∏–º–∞—à)
        const local = await import("./googlelogin/firebase.js");
        firebaseEnabled = !!local.firebaseEnabled;
        auth = local.auth || null;
        db = local.db || null;

        // CDN —Ñ—É–Ω–∫—Ü–∏–∏ (–∞–∫–æ Firebase –µ –≤–∫–ª—é—á–µ–Ω)
        const authMod = await import("https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js");
        const fsMod = await import("https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js");

        onAuthStateChanged = authMod.onAuthStateChanged;
        signOut = authMod.signOut;

        doc = fsMod.doc; getDoc = fsMod.getDoc; setDoc = fsMod.setDoc; serverTimestamp = fsMod.serverTimestamp;
        collection = fsMod.collection; query = fsMod.query; where = fsMod.where; onSnapshot = fsMod.onSnapshot;

      }catch(e){
        firebaseEnabled = false;
        auth = null; db = null;
      }
    }

    async function upsertUserProfile(user){
      if(!firebaseEnabled || !db || !user) return;
      await setDoc(doc(db, "users", user.uid), {
        profile: {
          uid: user.uid,
          email: user.email || null,
          displayName: user.displayName || null,
          photoURL: user.photoURL || null,
          providerId: (user.providerData?.[0]?.providerId) || "google",
          lastLoginAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        },
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    function throttle(fn, waitMs){
      let last = 0;
      let timer = null;
      let lastArgs = null;
      return (...args) => {
        const now = Date.now();
        lastArgs = args;
        if(now - last >= waitMs){
          last = now; fn(...args);
        }else{
          clearTimeout(timer);
          timer = setTimeout(() => {
            last = Date.now(); fn(...lastArgs);
          }, waitMs - (now - last));
        }
      };
    }

    const writeLastLocationThrottled = throttle(async (uid, loc) => {
      if(!firebaseEnabled || !db || !uid || !loc) return;
      try{
        await setDoc(doc(db, "users", uid), {
          lastLocation: loc,
          lastLocationAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });
      }catch(_){}
    }, 5000);

    async function readLastLocationFromFirestore(uid){
      if(!firebaseEnabled || !db || !uid) return null;
      try{
        const snap = await getDoc(doc(db, "users", uid));
        if(!snap.exists()) return null;
        const data = snap.data();
        const loc = data?.lastLocation || null;
        if(loc && typeof loc.lat === "number" && typeof loc.lng === "number") return loc;
        return null;
      }catch(_){
        return null;
      }
    }

    function showUser(user){
      userStrip.style.display = "flex";
      uImg.src = user.photoURL || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect width='80' height='80' rx='18' fill='%23ffffff'/%3E%3Cpath d='M40 41c9 0 16-7 16-16S49 9 40 9 24 16 24 25s7 16 16 16zm0 6c-13 0-24 7-24 16v4h48v-4c0-9-11-16-24-16z' fill='%230b0b0d' fill-opacity='.55'/%3E%3C/svg%3E";
      uName.textContent = user.displayName || "User";
      uMail.textContent = user.email || "";
    }

    // ====== MAP ======
    let map, info, geocoder;
    let userMarker = null;
    let accuracyCircle = null;
    let pinMarker = null;

    let placeMarkers = [];
    let txtMarkers = [];
    let markersByCode = new Map();

    let activeMarkers = [];
    let activeById = new Map();
    let activeRows = [];
    let activeUnsub = null;

    let lastSearchedCenter = null;
    let lastMode = "places"; // "places" | "txt"
    let currentUid = null;

    function approxKm(lat1,lng1,lat2,lng2){
      const kx = 111.32;
      const ky = 111.32 * Math.cos((lat1*Math.PI)/180);
      const dx = (lat2-lat1) * kx;
      const dy = (lng2-lng1) * ky;
      return Math.sqrt(dx*dx + dy*dy);
    }

    function clearMarkers(list){
      list.forEach(m => m.setMap(null));
      list.length = 0;
    }
    function clearPlaceMarkers(){ clearMarkers(placeMarkers); }
    function clearTxtMarkers(){ clearMarkers(txtMarkers); markersByCode.clear(); }
    function clearActiveMarkers(){ clearMarkers(activeMarkers); activeById.clear(); }

    function fitMarkers(list){
      if(!list.length){
        const p = (userMarker ? userMarker.getPosition() : (pinMarker ? pinMarker.getPosition() : null));
        if(p){ map.setCenter(p); map.setZoom(13); }
        else { map.setCenter(SLIVEN_CENTER); map.setZoom(13); }
        return;
      }
      const bounds = new google.maps.LatLngBounds();
      if(userMarker) bounds.extend(userMarker.getPosition());
      if(pinMarker) bounds.extend(pinMarker.getPosition());
      list.forEach(m => bounds.extend(m.getPosition()));
      map.fitBounds(bounds, 70);
    }

    // ====== City name from geocoder ======
    async function resolveCityName(lat, lng){
      if(!geocoder) return "";
      return new Promise((resolve) => {
        geocoder.geocode({ location: { lat, lng } }, (results, status) => {
          if(status !== "OK" || !results || !results.length) return resolve("");
          const r = results[0];
          const comp = r.address_components || [];
          const city =
            comp.find(c => c.types.includes("locality"))?.long_name ||
            comp.find(c => c.types.includes("administrative_area_level_2"))?.long_name ||
            comp.find(c => c.types.includes("administrative_area_level_1"))?.long_name ||
            "";
          resolve(city);
        });
      });
    }

    // ====== User location marker (precise) ======
    function setUserLocationMarker(lat, lng, accuracy){
      const pos = { lat, lng };

      if(!userMarker){
        userMarker = new google.maps.Marker({
          position: pos,
          map,
          title: "–¢–∏ —Å–∏ —Ç—É–∫",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillOpacity: 1,
            fillColor: "#0b62ff",
            strokeColor: "#ffffff",
            strokeWeight: 3
          },
          zIndex: 9999
        });
      }else{
        userMarker.setPosition(pos);
      }

      // accuracy circle
      if(accuracy && Number.isFinite(accuracy)){
        if(!accuracyCircle){
          accuracyCircle = new google.maps.Circle({
            map,
            center: pos,
            radius: Math.max(accuracy, 10),
            fillColor: "#0b62ff",
            fillOpacity: 0.12,
            strokeColor: "#0b62ff",
            strokeOpacity: 0.25,
            strokeWeight: 1
          });
        }else{
          accuracyCircle.setCenter(pos);
          accuracyCircle.setRadius(Math.max(accuracy, 10));
        }
      }

      // zoom logic: –ø–æ-—Ç–æ—á–Ω–æ = –ø–æ-–±–ª–∏–∑–æ
      const z = (!accuracy ? 14 : (accuracy < 60 ? 17 : accuracy < 150 ? 16 : accuracy < 400 ? 15 : accuracy < 1200 ? 14 : 13));
      map.setCenter(pos);
      map.setZoom(z);
    }

    // ====== pin marker (search from here) ======
    function setPinAndSearch(lat, lng, doSearch){
      const pos = { lat, lng };

      if(!pinMarker){
        pinMarker = new google.maps.Marker({
          position: pos,
          map,
          draggable: true,
          title: "–¢—ä—Ä—Å–µ–Ω–µ –æ—Ç —Ç—É–∫"
        });
        pinMarker.addListener("dragend", () => {
          const p = pinMarker.getPosition();
          setPinAndSearch(p.lat(), p.lng(), true);
        });
      } else {
        pinMarker.setPosition(pos);
      }

      saveLocalLocation("user", lat, lng, null, "pin");

      if(currentUid){
        writeLastLocationThrottled(currentUid, {
          mode: "user", lat, lng,
          accuracy_m: null,
          ts: new Date().toISOString(),
          source: "pin"
        });
      }

      if(doSearch){
        lastMode = "places";
        searchAutoServices(lat, lng);
      }
    }

    // ====== Location request (ask permission + precise) ======
    let geoWatchId = null;

    async function requestPreciseLocation({doSearch=true} = {}){
      if(!navigator.geolocation){
        setStatus("–ë—Ä–∞—É–∑—ä—Ä—ä—Ç –Ω—è–º–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è. –ü–æ–ª–∑–≤–∞–º –°–ª–∏–≤–µ–Ω.");
        setUserLocationMarker(SLIVEN_CENTER.lat, SLIVEN_CENTER.lng, null);
        setPinAndSearch(SLIVEN_CENTER.lat, SLIVEN_CENTER.lng, doSearch);
        hideLocModal();
        return;
      }

      setStatus("–ò—Å–∫–∞–º –ª–æ–∫–∞—Ü–∏—è‚Ä¶");
      showLocModal("–ê–∫–æ –Ω–µ –∏–∑–ª–∏–∑–∞ –ø—Ä–æ–∑–æ—Ä–µ—Ü ‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äú–†–∞–∑—Ä–µ—à–∏ –ª–æ–∫–∞—Ü–∏—è‚Äù.");

      const onOk = async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = pos.coords.accuracy;

        saveLocalLocation("user", lat, lng, acc, "geolocation");

        setUserLocationMarker(lat, lng, acc);
        setPinAndSearch(lat, lng, doSearch);

        // city label
        const city = await resolveCityName(lat, lng);
        if(city){
          panelTitle.textContent = `–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑–∏ –æ–∫–æ–ª–æ —Ç–µ–± ‚Äî ${city}`;
          setStatus(`üìç ${city} ‚Ä¢ —Ç–æ—á–Ω–æ—Å—Ç ~${Math.round(acc)}m`);
        }else{
          setStatus(`üìç –õ–æ–∫–∞—Ü–∏—è OK ‚Ä¢ —Ç–æ—á–Ω–æ—Å—Ç ~${Math.round(acc)}m`);
        }

        if(currentUid){
          writeLastLocationThrottled(currentUid, {
            mode: "user",
            lat, lng,
            accuracy_m: acc ?? null,
            ts: new Date().toISOString(),
            source: "geolocation"
          });
        }

        hideLocModal();

        // watchPosition –∑–∞ —Ñ–∏–Ω–∞–ª–Ω–æ ‚Äú–∑–∞–∫–ª—é—á–≤–∞–Ω–µ‚Äù –Ω–∞ –ø–æ-—Ç–æ—á–Ω–∞ —Ç–æ—á–∫–∞
        if(geoWatchId == null){
          geoWatchId = navigator.geolocation.watchPosition(
            async (p2) => {
              const lat2 = p2.coords.latitude, lng2 = p2.coords.longitude, acc2 = p2.coords.accuracy;
              // —ä–ø–¥–µ–π—Ç —Å–∞–º–æ –∞–∫–æ –µ –ø–æ-—Ç–æ—á–Ω–æ
              const saved = getSavedLocation();
              const oldAcc = saved?.accuracy_m ?? 999999;
              if(acc2 && acc2 < oldAcc){
                saveLocalLocation("user", lat2, lng2, acc2, "watch");
                setUserLocationMarker(lat2, lng2, acc2);
                setPinAndSearch(lat2, lng2, doSearch);
                const city2 = await resolveCityName(lat2, lng2);
                if(city2){
                  panelTitle.textContent = `–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑–∏ –æ–∫–æ–ª–æ —Ç–µ–± ‚Äî ${city2}`;
                  setStatus(`üìç ${city2} ‚Ä¢ —Ç–æ—á–Ω–æ—Å—Ç ~${Math.round(acc2)}m`);
                }else{
                  setStatus(`üìç –¢–æ—á–Ω–æ—Å—Ç –ø–æ–¥–æ–±—Ä–µ–Ω–∞ ~${Math.round(acc2)}m`);
                }
                if(currentUid){
                  writeLastLocationThrottled(currentUid, {
                    mode: "user",
                    lat: lat2, lng: lng2,
                    accuracy_m: acc2 ?? null,
                    ts: new Date().toISOString(),
                    source: "watch"
                  });
                }
              }
            },
            () => {},
            { enableHighAccuracy:true, maximumAge:0, timeout:12000 }
          );

          // —Å–ø–∏—Ä–∞ watch —Å–ª–µ–¥ 25 —Å–µ–∫ (–¥–∞ –Ω–µ —Ö–∞–±–∏)
          setTimeout(() => {
            if(geoWatchId != null){
              try{ navigator.geolocation.clearWatch(geoWatchId); }catch(_){}
              geoWatchId = null;
            }
          }, 25000);
        }
      };

      const onErr = async (err) => {
        const code = err?.code;
        if(code === 1){
          // denied
          setStatus("‚ùå –õ–æ–∫–∞—Ü–∏—è—Ç–∞ –µ –æ—Ç–∫–∞–∑–∞–Ω–∞. –ü–æ–ª–∑–≤–∞–º fallback.");
          showLocModal("–†–∞–∑—Ä–µ—à–∏ Location –æ—Ç –±—Ä–∞—É–∑—ä—Ä–∞ (Site Settings) –∏ –æ–ø–∏—Ç–∞–π –ø–∞–∫.");
        }else{
          setStatus("‚ö†Ô∏è –ù–µ —É—Å–ø—è—Ö –¥–∞ –≤–∑–µ–º–∞ —Ç–æ—á–Ω–∞ –ª–æ–∫–∞—Ü–∏—è. –ü–æ–ª–∑–≤–∞–º fallback.");
        }

        const saved = getSavedLocation();
        if(saved?.lat && saved?.lng){
          setUserLocationMarker(saved.lat, saved.lng, saved.accuracy_m ?? null);
          setPinAndSearch(saved.lat, saved.lng, doSearch);
          hideLocModal();
          return;
        }

        setUserLocationMarker(SLIVEN_CENTER.lat, SLIVEN_CENTER.lng, null);
        setPinAndSearch(SLIVEN_CENTER.lat, SLIVEN_CENTER.lng, doSearch);
        hideLocModal();
      };

      navigator.geolocation.getCurrentPosition(
        onOk,
        onErr,
        { enableHighAccuracy:true, timeout:12000, maximumAge:5000 }
      );
    }

    // ====== Active services (Firestore LIVE) ======
    function activeInfoHTML(r){
      const mapsLink = r.googleMapsUri
        ? r.googleMapsUri
        : `https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lng}`;
      const dirLink  = `https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}`;
      const tel = normalizePhoneForTel(r.phone);

      return `
        <div style="font-family:Arial;max-width:290px">
          <div style="font-weight:900;font-size:14px;margin-bottom:6px">${escapeHtml(r.name)}</div>
          <div style="font-size:12px;color:rgba(17,24,39,.75);margin-bottom:8px">
            ${r.addr ? `<b>–ê–¥—Ä–µ—Å:</b> ${escapeHtml(r.addr)}<br/>` : ""}
            <b>GPS:</b> ${Number(r.lat).toFixed(6)}, ${Number(r.lng).toFixed(6)}<br/>
            ${r.phone ? `<b>–¢–µ–ª:</b> ${escapeHtml(r.phone)}<br/>` : ""}
            ${r.ownerEmail ? `<b>–ê–∫—Ç–∏–≤–∏—Ä–∞–ª:</b> ${escapeHtml(r.ownerEmail)}<br/>` : ""}
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
            <a class="link" href="${mapsLink}" target="_blank" rel="noopener">Google</a>
            <a class="link" href="${dirLink}" target="_blank" rel="noopener">–ù–∞–≤–∏–≥–∞—Ü–∏—è</a>
            ${tel ? `<a class="link" href="tel:${tel}">–û–±–∞–¥–∏ —Å–µ</a>` : ""}
          </div>
        </div>
      `;
    }

    function renderActivePanel(rows, modeLabel){
      if(!rows.length){
        sfActiveWrap.style.display = "none";
        sfActiveWrap.innerHTML = "";
        return;
      }

      sfActiveWrap.style.display = "block";
      sfActiveWrap.innerHTML = "";

      const head = document.createElement("div");
      head.className = "sfHeader";
      head.innerHTML = `
        <div>SOULFLAME ‚Ä¢ –ê–∫—Ç–∏–≤–Ω–∏ —Å–µ—Ä–≤–∏–∑–∏ —Å–µ–≥–∞</div>
        <div class="sfTag">
          ${modeLabel ? `<span class="sfMini">${escapeHtml(modeLabel)}</span>` : ""}
          <span>${rows.length}</span>
        </div>
      `;
      sfActiveWrap.appendChild(head);

      rows.forEach((r) => {
        const tel = normalizePhoneForTel(r.phone);

        const el = document.createElement("div");
        el.className = "item sfActive";
        el.innerHTML = `
          <div class="badge sf">SF</div>
          <div class="meta">
            <div class="name" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
            <div class="addr">
              ${r.addr ? escapeHtml(r.addr) + " ‚Ä¢ " : ""}
              ${Number(r.lat).toFixed(6)}, ${Number(r.lng).toFixed(6)}
            </div>
            <div class="row2">
              <span class="sfMini">ONLINE ‚úÖ</span>
              ${r.ownerEmail ? `<span class="sfMini">${escapeHtml(r.ownerEmail)}</span>` : ""}
              ${tel ? `<a class="link" href="tel:${tel}" onclick="event.stopPropagation()">–û–±–∞–¥–∏ —Å–µ</a>` : ""}
              <a class="link" href="https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}" target="_blank" rel="noopener" onclick="event.stopPropagation()">–ù–∞–≤–∏–≥–∞—Ü–∏—è</a>
            </div>
          </div>
        `;
        el.addEventListener("click", () => {
          const hit = activeById.get(r._id);
          if(!hit) return;
          map.panTo(hit.marker.getPosition());
          map.setZoom(16);
          google.maps.event.trigger(hit.marker, "click");
        });
        sfActiveWrap.appendChild(el);
      });
    }

    function renderActiveMarkers(rows){
      clearActiveMarkers();
      rows.forEach((r) => {
        const mk = new google.maps.Marker({
          position: { lat: Number(r.lat), lng: Number(r.lng) },
          map,
          title: r.name,
          label: { text: "SF" }
        });
        mk.addListener("click", () => {
          info.setContent(activeInfoHTML(r));
          info.open({ map, anchor: mk });
        });
        activeMarkers.push(mk);
        activeById.set(r._id, { row: r, marker: mk });
      });
    }

    function subscribeActiveServicesRealtime(){
      if(!firebaseEnabled || !db || !onSnapshot){
        renderActivePanel([], "");
        return;
      }

      if(activeUnsub){ try{ activeUnsub(); }catch(_){}
        activeUnsub = null;
      }

      const q = query(collection(db, "businesses"), where("isActive", "==", true));
      activeUnsub = onSnapshot(q, (snap) => {
        const rows = [];
        snap.forEach((ds) => {
          const d = ds.data() || {};
          const lat = Number(d.lat ?? d.location?.lat ?? d.gps?.lat);
          const lng = Number(d.lng ?? d.location?.lng ?? d.gps?.lng);
          if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;

          const ts =
            (d.activatedAt?.toMillis ? d.activatedAt.toMillis() : 0) ||
            (d.updatedAt?.toMillis ? d.updatedAt.toMillis() : 0) || 0;

          rows.push({
            _id: ds.id,
            _ts: ts,
            code: d.code || "",
            name: d.name || "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑",
            addr: d.addr || "",
            lat, lng,
            phone: d.phone || "",
            googleMapsUri: d.googleMapsUri || "",
            ownerEmail: d.ownerEmail || d.activatedByEmail || ""
          });
        });

        rows.sort((a,b) => (b._ts || 0) - (a._ts || 0));
        activeRows = rows;

        renderActivePanel(activeRows, rows.length ? "LIVE" : "");
        renderActiveMarkers(activeRows);

      }, () => {
        renderActivePanel([], "");
      });
    }

    // ====== PLACES API (Nearby car_repair via places.googleapis.com) ======
    async function searchAutoServices(lat, lng){
      panelTitle.textContent = panelTitle.textContent.includes("‚Äî")
        ? panelTitle.textContent
        : "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑–∏ –æ–∫–æ–ª–æ —Ç–µ–± (Google)";

      setStatus("–¢—ä—Ä—Å—è –∞–≤—Ç–æ—Å–µ—Ä–≤–∏–∑–∏‚Ä¶");
      resultsEl.innerHTML = "";
      countPill.textContent = "‚Ä¶";

      clearPlaceMarkers();
      clearTxtMarkers();

      lastSearchedCenter = new google.maps.LatLng(lat, lng);

      try{
        const url = "https://places.googleapis.com/v1/places:searchNearby";

        const body = {
          includedTypes: ["car_repair"],
          maxResultCount: MAX_RESULTS,
          rankPreference: "DISTANCE",
          languageCode: "bg",
          regionCode: "BG",
          locationRestriction: {
            circle: {
              center: { latitude: lat, longitude: lng },
              radius: RADIUS_METERS
            }
          }
        };

        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Goog-Api-Key": API_KEY,
            "X-Goog-FieldMask": [
              "places.id",
              "places.displayName",
              "places.formattedAddress",
              "places.location",
              "places.rating",
              "places.userRatingCount",
              "places.googleMapsUri",
              "places.websiteUri",
              "places.internationalPhoneNumber",
              "places.currentOpeningHours"
            ].join(",")
          },
          body: JSON.stringify(body)
        });

        if(!res.ok){
          const txt = await res.text();
          throw new Error("HTTP "+res.status+" ‚Äî "+txt.slice(0,600));
        }

        const data = await res.json();
        const places = data.places || [];

        countPill.textContent = String(places.length);
        setStatus(places.length ? `–ù–∞–º–µ—Ä–µ–Ω–∏: ${places.length}` : "–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Å–µ—Ä–≤–∏–∑–∏ –Ω–∞–±–ª–∏–∑–æ.");
        drawPlaces(places);

        lastMode = "places";

      }catch(err){
        countPill.textContent = "0";
        const msg = String(err && err.message ? err.message : err);
        if(msg.includes("403") || msg.includes("PERMISSION_DENIED")){
          setStatus("403: Places API OFF / Billing OFF / key restrictions. –ü—É—Å–∫–∞–º TXT fallback‚Ä¶");
        }else{
          setStatus("–ì—Ä–µ—à–∫–∞ Places API. –ü—É—Å–∫–∞–º TXT fallback‚Ä¶");
        }
        lastMode = "txt";
        loadTxtAndRender(true);
      }
    }

    function placeInfoHTML(p){
      const name = p.displayName?.text || "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑";
      const addr = p.formattedAddress || "";
      const phone = p.internationalPhoneNumber || "";
      const tel = normalizePhoneForTel(phone);
      const website = p.websiteUri || "";
      const maps = p.googleMapsUri || "";
      const openNow = (p.currentOpeningHours && typeof p.currentOpeningHours.openNow === "boolean")
        ? (p.currentOpeningHours.openNow ? "–û—Ç–≤–æ—Ä–µ–Ω–æ" : "–ó–∞—Ç–≤–æ—Ä–µ–Ω–æ")
        : "";

      return `
        <div style="font-family:Arial;max-width:280px">
          <div style="font-weight:900;font-size:14px;margin-bottom:6px">${escapeHtml(name)}</div>
          <div style="font-size:12px;color:rgba(17,24,39,.75);margin-bottom:8px">${escapeHtml(addr)}</div>
          ${openNow ? `<div style="font-size:12px;font-weight:900;margin-bottom:8px">${openNow}</div>` : ""}
          ${phone ? `<div style="font-size:12px;margin-bottom:6px">üìû ${escapeHtml(phone)}</div>` : ""}
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
            ${maps ? `<a href="${maps}" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;color:#0b62ff">–û—Ç–≤–æ—Ä–∏ –≤ Google</a>` : ""}
            ${tel ? `<a href="tel:${tel}" style="font-weight:900;text-decoration:none;color:#0b62ff">–û–±–∞–¥–∏ —Å–µ</a>` : ""}
            ${website ? `<a href="${website}" target="_blank" rel="noopener" style="font-weight:900;text-decoration:none;color:#0b62ff">–°–∞–π—Ç</a>` : ""}
          </div>
        </div>
      `;
    }

    function drawPlaces(places){
      resultsEl.innerHTML = "";
      clearPlaceMarkers();

      const bounds = new google.maps.LatLngBounds();
      if(userMarker) bounds.extend(userMarker.getPosition());
      if(pinMarker) bounds.extend(pinMarker.getPosition());

      places.forEach((p, i) => {
        const name = p.displayName?.text || "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑";
        const addr = p.formattedAddress || "";
        const rating = (p.rating != null) ? p.rating.toFixed(1) : null;
        const count = p.userRatingCount || 0;

        const lat = p.location?.latitude;
        const lng = p.location?.longitude;
        if(lat == null || lng == null) return;

        const phone = p.internationalPhoneNumber || "";
        const tel = normalizePhoneForTel(phone);

        const mk = new google.maps.Marker({
          position: { lat, lng },
          map,
          title: name,
          label: { text: String(i+1) }
        });

        mk.addListener("click", () => {
          info.setContent(placeInfoHTML(p));
          info.open({ map, anchor: mk });
        });

        placeMarkers.push(mk);
        bounds.extend({ lat, lng });

        const mapsLink = p.googleMapsUri || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${encodeURIComponent(p.id||"")}`;
        const dirLink  = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}${p.id ? `&destination_place_id=${encodeURIComponent(p.id)}` : ""}`;

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="badge">${i+1}</div>
          <div class="meta">
            <div class="name" title="${escapeHtml(name)}">${escapeHtml(name)}</div>
            <div class="addr">${escapeHtml(addr)}</div>
            <div class="row2">
              ${rating ? `<span>‚≠ê ${rating} (${count})</span>` : `<span>–ë–µ–∑ —Ä–µ–π—Ç–∏–Ω–≥</span>`}
              <a class="link" href="${mapsLink}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Google</a>
              <a class="link" href="${dirLink}" target="_blank" rel="noopener" onclick="event.stopPropagation()">–ù–∞–≤–∏–≥–∞—Ü–∏—è</a>
              ${tel ? `<a class="link" href="tel:${tel}" onclick="event.stopPropagation()">–û–±–∞–¥–∏ —Å–µ</a>` : ""}
            </div>
          </div>
        `;
        el.addEventListener("click", () => {
          map.panTo({ lat, lng });
          map.setZoom(15);
          google.maps.event.trigger(mk, "click");
        });

        resultsEl.appendChild(el);
      });

      if(!bounds.isEmpty()) map.fitBounds(bounds, 70);
    }

    // ====== TXT fallback ======
    async function fetchTxt(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`–ù–µ –º–æ–≥–∞ –¥–∞ –∑–∞—Ä–µ–¥—è TXT (${res.status}). –ü—Ä–æ–≤–µ—Ä–∏ –ø—ä—Ç—è.`);
      return await res.text();
    }

    function parseTxt(txt){
      const lines = String(txt || "")
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(l => l && !l.startsWith("#"));

      const out = [];
      for(const line of lines){
        const parts = line.split("|").map(p => p.trim()).filter(Boolean);
        if(parts.length < 4) continue;

        const nums = parts.map(p => Number(String(p).replace(",", ".")));
        let latIdx = -1, lngIdx = -1;

        for(let i=0;i<parts.length;i++){
          const n = nums[i];
          if(Number.isFinite(n) && Math.abs(n) <= 90) {
            if(i+1 < parts.length){
              const n2 = nums[i+1];
              if(Number.isFinite(n2) && Math.abs(n2) <= 180){
                latIdx = i; lngIdx = i+1; break;
              }
            }
          }
        }
        if(latIdx === -1) continue;

        const code = parts[0];
        const name = parts[1] || "–ê–≤—Ç–æ—Å–µ—Ä–≤–∏–∑";
        const addr = (latIdx >= 3) ? parts[2] : "";
        const lat = Number(String(parts[latIdx]).replace(",", "."));
        const lng = Number(String(parts[lngIdx]).replace(",", "."));
        const source = parts.slice(lngIdx+1).join(" | ");

        if(!code || !Number.isFinite(lat) || !Number.isFinite(lng)) continue;
        out.push({ code, name, addr, lat, lng, source, raw: line });
      }
      return out;
    }

    function markerHtmlTxt(row){
      const mapsLink = `https://www.google.com/maps/search/?api=1&query=${row.lat},${row.lng}`;
      return `
        <div style="font-family:Arial;max-width:280px">
          <div style="font-weight:900;font-size:14px;margin-bottom:6px">${escapeHtml(row.name)}</div>
          <div style="font-size:12px;color:rgba(17,24,39,.75);margin-bottom:8px">
            ${row.addr ? `<b>–ê–¥—Ä–µ—Å:</b> ${escapeHtml(row.addr)}<br/>` : ""}
            <b>GPS:</b> ${row.lat.toFixed(6)}, ${row.lng.toFixed(6)}
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
            <a href="${mapsLink}" target="_blank" rel="noopener"
              style="font-weight:900;text-decoration:none;color:#0b62ff">–û—Ç–≤–æ—Ä–∏ –≤ Google</a>
          </div>
          ${row.source ? `<div style="margin-top:8px;font-size:11px;opacity:.7">${escapeHtml(row.source)}</div>` : ""}
        </div>
      `;
    }

    function renderTxt(rows){
      panelTitle.textContent = "–°–µ—Ä–≤–∏–∑–∏ –æ—Ç TXT (fallback)";
      resultsEl.innerHTML = "";
      countPill.textContent = String(rows.length);

      clearTxtMarkers();
      clearPlaceMarkers();

      rows.forEach((r) => {
        const mk = new google.maps.Marker({
          position: { lat: r.lat, lng: r.lng },
          map,
          title: r.name,
          label: { text: r.code }
        });

        mk.addListener("click", () => {
          info.setContent(markerHtmlTxt(r));
          info.open({ map, anchor: mk });
        });

        txtMarkers.push(mk);
        markersByCode.set(r.code.toUpperCase(), { row: r, marker: mk });

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="badge">${escapeHtml(r.code)}</div>
          <div class="meta">
            <div class="name" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
            <div class="addr">
              ${r.addr ? escapeHtml(r.addr) + " ‚Ä¢ " : ""}
              ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}
            </div>
            <div class="row2">
              <span style="font-weight:900;opacity:.8">GPS</span>
              <a class="link" target="_blank" rel="noopener"
                href="https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lng}" onclick="event.stopPropagation()">Google</a>
            </div>
          </div>
        `;
        el.addEventListener("click", () => {
          map.panTo({ lat: r.lat, lng: r.lng });
          map.setZoom(15);
          google.maps.event.trigger(mk, "click");
        });

        resultsEl.appendChild(el);
      });

      fitMarkers(txtMarkers);
      setStatus(`TXT OK: ${rows.length} —Å–µ—Ä–≤–∏–∑–∞. –°–ª–µ–¥–≤–∞—â refresh: ${Math.round(AUTO_REFRESH_MS/60000)} –º–∏–Ω.`);
      lastMode = "txt";
    }

    async function loadTxtAndRender(first){
      try{
        setStatus(first ? "–ó–∞—Ä–µ–∂–¥–∞–º TXT‚Ä¶" : "–û–±–Ω–æ–≤—è–≤–∞–º –æ—Ç TXT‚Ä¶");
        const txt = await fetchTxt(DATA_URL);
        const rows = parseTxt(txt);
        renderTxt(rows);
      }catch(err){
        setStatus("–ì—Ä–µ—à–∫–∞ TXT: " + (err?.message || err));
        countPill.textContent = "0";
        resultsEl.innerHTML = `
          <div style="padding:10px;color:#b91c1c;font-weight:900">
            –ù–µ –º–æ–≥–∞ –¥–∞ –∑–∞—Ä–µ–¥—è TXT. –ü—Ä–æ–≤–µ—Ä–∏: public/QR_serveses/sliven_avtoservizi.txt
          </div>
        `;
      }
    }

    // ====== Start Map ======
    window.__sf_startMap = async function(){
      if(window.__sf_started) return;
      window.__sf_started = true;

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: SLIVEN_CENTER,
        mapTypeControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
          position: google.maps.ControlPosition.TOP_RIGHT
        }
      });

      info = new google.maps.InfoWindow();
      geocoder = new google.maps.Geocoder();

      // UI events
      map.addListener("click", (e) => {
        setPinAndSearch(e.latLng.lat(), e.latLng.lng(), true);
      });

      map.addListener("idle", () => {
        if(!lastSearchedCenter) return;
        const c = map.getCenter();
        const distKm = approxKm(lastSearchedCenter.lat(), lastSearchedCenter.lng(), c.lat(), c.lng());
        if(distKm > 0.25) searchAreaBtn.classList.add("show");
      });

      searchAreaBtn.addEventListener("click", () => {
        const c = map.getCenter();
        setPinAndSearch(c.lat(), c.lng(), true);
        searchAreaBtn.classList.remove("show");
      });

      btnRefresh.addEventListener("click", () => {
        const p = pinMarker ? pinMarker.getPosition()
          : (userMarker ? userMarker.getPosition() : map.getCenter());
        setPinAndSearch(p.lat(), p.lng(), true);
      });

      btnNearMe.addEventListener("click", () => requestPreciseLocation({ doSearch:true }));
      btnUseTxt.addEventListener("click", () => { lastMode="txt"; loadTxtAndRender(true); });

      // Auto refresh TXT –∞–∫–æ —Å–º–µ –≤ TXT —Ä–µ–∂–∏–º
      setInterval(() => { if(lastMode === "txt") loadTxtAndRender(false); }, AUTO_REFRESH_MS);

      // Location modal buttons (gesture-safe)
      btnGrantLoc.addEventListener("click", () => requestPreciseLocation({ doSearch:true }));
      btnLocSkip.addEventListener("click", () => {
        hideLocModal();
        setUserLocationMarker(SLIVEN_CENTER.lat, SLIVEN_CENTER.lng, null);
        setPinAndSearch(SLIVEN_CENTER.lat, SLIVEN_CENTER.lng, true);
      });

      // load firebase (optional)
      await tryLoadFirebase();

      // auth flow (if enabled)
      if(firebaseEnabled && auth && onAuthStateChanged){
        setStatus("–ü—Ä–æ–≤–µ—Ä—è–≤–∞–º –≤—Ö–æ–¥‚Ä¶");
        onAuthStateChanged(auth, async (user) => {
          if(!user){
            setStatus("‚ùå –ù—è–º–∞ login. –í—Ä—ä—â–∞–º –∫—ä–º access_location_user.html‚Ä¶");
            window.location.href = "./access_location_user.html";
            return;
          }

          currentUid = user.uid;
          showUser(user);
          try{ await upsertUserProfile(user); }catch(_){}

          subscribeActiveServicesRealtime();

          // if we have local loc use it immediately (fast), then request precise
          const localLoc = getSavedLocation();
          if(localLoc?.lat && localLoc?.lng){
            setUserLocationMarker(localLoc.lat, localLoc.lng, localLoc.accuracy_m ?? null);
            setPinAndSearch(localLoc.lat, localLoc.lng, true);
          }else{
            const fsLoc = await readLastLocationFromFirestore(user.uid);
            if(fsLoc?.lat && fsLoc?.lng){
              saveLocalLocation("user", fsLoc.lat, fsLoc.lng, fsLoc.accuracy_m ?? null, "firestore");
              setUserLocationMarker(fsLoc.lat, fsLoc.lng, fsLoc.accuracy_m ?? null);
              setPinAndSearch(fsLoc.lat, fsLoc.lng, true);
            }
          }

          // always ask for fresh precise location
          requestPreciseLocation({ doSearch:true });

          btnLogout.addEventListener("click", async () => {
            try{
              if(activeUnsub){ try{ activeUnsub(); }catch(_){}
                activeUnsub = null;
              }
              clearActiveMarkers();
              renderActivePanel([]);
              await signOut(auth);
              setStatus("–ò–∑—Ö–æ–¥‚Ä¶");
              window.location.href = "./access_location_user.html";
            }catch(_){
              setStatus("‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ö–æ–¥.");
            }
          });
        });

      }else{
        // no firebase: run standalone
        subscribeActiveServicesRealtime();

        const saved = getSavedLocation();
        if(saved?.lat && saved?.lng){
          setUserLocationMarker(saved.lat, saved.lng, saved.accuracy_m ?? null);
          setPinAndSearch(saved.lat, saved.lng, true);
        }

        // ask location always
        requestPreciseLocation({ doSearch:true });
      }
    };

    // if callback fired early
    if(window.__sf_map_callback_called && typeof window.__sf_startMap === "function"){
      window.__sf_startMap();
    }
  </script>

  <!-- ‚úÖ Google Maps JS (callback –∫—ä–º window.initMap) -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap">
  </script>
</body>
</html>
